# Identifying Conditional Causal Effects in MPDAGs

Sara LaPlante (slap47@uw.edu) Emilija Perkovi´c (perkovic@uw.edu) Department of Statistics University of Washington, Seattle, WA 98195, USA

#### Abstract

We consider identifying a conditional causal effect when a graph is known up to a maximally oriented partially directed acyclic graph (MPDAG). An MPDAG represents an equivalence class of graphs that is restricted by background knowledge and where all variables in the causal model are observed. We provide three results that address identification in this setting: an identification formula when the conditioning set is unaffected by treatment, a generalization of the well-known do calculus to the MPDAG setting, and an algorithm that is complete for identifying these conditional effects.

# 1 Introduction

In finding causal effects, researchers may want to know the effect across an entire population, sometimes called a total or unconditional causal effect. For example, does free access to prekindergarten (pre-K) improve children's socio-emotional skills throughout elementary school (Moffett et al., 2023)? However, researchers may want to know the effect within subgroups of the population, or a conditional causal effect. For instance, is there a subgroup of children who particularly benefit from free access to pre-K? Our research considers identifying these conditional effects from observational data.

We assume knowledge of a causal graph. Though, in general, observational data alone are insufficient for learning a full directed acyclic graph (DAG), even when all variables in the model are observed. Thus, we consider a setting where the causal graph is known only up to an equivalence class of DAGs that can be learned from observational data (Spirtes et al., 2000; Chickering, 2002). We allow the addition of expert knowledge as a way to restrict this class further. This restricted class of DAGs can be uniquely represented by a maximally oriented partially directed acyclic graph (MPDAG, Meek, 1995), which is the focus of our work. For illustration, see Figure 1.

Much of the literature focuses on identification in the unconditional setting, and many researchers consider identification through covariate adjustment. By definition, adjustment sets identify the unconditional effect of X on Y, since for any such set S, it holds that f(y | do(x)) = R f(y | x, s)f(s) ds, where f is any density consistent with the model. Prior research provides methods of finding these sets by checking graphical relationships in a known graph—for example, a DAG (Pearl, 1995; Shpitser et al., 2010), an MPDAG (Perkovi´c et al., 2017), or a partial ancestral graph (PAG) that allows for latent variables

![](_page_1_Figure_0.jpeg)

Figure 1: Illustrating an MPDAG. Let the DAG in (a) represent an unknown causal model. We cannot learn this DAG from observational data alone, but we can learn the CPDAG in (b), which represents the equivalence class of DAGs shown in (c). Adding background knowledge that X and Z precede Y produces the MPDAG in (d), which represents the restricted class of DAGs shown in (e).

(Van der Zander et al., 2014; Maathuis and Colombo, 2015; Perkovi´c et al., 2018). As an alternative to covariate adjustment, prior work also provides exact formulas for identifying unconditional effects when a DAG, MPDAG, or PAG is known (Perkovi´c, 2020; Jaber et al., 2018).

Other research focuses on identifying conditional effects, but in settings where graphs other than an MPDAG is known. For example, the well-known do calculus of Pearl (2009) offers a tool for transforming interventional densities into observational densities based on d-separations in a known DAG. Zhang (2008) extends this work by creating an analogous calculus for PAGs, and Jaber et al. (2022) update the extension to make it complete. Based on this calculus, Jaber et al. (2022) develop a sound and complete algorithm for conditional effect identification given a PAG.

To the best of our knowledge, the only work that considers the identification of conditional effects when an MPDAG is known is that of LaPlante and Perkovi´c (2024). These authors offer a graphical criterion for finding conditional adjustment sets, where for any such set S, it holds that f(y | do(x), z) = R f(y | x, z, s)f(s | z) ds. But the authors note two limitations. First, there are identifiable effects where conditional adjustment sets do not exist (see Example 2 in Section 3.4 below). Further, there are conditional adjustment sets that LaPlante and Perkovi´c (2024)'s graphical criterion cannot find, since they require that the conditioning set must be unaffected by treatment (see Examples 7-8 Section 5.2 below).

Our results address this gap in the literature by providing three methods of identifying conditional causal effects in a setting where a causal MPDAG is known. We begin with an identification formula (Theorem 3), which provides an exact form of the interventional density in terms of observational densities. This result applies when the conditioning set is unaffected by treatment, which holds for the common case of pre-treatment covariates. Our second result (Theorem 6) generalizes the well-known do calculus of Pearl (2009) to the MPDAG setting. That is, we provide a set of rules based on d-separations in a causal graph with undirected edges that allow transformations of an interventional density under conditioning. We use this calculus in our final result: an identification algorithm (Algorithm 1) that we show is complete for identifying conditional causal effects.

We organize this paper in the following way. Section 2 provides relevant preliminaries on graphs and related densities. Section 3 presents our conditional identification formula. Then Sections 4 and 5 provide our do calculus for MPDAGs and conditional identification algorithm, respectively. We discuss the benefits, limitations, and possible usage of our results in Section 6.

# 2 Preliminaries

Nodes, Edges, and Graphs. We use capital letters (e.g., X) to denote nodes in a graph as well as random variables that these nodes represent. We use bold capital letters (e.g., X) to denote node sets. A graph G = (V, E) consists of a set of nodes V and a set of edges E. A directed graph contains only directed edges (→). A partially directed graph may contain undirected edges (−) and directed edges (→). An induced subgraph GV′ = (V′ , E′ ) of G consists of V′ ⊆ V and E′ ⊆ E where E′ are all edges in E between nodes in V′ . In a partially directed graph, an edge is into (out of ) a node X if the edge is directed and has an arrowhead (tail) at X.

Paths and Cycles. For disjoint node sets X and Y, a path from X to Y is a sequence of distinct nodes ⟨X, . . . , Y ⟩ from some X ∈ X to some Y ∈ Y for which every pair of successive nodes is adjacent. An undirected path is a path containing only undirected edges (−). A directed path from X to Y is a path of the form X → · · · → Y . A directed path from X to Y and the edge Y → X form a directed cycle. A path from X to Y is proper (w.r.t. X) if only its first node is in X. In a graph G, the path p := ⟨V0, . . . , Vk⟩, k ≥ 1, is possibly directed if no edge V<sup>i</sup> ← V<sup>j</sup> , 0 ≤ i < j ≤ k, is in G (Perkovi´c et al., 2017).

Subsequences, Subpaths, and Shields. A subsequence of a path p in a graph G is a path obtained by deleting a set of non-endpoint nodes from p without changing the order of the remaining nodes. For a path p = ⟨X1, . . . , Xm⟩, the subpath from X<sup>i</sup> to Xk, for 1 ≤ i < k ≤ m, is the path p(X<sup>i</sup> , Xk) = ⟨X<sup>i</sup> , Xi+1, . . . , Xk⟩. We use the notation (−p)(Xk, Xi) to denote the path ⟨Xk, Xk−1, . . . , Xi⟩. The subpath ⟨Xj−1, X<sup>j</sup> , Xj+1⟩, for 1 < j < k, is an unshielded triple if Xj−<sup>1</sup> and Xj+1 are not adjacent in G. A path is unshielded if all successive triples on the path are unshielded.

Colliders, Non-colliders, and Definite Status Paths. The endpoints of a path p = ⟨X1, . . . , Xk⟩ in a graph G are the nodes X<sup>1</sup> and Xk. The node X<sup>i</sup> , 1 < i < k, is a collider on p if p contains Xi−<sup>1</sup> → X<sup>i</sup> ← Xi+1. The node X<sup>i</sup> is a definite non-collider on p if p contains Xi−<sup>1</sup> ← X<sup>i</sup> or X<sup>i</sup> → Xi+1, or if ⟨Xi−1, X<sup>i</sup> , Xi+1⟩ is undirected and unshielded. A node is of definite status on p if it is an endpoint, collider, or definite non-collider on p. The path p is of definite status if every node on p is of definite status.

Ancestral Relationships. If a graph G contains the edge X → Y , then X is a parent of Y in G. If G contains X − Y or X → Y , then X is a possible parent of Y in G. If G contains a directed path from X to Y , then X is an ancestor of Y and Y

is a descendant of X in G. If G contains a possibly directed path from X to Y , then X is a possible ancestor of Y and Y is a possible descendant of X in G. We use the convention that every node is an ancestor, descendant, possible ancestor, and possible descendant of itself. The sets of parents, ancestors, and descendants and the sets of possible parents, ancestors, and descendants of X in G are denoted by Pa(X, G), An(X, G), De(X, G), PossPa(X, G), PossAn(X, G), and PossDe(X, G), respectively. For a set of nodes X, we let An(X, G) = ∪X∈<sup>X</sup> An(X, G), with analogous definitions for De(X, G), PossAn(X, G), and PossDe(X, G). Unconventionally, we define Pa(X, G) = (∪X∈<sup>X</sup> Pa(X, G)) \ X.

DAGs and MPDAGs. A directed graph without directed cycles is a directed acyclic graph (DAG). A partially directed graph without directed cycles is a partially directed acyclic graph (PDAG). All DAGs over a node set V with the same adjacencies and unshielded colliders can be uniquely represented by a completed PDAG (CPDAG). These DAGs form a Markov equivalence class with the same set of d-separations. A maximally oriented PDAG (MPDAG) is formed by taking a CPDAG, adding background knowledge (by directing undirected edges), and completing Meek (1995)'s orientation rules. We say a DAG is represented by an MPDAG G if it has the same nodes, adjacencies, and directed edges as G and if it has no additional unshielded colliders from those in G. The set of such DAGs—denoted by [G]—forms a restriction of the Markov equivalence class so that all DAGs in [G] have same set of d-separations. Note that if G has the edge A − B, then [G] contains at least one DAG with A → B and one DAG with A ← B (Meek, 1995). Further, note that all DAGs and CPDAGs are MPDAGs.

Markov Compatibility and Positivity Assumption. An observational density f(v) is Markov compatible with a DAG D = (V, E) if f(v) = Q <sup>V</sup>i∈<sup>V</sup> f(v<sup>i</sup> | pa(v<sup>i</sup> , D)). If f(v) is Markov compatible with a DAG D, then it is Markov compatible with every DAG that is Markov equivalent to D (Pearl, 2009). Hence, we say that a density is Markov compatible with an MPDAG G if it is Markov compatible with a DAG represented by G. Throughout, we assume positivity. That is, we only consider densities that satisfy f(v) > 0 for all valid values of V (Kivva et al., 2023). Note that since, f(v) = Q <sup>V</sup>i∈<sup>V</sup> f(v<sup>i</sup> | pa(v<sup>i</sup> , D)), assuming f(v) > 0 is equivalent to assuming f(v<sup>i</sup> | pa(v<sup>i</sup> , G)) > 0 for all V<sup>i</sup> ∈ V.

D-connection, D-separation, and Probabilistic Implications. Let X, Y, and Z be pairwise disjoint node sets in a graph G. A definite status path p from X to Y is dconnecting (or open) given Z if every definite non-collider on p is not in Z and every collider on p has a descendant in Z. Otherwise, p is blocked given Z. If all definite status paths between X and Y in G are blocked given Z, then X is d-separated from Y given Z in G and we write (X ⊥<sup>d</sup> Y|Z)G. This d-separation implies that X and Y are conditionally independent given Z in any observational density that is Markov compatible with G (Lauritzen et al., 1990; Henckel et al., 2022).

Causal Graphs. An MPDAG G is a causal MPDAG if every edge V<sup>i</sup> → V<sup>j</sup> in G represents a direct causal effect of V<sup>i</sup> on V<sup>j</sup> and if every edge V<sup>i</sup> − V<sup>j</sup> represents a direct causal effect of unknown direction (either V<sup>i</sup> causes V<sup>j</sup> or V<sup>j</sup> causes Vi). In a causal MPDAG, any directed path is causal, any possibly directed path is possibly causal, and any other path is non-causal.

Causal Ordering. Let X = {X1, . . . , Xk}, k ≥ 1, be a node set in a causal DAG D. We say that X<sup>1</sup> < · · · < X<sup>k</sup> is a total causal ordering of X consistent with D if for every X<sup>i</sup> , X<sup>j</sup> ∈ X such that X<sup>i</sup> < X<sup>j</sup> and such that X<sup>i</sup> and X<sup>j</sup> are adjacent in D, then D contains X<sup>i</sup> → X<sup>j</sup> . There can be more than one total causal ordering of a set of nodes in a DAG. For example, in the DAG X<sup>b</sup> ← X<sup>a</sup> → Xc, both X<sup>a</sup> < X<sup>b</sup> < X<sup>c</sup> and X<sup>a</sup> < X<sup>c</sup> < X<sup>b</sup> are total causal orderings consistent with the DAG.

Now let X be a node set in a causal MPDAG G. Since G may contain undirected edges, there is generally no total causal ordering of X consistent with G. Instead, we define a partial causal ordering of X consistent with G to be an ordering of pairwise disjoint node sets A1, . . . , Ak, k ≥ 1, ∪ k <sup>i</sup>=1A<sup>i</sup> = X, that satisfies the following: for every i, j ∈ {1, . . . , k} such that A<sup>i</sup> < A<sup>j</sup> and there is an edge between A<sup>i</sup> ∈ A<sup>i</sup> and A<sup>j</sup> ∈ A<sup>j</sup> in G, then G contains A<sup>i</sup> → A<sup>j</sup> .

Consistency. Let f(v) be an observational density over a set of variables V. The notation do(X = x), or do(x) for short, represents an outside intervention that sets X ⊆ V to fixed values x. An interventional density f(v|do(x)) is a density resulting from such an intervention.

Let F <sup>∗</sup> denote the set of all interventional densities f(v|do(x)) such that X ⊆ V (including X = ∅). A causal DAG D = (V, E) is a causal Bayesian network compatible with F ∗ if and only if for all f(v|do(x)) ∈ F ∗ , the following truncated factorization holds:

$$
f(\mathbf{v}|do(\mathbf{x})) = \prod_{V_i \in \mathbf{V} \setminus \mathbf{X}} f(v_i | pa(v_i, \mathcal{D})) \mathbb{1}(\mathbf{X} = \mathbf{x})
$$
(1)

(Pearl, 2009; Bareinboim et al., 2012). We say an interventional density is consistent with a causal DAG D if it belongs to a set of interventional densities F ∗ such that D is compatible with F ∗ . Note that any observational density that is Markov compatible with D is consistent with D. We say an interventional density is consistent with a causal MPDAG G if it is consistent with each DAG in [G]—were the DAG to be causal. Following convention, we omit 1(X = x) from identifying expressions of interventional densities below.

Identifiability. Let X, Y, and Z be pairwise disjoint node sets in a causal MPDAG G = (V, E), and let F ∗ <sup>i</sup> = {fi(v|do(x ′ )) : X′ ⊆ V} be a set with which a DAG D<sup>i</sup> ∈ [G] is compatible—were D<sup>i</sup> to be causal. Then the conditional causal effect of X on Y given Z is identifiable in G if for any F ∗ 1 , F ∗ 2 such that f1(v) = f2(v), we have f1(y|do(x), z) = f2(y|do(x), z) (Pearl, 2009).

# 3 Identification Formula

In this section, we provide our first result: a formula for identifying a conditional causal effect when a causal MPDAG is known and when the conditioning set is unaffected by treatment. This formula relies on concepts found in prior research on MPDAGs, which we review briefly below. After presenting our formula, we explore its use through special cases and examples. We close this section by providing a necessary and sufficient condition for identifying conditional effects in this setting.

#### 3.1 Review of the PCO Algorithm

The identification formula we present in Section 3.2 relies on output from the Partial Causal Ordering (PCO) Algorithm of Perkovi´c (2020). We provide the full algorithm in Appendix B, but offer a brief description here for broad understanding of our results. The PCO Algorithm inputs a set of nodes from an MPDAG and outputs an ordered partition of that node set, which we call an ordered bucket decomposition. That is, if D is a node set in an MPDAG G, then PCO(D, G) = (B1, . . . , Bk), k ≥ 1, where B1, . . . , B<sup>k</sup> are pairwise disjoint subsets of D that follow a partial causal ordering consistent with G (see Section 2). For clarity, we formally define buckets and their ordered decompositions below.

Definition 1 (Bucket; Perkovi´c, 2020) Let B and D be node sets in an MPDAG G such that B ⊆ D. Then B is a bucket in D given G if it is the intersection of D with a maximal undirected connected set in G. That is,

- G contains a undirected path from B<sup>i</sup> to B<sup>j</sup> for every B<sup>i</sup> , B<sup>j</sup> ∈ B, and
- G contains no undirected path from B to any node in D \ B.

Definition 2 (Ordered Bucket Decomposition) Let D be a node set in an MPDAG G. Then (B1, . . . , Bk), k ≥ 1, is an ordered bucket decomposition of D in G if

- B<sup>i</sup> is a bucket in D given G for all i ∈ {1, . . . , k}.
- B<sup>1</sup> < · · · < B<sup>k</sup> is a partial causal ordering of D consistent with G so that
  - ∪ k <sup>i</sup>=1B<sup>i</sup> = D, and
  - any edge in G between B<sup>i</sup> ∈ B<sup>i</sup> and B<sup>j</sup> ∈ B<sup>j</sup> for i, j ∈ {1, . . . , k}, i < j, must take the form B<sup>i</sup> → B<sup>j</sup> .

### 3.2 Identification Formula

We turn to our identification formula, where we consider the conditional causal effect of a set of treatments X on outcomes Y given covariates Z that are unaffected by treatment.

Theorem 3 (Conditional Identification Formula) Let X, Y, and Z be pairwise disjoint node sets in a causal MPDAG G = (V, E), where Z ∩ PossDe(X, G) = ∅ and where there is no proper possibly causal path from X to Y in G that starts with an undirected edge. Then for any density f consistent with G,

$$
f(\mathbf{y} | do(\mathbf{x}), \mathbf{z}) = \int \prod_{i \in \mathbf{I}_{\mathbf{E}}} f(\mathbf{b}_i | pa(\mathbf{b}_i, \mathcal{G})) \prod_{i \in \mathbf{I}_{\mathbf{N}}} f(\mathbf{b}_i | \mathbf{b}_i^{\mathbf{N}}, \mathbf{z}) \, d\mathbf{b},
$$
(2)

for B = An(Y, GV\X) \ (Z ∪ Y); (B1, . . . , Bk) = PCO(An(Y, GV\X) \ Z, G); B<sup>0</sup> = ∅; and B<sup>N</sup> <sup>i</sup> = ∪ i−1 <sup>j</sup>=0B<sup>j</sup> \ PossDe(X, G). For i ∈ {1, . . . , k}, let i ∈ I<sup>E</sup> when Z ∩ PossDe(B<sup>i</sup> , G) = ∅ and let i ∈ I<sup>N</sup> otherwise.

Proof of Theorem 3. The first two equalities below follow by the law of total probability and the chain rule, respectively. The third equality follows from our Lemma 38 (App. D), which we discuss following this proof.

$$
f(\mathbf{y} | \, do(\mathbf{x}), \mathbf{z}) = \int f(\mathbf{b}, \mathbf{y} | \, do(\mathbf{x}), \mathbf{z}) \, \mathrm{d}\mathbf{b}
$$

$$
= \int \prod_{i=1}^{k} f(\mathbf{b}_{i} | \mathbf{b}_{i-1}, \dots, \mathbf{b}_{0}, do(\mathbf{x}), \mathbf{z}) \, d\mathbf{b}
$$
$$
= \int \prod_{i \in \mathbf{I}_{\mathbf{E}}} f(\mathbf{b}_{i} | \mathbf{pa}(\mathbf{b}_{i}, \mathcal{G})) \prod_{i \in \mathbf{I}_{\mathbf{N}}} f(\mathbf{b}_{i} | \mathbf{b}_{i}^{\mathbf{N}}, \mathbf{z}) \, d\mathbf{b}.
$$

Proof Sketch. Lemma 38 and its proof can be found in Appendix D, but we provide an overview here for intuition. This lemma requires the same assumptions as Theorem 3—that Z ∩ PossDe(X, G) = ∅ and no proper possibly causal path from X to Y starts undirected. Under these assumptions, the lemma claims

$$
f(\mathbf{b_i} | \mathbf{b_{i-1}}, \dots, \mathbf{b_0}, do(\mathbf{x}), \mathbf{z}) = \begin{cases} f(\mathbf{b_i} | \text{pa}(\mathbf{b_i}, \mathcal{G})) & \mathbf{Z} \cap \text{PossDe}(\mathbf{B_i}, \mathcal{G}) = \emptyset \\ f(\mathbf{b_i} | \mathbf{b_i^N}, \mathbf{z}) & \mathbf{Z} \cap \text{PossDe}(\mathbf{B_i}, \mathcal{G}) \neq \emptyset. \end{cases}
$$
(3)

The proof of this lemma relies on applying Rules 1-3 of Pearl's (2009) do calculus (Theorem 10, App. B) to an arbitrary DAG D ∈ [G]. To show the top equality of (3) holds, we use Rules 1 and 3 to restrict the conditioning set—including variables in the do intervention—to variables also in Pa(B<sup>i</sup> , G). Applying Rule 2 leaves a conditioning set of ∪ i−1 <sup>j</sup>=0 Bj∪Z∪X ∩Pa(B<sup>i</sup> , G), which is simply Pa(B<sup>i</sup> , G). To show that the d-separations for these three rules hold, we assume, for sake of contradiction, that under a specific conditioning set, there is an open path in D between B<sup>i</sup> and variables in ∪ i−1 <sup>j</sup>=1 Bj∪Z \Pa(B<sup>i</sup> , G) and X. Informally, we rely on the fact that G cannot contain a possibly causal path from B<sup>i</sup> to these variables. We use similar logic to show the lower equality of (3) holds, by applying Rules 1 and 3 to reduce the conditioning set to B<sup>N</sup> <sup>i</sup> ∪ Z.

We want to highlight that Appendix C includes broad results for MPDAGs used in the proofs of Lemma 38. To keep the focus of our paper on our three identification methods, we do not include these results in the main text. However, we recommend them to researchers in this area, since the results may be useful for future work on MPDAGs. As a brief review, Appendix C includes an alternate definition for possibly causal paths, a claim about concatenating casual and possibly causal paths, examples when possibly causal paths in the MPDAG imply causal paths in the equivalence class of DAGs, and restrictions on possibly causal paths among buckets in the MPDAG.

#### 3.3 Special Cases

Before providing examples, we return to the statement of Theorem 3 to consider two settings where Equation (2) can be replaced with a simplified form. For the first setting, we compare our results to those of Perkovi´c (2020). Under similar assumptions, the author provides the following identification formula for the unconditional causal effect of X on Y:

$$
f(\mathbf{y} \mid \text{do}(\mathbf{x})) = \int \prod_{i=1}^{k} f(\mathbf{b_i} \mid \text{pa}(\mathbf{b_i}, \mathcal{G})) \, \text{d}\mathbf{b}.
$$
 (4)

To compare Equations (2) and (4), we note that Theorem 3 holds for any conditioning set Z, including when Z = ∅. In this case, Z ∩ PossDe(B<sup>i</sup> , G) = ∅ for all i ∈ {1, . . . , k}, and

![](_page_7_Figure_0.jpeg)

Figure 2: MPDAGs used in Examples 1-3

thus, Equation (2) reduces to the exact form of the unconditional identification formula shown in Equation (4).

For the second setting, suppose, as in Theorem 3, that Z ∩ PossDe(X, G) = ∅. But instead of excluding a subset of possibly causal paths from X to Y, consider a stronger assumption that Y ∩ PossDe(X, G) = ∅. In this setting, identification of the conditional effect reduces to an application of Rule 3 of the do calculus (Theorem 10, App. B). We show this formally below.

Theorem 4 Let X, Y, and Z be pairwise disjoint node sets in a causal MPDAG G, where Z ∩ PossDe(X, G) = ∅ and Y ∩ PossDe(X, G) = ∅. Then for any f consistent with G,

$$
f(\mathbf{y} \mid \text{do}(\mathbf{x}), \mathbf{z}) = f(\mathbf{y} \mid \mathbf{z}).\tag{5}
$$

Proof of Theorem 4. Let D be an arbitrary DAG in [G]. The result holds by Rule 3 of the do calculus (Theorem 10, App. B) if we show (Y ⊥<sup>d</sup> X | Z)D<sup>W</sup> for W := X \ An(Z, D). Note that De(X, D) ⊆ PossDe(X, G) (Lemma 28, App. C) so that Z ∩ PossDe(X, G) = ∅ implies Z ∩ De(X, D) = ∅. Thus, W = X and we must show (Y ⊥<sup>d</sup> X | Z)D<sup>X</sup> .

Let p be an arbitrary path in D<sup>X</sup> from X ∈ X to Y ∈ Y. By definition of DX, p begins X →. But p cannot be causal, since this would imply Y ∈ De(X, D) ⊆ PossDe(X, G), which is a contradiction. Thus, p must have a collider. Form a set S with the collider on p that is closest to X on p and all of its descendants in DX. Since S ⊆ De(X, DX) ⊆ De(X, D) ⊆ PossDe(X, G) and since Z ∩ PossDe(X, G) = ∅, then p must be d-separated given Z.

#### 3.4 Examples

The examples below demonstrate how to use Theorems 3 and 4 to identify a conditional causal effect. As noted in Section 1, LaPlante and Perkovi´c (2024) already provide an identification method in the MPDAG setting using what the authors call conditional adjustment sets. But as they point out, these sets are not present in every MPDAG. Our identification formula fills in this gap when the conditioning set is unaffected by treatment. To highlight our contribution, Example 1 below considers a setting where a conditional adjustment set exists. We contrast this with Example 2, where there is no such set. Example 3 shows a straightforward application of Theorem 4.

Example 1 (Conditional Adjustment) Let G be the causal MPDAG in Figure 2(a), and let X = {X}, Y = {Y }, and Z = {V1}. To use Theorem 3, we confirm Z ∩ PossDe(X, G) = ∅ and no possibly causal path from X to Y starts undirected. Then we find B<sup>1</sup> = {V2} (where 1 ∈ IN), B<sup>2</sup> = {Y } (where 2 ∈ IE), and B = {V2}. Thus for f consistent with G,

$$
f(\mathbf{y} | do(\mathbf{x}), \mathbf{z}) = \int f(\mathbf{b_2} | \mathbf{pa}(\mathbf{b_2}, \mathcal{G})) f(\mathbf{b_1} | \mathbf{b_1^N}, \mathbf{z}) d\mathbf{b}
$$
  
= 
$$
\int f(y | x, v_1, v_2) f(v_2 | v_1) dv_2.
$$

Compare this to Example 2 of LaPlante and Perkovi´c (2024), where the authors find the identical form of f(y|do(x), z) by showing that S := {V2} is a conditional adjustment set.

Example 2 (No Conditional Adjustment) Let G be the causal DAG (and therefore, MPDAG) in Figure 2(b), and let X = {X1, X2}, Y = {Y }, and Z = {V2}. To use Theorem 3, we confirm Z ∩ PossDe(X, G) = ∅ and no possibly causal path from X to Y starts undirected. Then we find B<sup>1</sup> = {V1}, B<sup>2</sup> = {Y } (where 1, 2 ∈ IE), and B = {V1}. Thus for f consistent with G,

$$
f(\mathbf{y} | do(\mathbf{x}), \mathbf{z}) = \int f(\mathbf{b_1} | \mathbf{pa}(\mathbf{b_1}, \mathcal{G})) f(\mathbf{b_2} | \mathbf{pa}(\mathbf{b_2}, \mathcal{G})) d\mathbf{b}
$$
  
=  $\int f(v_1 | x_1) f(y | x_2, v_1, v_2) dv_1.$ 

Note that LaPlante and Perkovi´c (2024) show there is no conditional adjustment set in this case (see their Figure 4).

Example 3 (Using Theorem 4) Let G be the causal MPDAG in Figure 2(c), and let X = {X}, Y = {Y }, and Z = {Z}. To use Theorem 4, we confirm Y ∩ PossDe(X, G) = ∅ and Z ∩ PossDe(X, G) = ∅. Thus for f consistent with G,

$$
f(\mathbf{y} \mid \text{do}(\mathbf{x}), \mathbf{z}) = f(y \mid z).
$$

#### 3.5 Identifiability Condition

We close the discussion of our identification formula (Theorem 3) by reflecting further on its second condition—the restriction on paths between X and Y. The result below shows that this condition is necessary and sufficient for identification when the conditioning set is unaffected by treatment.

Proposition 5 (Identifiability Condition, Restricted Z) Let X, Y, and Z be pairwise disjoint node sets in a causal MPDAG G such that Z ∩ PossDe(X, G) = ∅. Then the conditional causal effect of X on Y given Z is identifiable in G if and only if there is no proper possibly causal path from X to Y in G that starts with an undirected edge.

Proof Sketch. The proof of Proposition 5 can be found in Appendix E, but we provide an outline here for intuition. Note that ⇐ follows from Theorem 3. We show ⇒ through its contraposition. Thus, suppose there is a proper possibly causal path from X to Y in G that starts undirected. We show in a separate result (Lemma 42, App. E) that this path implies there are DAGs D<sup>1</sup> , D<sup>2</sup> ∈ [G] with corresponding paths X → · · · → Y and X ← V<sup>1</sup> → · · · → Y . To show the conditional effect is not identifiable, we find {f1(v|do(x ′ )) : X′ ⊆ V} and {f2(v|do(x ′ )) : X′ ⊆ V} that are compatible with D<sup>1</sup> and D<sup>2</sup> , where f1(v) = f2(v) but f1(y|do(x), z) ̸= f2(y|do(x), z). We construct these sets using structural equation models (SEMs) based on DAGs with the same nodes as D<sup>i</sup> but with only the edges from the path of interest. To complete the proof, we show E1[Y |do(X = 1), Z] ̸= E2[Y |do(X = 1), Z] using the relevant DAGs, the do calculus (Theorem 10, App. B), and Wright's Rule (Lemma 12).

# 4 Do Calculus for MPDAGs

The do calculus of Pearl (2009, see Theorem 10, App. B) consists of three rules that justify transformations of an interventional density. These rules are based on d-separations in associated DAGs, and dictate, for example, when an interventional density is equivalent to an observational one. Thus, we often rely on these rules for causal identification.

But Pearl's do calculus was designed for densities consistent with a known DAG, and researchers rarely have knowledge of every edge orientation in a causal graph. For this reason, Zhang (2008) created a do calculus for the setting where the causal graph is known only up to a maximal or partial ancestral graph (MAG or PAG). Other extensions include Correa and Bareinboim's (2020) σ-calculus for inference under non-static interventions. Following this branch of research, we offer Theorem 6: a do calculus for MPDAGs.

#### 4.1 The Calculus

Just as Pearl's do calculus relies on manipulations of a known DAG (e.g., DX), our do calculus relies on manipulations of a known MPDAG (e.g., GX). But our graphs differ from Pearl's in notable ways. In order to build intuition for our do calculus, we first pause to describe these graphs and their differences.

As a review, Pearl's do calculus requires that interventional densities must be consistent with a DAG D, and that d-separations must hold in specific manipulations of D. For example, D<sup>X</sup> denotes the graph obtained by taking D and removing all edges into X. This process has an intuitive relationship with a do intervention on X in that intervening on X would override the causal effect of its parents in the original model. Note further that these mutilated graphs are still DAGs, and their d-separations capture probabilistic relationships in densities consistent with the mutilated DAGs.

In our do calculus, we assume knowledge of an MPDAG G and consider d-separations in mutilated versions of G. For example, we use G<sup>X</sup> to denote the graph obtained by taking G and removing all edges into X. But this process differs from Pearl's in several ways. First, removing edges from G into X does not have the same intuitive relationship with the intervention do(x), since G<sup>X</sup> may still contain edges adjacent to X that are undirected. In the true causal DAG, the corresponding edges may be directed into X and thus, represent a causal effect on X. Second, these mutilated graphs may no longer be MPDAGs. For example, consider an MPDAG G that contains the paths V<sup>1</sup> → V<sup>2</sup> − X and V<sup>1</sup> → X. The graph G<sup>X</sup> only contains the path V<sup>1</sup> → V<sup>2</sup> − X, and thus, is not closed under Meek's (1995) orientation rules. In Appendix F, we note a third, more technical difference useful in the proofs of Theorem 6. With this discussion, we turn to our result.

Theorem 6 (Do Calculus for MPDAGs) Let X, Y, Z, and W be pairwise disjoint node sets in a causal MPDAG G = (V, E). Let GXZ denote the graph obtained by deleting all edges into X and all edges out of Z from G. We write GXZ as G<sup>Z</sup> when X is empty and as G<sup>X</sup> when Z is empty. Then the following hold for all densities f consistent with G.

Rule 1. If (Y ⊥<sup>d</sup> Z|X,W)G<sup>X</sup> , then

$$
f(\mathbf{y}|do(\mathbf{x}), \mathbf{z}, \mathbf{w}) = f(\mathbf{y}|do(\mathbf{x}), \mathbf{w}).
$$
\n(6)

Rule 2. If (Y ⊥<sup>d</sup> Z|X,W)GXZ , then

$$
f(\mathbf{y}|do(\mathbf{z}), \mathbf{w}, do(\mathbf{x})) = f(\mathbf{y}|\mathbf{z}, \mathbf{w}, do(\mathbf{x})).
$$
\n(7)

Rule 3. If (Y ⊥<sup>d</sup> Z|X,W)GX,Z′(W) , then

$$
f(\mathbf{y}|do(\mathbf{z}), \mathbf{w}, do(\mathbf{x})) = f(\mathbf{y}|\mathbf{w}, do(\mathbf{x})),
$$
\n(8)

where 
$$
\mathbf{Z}'(\mathbf{W}) := \mathbf{Z} \setminus \text{PossAn}(\mathbf{W}, \mathcal{G}_{\mathbf{V} \setminus \mathbf{X}}).
$$

Proof Sketch. Theorem 6 follows from the do calculus of Pearl (2009) as well as Lemmas 49, 51, and 54. These lemmas and their proofs can be found in Appendix F, but we provide an overview here for intuition. Consider Rule 1 as an example. The result follows directly from Lemma 49, which claims that if the given d-separation—Y ⊥<sup>d</sup> Z | X,W—holds in the mutilated graph GX, then the same d-separation will hold in D<sup>X</sup> for any DAG D in the equivalence class [G]. We prove this by contraposition. Thus, we start by assuming there is a DAG D ∈ [G] such that D<sup>X</sup> has a path p from Y to Z that is open given X ∪ W. By definition, no non-collider on p is in X ∪ W. We then show that every collider on p is in An(X ∪ W, GX). To do this, we draw repeatedly on the relationships between DX, D, G, and GX. We prove this implies that the sequence of nodes in G<sup>X</sup> corresponding to p forms a path from Y to Z that is open given X ∪ W, which completes the proof. We rely on a similar contraposition for showing that Rules 2 and 3 hold.

Before providing examples, we pause to compare Theorem 6 with the do calculus of Pearl (2009). Note that since all DAGs are MPDAGs, Theorem 6 holds when a full DAG is known. We want to highlight that our do calculus and Pearl's are identical in this case. This claim follows without proof after considering a small detail found in Rule 3. Compare the definition of Z ′ (W) from Theorem 6 with that of Z(W) from Theorem 10. To show these sets are equivalent when a DAG G is known, we must show that Z \ An(W, GV\X) = Z\An(W, GX). To see this, note that An(W, GV\X) ⊆ An(W, GX), where the only variables in An(W, GX) not in An(W, GV\X) are in X. But Z and X are disjoint. Therefore, removing An(W, GV\X) from Z is equivalent to removing An(W, GX) from Z, and the claim holds.

#### 4.2 Examples

The rules of Theorem 6 offer a broad tool for transforming interventional densities in the MPDAG setting. An appealing use of this tool is identifying a conditional causal effect. We demonstrate how to use Theorem 6 for this purpose in the examples below. Example 4

![](_page_11_Figure_0.jpeg)

Figure 3: MPDAG used in Example 5

does this with the help of well-known probability rules, and it does this for an effect that our identification formula was able to find. We provide Examples 5 and 6 to highlight that our do calculus is able to find conditional effects that our identification formula cannot.

Example 4 (Multiple Routes) Reconsider Example 1, where we found the form of a conditional effect using our identification formula. We could instead use Theorem 6:

$$
f(\mathbf{y}|do(\mathbf{x}), \mathbf{z}) = \int f(y, v_2|do(x), v_1) dv_2
$$
  
= 
$$
\int f(y|do(x), v_1, v_2) f(v_2|do(x), v_1) dv_2
$$
  
= 
$$
\int f(y|x, v_1, v_2) f(v_2|v_1) dv_2,
$$

The first two equalities hold by the law of total probability and the chain rule, respectively. The third holds by Rules 2 and 3, since Y ⊥<sup>d</sup> X | V1, V<sup>2</sup> in G<sup>X</sup> and V<sup>2</sup> ⊥<sup>d</sup> X | V<sup>1</sup> in GX. This example provides a case where all three methods—conditional adjustment, the identification formula, and the do calculus for MPDAGs—find the same form for the conditional effect.

Example 5 (Using Rule 2) Let G be the causal MPDAG in Figure 3, and suppose we want to identify the causal effect of X on Y given {V1, V2}. Note that we cannot use Theorem 3, since {V1, V2} ∩ PossDe(X, G) ̸= ∅. However, we can use Theorem 6 to show

$$
f(y | do(x), v_1, v_2) = f(y | x, v_1, v_2).
$$

The equality follows from Rule 2, since Y ⊥<sup>d</sup> X | V1, V<sup>2</sup> in GX.

Example 6 (Using Rule 3) Let G be a causal MPDAG containing only X −Z → Y , and suppose we want to identify the causal effect of X on Y given Z. Note that we cannot use Theorems 3 or 4, since Z ∈ PossDe(X, G). However, we can use Theorem 6 to show

$$
f(y | do(x), z) = f(y | z).
$$

This holds by Rule 3, since Y ⊥<sup>d</sup> X |Z in GX.

# 5 Identification Algorithm

In Section 3, we introduced our conditional identification formula for MPDAGs (Theorem 3), which is able to identify causal effects when the conditioning set is unaffected by treatment.

#### Algorithm 1: Conditional Identification for MPDAGs (CIDM)

Input : Disjoint node sets X, Y, Z ⊆ V and causal MPDAG G = (V, E) Output: Expression for f(y | do(x), z), for any f consistent with G, or FAIL

```
1 Let Z
       ′ = Z and X′ = X;
```

|    | X′<br>′<br>∃<br>∪<br>G<br>2 While<br>a proper possibly causal path<br>to<br>Y<br>Z<br>in                                                                                                        | that starts undirected         |
|----|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------|
| 3  | X′ on such a path;<br>∈<br>Pick<br>X                                                                                                                                                            |                                |
| 4  | <br>X′ \ {X},<br>′<br>⊥d<br> <br>If<br>(<br>Y<br>X<br>Z<br>)<br>GX′\{X}X                                                                                                                       |                                |
| 5  | <br>′<br>Add<br>X<br>to<br>Z<br>;                                                                                                                                                            | Applies Rule 2 of              |
| 6  | X′<br>Remove<br>X<br>from<br>;<br>                                                                                                                                                           | Theorem 6                      |
| 7  | else                                                                                                                                                                                            |                                |
| 8  | Return<br>FAIL;                                                                                                                                                                                 |                                |
| 10 | X′<br>′<br>X′<br>′<br>X′ \<br>′<br>9 If<br>(<br>Y<br>⊥d<br> <br>Z<br>)<br>where<br>(Z<br>) :=<br>PossAn(Z<br>,<br>G)<br><br>GX′(Z′)<br><br>′<br>Return<br>f(y<br> <br>z<br>);<br><br>11 else | Applies Rule 3 of<br>Theorem 6 |
| 12 | <br>D =<br>′ ∩<br>PossDe(X′<br>Let<br>Z<br>Z<br>,<br>G);                                                                                                                                       |                                |
| 13 | <br>′ \<br>PossDe(X′<br>N =<br><br>Let<br>Z<br>Z<br>,<br>G);                                                                                                                              |                                |
| 14 | <br>′<br>Let<br>A<br>= identification formula for<br>f(y,<br>z<br>D  <br>do(x<br>),<br>z<br>N);                                                                                                | Applies                        |
| 15 | ′<br>Let<br>B<br>= identification formula for<br>f(z<br>D  <br>do(x<br>),<br>z<br>N);<br>                                                                                                    | Theorem 3                      |
| 16 | <br>A<br>Return<br>;<br>B<br>                                                                                                                                                               |                                |

In Section 4, we introduced our do calculus for MPDAGs (Theorem 6)—a broad tool that is able to identify further effects.

In this section, we introduce our conditional identification algorithm for MPDAGs (Algorithm 1), which combines Theorems 3 and 6. This algorithm does not restrict the conditioning set, and therefore, can identify further effects than our identification formula alone. In fact, we show below (Section 5.4) that Algorithm 1 is complete, and thus, can find any conditional effect that is identifiable given knowledge of an MPDAG.

We start this section by describing the algorithm and providing examples of how to use the algorithm for identifying conditional effects, when possible. Then we highlight the algorithm's completeness, which we demonstrate through examples. We close this section by offering an extension to our algorithm that outputs an enumeration of possible effects in cases where the true effect is not identifiable.

### 5.1 The Algorithm

Our identification algorithm can be found in Algorithm 1. It begins with pairwise disjoint node sets X, Y, and Z from a causal MPDAG G. When possible, it outputs an identifying form for f(y | do(x), z), where f is any density consistent with G. It does this in two broad steps: (1) manipulating f(y | do(x), z) in preparation for identification, and (2) identifying f(y | do(x), z). We describe these steps in more detail below.

![](_page_13_Figure_0.jpeg)

Figure 4: MPDAGs used in Examples 7-9

Step (1) happens inside the while loop of lines 2-8. Here the algorithm successively transfers nodes from do(X) into Z using Rule 2 of the do calculus for MPDAGs (Theorem 6). The while loop ends once there is no longer a proper possibly causal path from X′ to Y ∪ Z ′ that starts undirected. In Section 5.4, we show the absence of such a path is necessary for identification. Thus, if there is a node X ∈ X′ with a possibly causal path to Y ∪ Z ′ that starts undirected and which Rule 2 of the do calculus cannot transfer from do(X) into Z, then the algorithm outputs a FAIL.

Step (2) happens inside the if-else statement of lines 9-16. It begins by checking if the d-separation in Rule 3 of our do calculus holds. If so, then it provides the identifying expression f(y | do(x), z) = f(y | z ′ ). This step is not required for implementation, but we offer it as an off-ramp for a likely easy-to-estimate form of the density. If Rule 3 does not apply, then the algorithm relies on our identification formula (Theorem 3) in the following way. Lines 12-13 separate Z ′ into variables that are and are not possible descendants of X′—namely, Z <sup>D</sup> and Z <sup>N</sup>. Then lines 14-16 apply Theorem 3 based on the following insight:

$$
f(\mathbf{y} | do(\mathbf{x}'), \mathbf{z}') = \frac{f(\mathbf{y}, \mathbf{z}^{\mathbf{D}} | do(\mathbf{x}'), \mathbf{z}^{\mathbf{N}})}{f(\mathbf{z}^{\mathbf{D}} | do(\mathbf{x}'), \mathbf{z}^{\mathbf{N}})}.
$$
(9)

This holds by the chain rule, where the denominator is non-zero since we assume positivity (see Section 2). Thus, the algorithm applies Theorem 3 to both the numerator and denominator of (9). To see that this is allowed, note that Z <sup>N</sup> ∩ PossDe(X′ , G) = ∅, and by Step (1), there is no proper possibly causal path from X′ to Y ∪ Z <sup>D</sup> in G that starts undirected.

#### 5.2 Examples

In the examples below, we use Algorithm 1 in an attempt to identify the conditional causal effect of X on Y given Z. In Examples 7 and 8, Algorithm 1 succeeds in finding f(y | do(x), z). But the algorithm outputs a FAIL in Example 9. Note that all three examples assume knowledge of an MPDAG G where Z ∩ PossDe(X, G) ̸= ∅ and thus, our identification formula (Theorem 3) cannot be applied directly.

Example 7 (Non-fractional Form) Let G be the causal MPDAG in Figure 4(a), and let X = {X1, X2}, Y = {Y }, and Z = {Z}. To use Algorithm 1, we first consider the while loop of lines 2-8. Since there is a possibly causal path from X<sup>1</sup> ∈ X to Y ∪ Z that starts undirected and does not contain X2, we confirm that Y ⊥<sup>d</sup> X<sup>1</sup> | X2, Z in GX2X<sup>1</sup> . Thus, we define X′ = {X2} and Z ′ = {X1, Z}. Now that all possibly causal paths from X′ to Y ∪ Z ′ start directed, we exit the while loop. Then we skip lines 9-10 since Y ̸⊥<sup>d</sup> X′ | Z ′ in GX′. Finally, by lines 12-16,

$$
f(\mathbf{y} | do(\mathbf{x}), \mathbf{z}) = f(y | do(x_2), x_1, z)
$$
  
=  $f(y | x_1, x_2, z)$ .

Example 8 (Fractional Form) Let G be the causal MPDAG in Figure 4(b), and let X = {X}, Y = {Y }, and Z = {Z}. To use Algorithm 1, we first bypass the while loop of lines 2-8, since all possibly causal paths from X to Y ∪ Z start directed. We also skip lines 9-10 since Y ̸⊥<sup>d</sup> X | Z in G. Thus, by lines 12-16,

$$
f(\mathbf{y} | do(\mathbf{x}), \mathbf{z}) = \frac{\int f(y, z | v_1, x) f(v_1) dv_1}{\int f(z | v_1, x) f(v_1) dv_1}.
$$

Example 9 (Not Identifiable) Let G be the causal MPDAG in Figure 4(c), and let X = {X}, Y = {Y }, and Z = {Z}. To use Algorithm 1, we first consider the while loop of lines 2-8. Note that there is a possibly causal path from X ∈ X to Y ∪ Z that starts undirected, but Y ̸⊥<sup>d</sup> X | Z in GX. Thus, the algorithm returns a FAIL. In Section 5.4, we show this effect is not identifiable in G (see Example 13).

#### 5.3 Further Examples

The three examples above rely on our identification algorithm by walking through steps that our other methods would not. But we want to highlight that since Algorithm 1 combines our identification formula with our do calculus for MPDAGs, applying our algorithm sometimes amounts to no more than applying one of these methods alone. We demonstrate this in the examples below, which revisit examples from Sections 3 and 4.

Example 10 (Reduces to Identification Formula) Reconsider Example 1, but now use Algorithm 1 to identify the causal effect. We skip lines 2-10, since the following hold: Z ∩ PossDe(X, G) = ∅, no proper possibly causal path from X to Y starts undirected, and Y ̸⊥<sup>d</sup> X | Z in GX. Thus, the algorithm reduces to lines 12-16, and since Z <sup>N</sup> = Z, these lines reduce to the same application of our identification formula shown in Example 1. Note that this logic also applies to Example 2.

Example 11 (Reduces to Rule 3) Reconsider Example 3, but now use Algorithm 1 to identify the causal effect. We skip lines 2-8, since no there is no possibly causal path from X to Y ∪ Z. From lines 9-10, we confirm that Y ⊥<sup>d</sup> X | Z in GX. Thus, the algorithm reduces to an application of Rule 3 of our do calculus. In this case, note that this is equivalent to the application of Theorem 4 shown in Example 3.

Example 12 (Reduces to Rule 2) Reconsider Example 5. To use Algorithm 1, we first consider the while loop of lines 2-8. Since there is a possibly causal path from X ∈ X to Y ∪ Z that starts undirected, we confirm that Y ⊥<sup>d</sup> X | Z in GX. Thus, we define X′ = ∅ and Z ′ = {X, Z}. Formally, the algorithm must exit the while loop and consider lines 9- 10, but note that it has already found an identifying form (that the additional steps will not change). Thus, the algorithm reduces to the same application of Rule 2 of our do calculus shown in Example 5. Additionally note that the same logic applies to Example 6.

![](_page_15_Figure_0.jpeg)

Figure 5: DAGs used in Example 13

#### 5.4 Soundness and Completeness

Algorithm 1 is sound for identifying conditional causal effects given an MPDAG. That is, any expression the algorithm outputs will be an identifying form of f(y | do(x), z). This follows directly from Rules 2-3 of the do calculus for MPDAGs (Theorem 6), the chain rule, our positivity assumption (see Section 2), and our conditional identification formula (Theorem 3).

Algorithm 1 is also complete for identifying conditional causal effects given an MPDAG. To prove this, we offer the theorem below. This result shows that when our algorithm outputs a FAIL, the effect is not identifiable. That is, our algorithm is able to find an identifying form for any identifiable effect.

Theorem 7 (Completeness of Algorithm 1) Let X, Y, and Z be pairwise disjoint node sets in a causal MPDAG G. If there is a proper possibly causal path from X to Y∪Z in G that starts with an undirected edge and contains any X ∈ X such that Y ̸⊥<sup>d</sup> X | X\{X}, Z in GX\{X}<sup>X</sup> , then the conditional causal effect of X on Y given Z is not identifiable in G.

Proof Sketch. The proof of Theorem 7 can be found in Appendix G, but we provide an overview here for intuition. We begin the proof by assuming that a possibly causal path—as given in the statement of Theorem 7—exists in the MPDAG G. Based on the given d-separation between X ∈ X and Y, we consider the following non-empty sets:

$$
\mathbf{S_1} = \left\{ \begin{array}{c} \text{definite status paths in } \mathcal{G}_{\overline{\mathbf{X} \setminus \{X\}} \underline{X}} \text{ from } X \text{ to } \mathbf{Y} \text{ that are} \\ \text{d-connected} \text{ given } \mathbf{X} \setminus \{X\} \cup \mathbf{Z} \end{array} \right\} \text{ and}
$$
\n
$$
\mathbf{S_2} = \left\{ \text{ paths in } \mathbf{S_1} \text{ with the fewest colliders } \right\}. \tag{10}
$$

The remainder of the proof falls into two cases: (a) when S<sup>2</sup> only contains paths that start directed (i.e., of the form X ← . . . Y ) and (b) when S<sup>2</sup> contains paths that start undirected (i.e., of the form X − . . . Y ). Rather than providing an overview of each case, we offer two examples below. Example 13 considers an MPDAG with a path that falls into (a), and Example 14 considers an MPDAG with a path that falls into (b). In both examples, we show that the conditional causal effect is not identifiable.

Example 13 (Path in S<sup>2</sup> that Starts Directed) Reconsider Example 9, where we attempted to use Algorithm 1 to identify the conditional effect of X on Y given Z but the algorithm output a FAIL. Note that the MPDAG G = (V, E) in this example contains the path X ← V<sup>1</sup> → Y , which belongs to the set S<sup>2</sup> given in (10) and which starts directed.

To show the conditional effect is not identifiable in G, consider the DAGs D<sup>1</sup> , D<sup>2</sup> ∈ [G] shown in Figure 5(a)-(b). It suffices to show that each D<sup>i</sup> is compatible with a family of interventional densities F ∗ <sup>i</sup> = {fi(v|do(x ′ )) : X′ ⊆ V} such that the following hold.

$$
f_1(\mathbf{v}) = f_2(\mathbf{v}). \tag{11}
$$

$$
f_1(\mathbf{y} \mid \text{do}(\mathbf{x}), \mathbf{z}) \neq f_2(\mathbf{y} \mid \text{do}(\mathbf{x}), \mathbf{z}). \tag{12}
$$

To define such families, consider the DAG D<sup>1</sup> ′ in Figure 5(c), and note that D<sup>1</sup> ′ is constructed by removing edges from D<sup>1</sup> . Below we build an F ∗ 1 such that D<sup>1</sup> ′ is compatible with F ∗ 1 . It follows that D<sup>1</sup> is compatible with F ∗ 1 (see Lemma 43, App. E). Start by considering the following structural equation model (SEM) with independent errors:

$$
V_1 \leftarrow \varepsilon_{v_1}; \qquad \varepsilon_{v_1} \sim \mathcal{N}(0, 1);
$$
\n
$$
X \leftarrow \frac{1}{2}V_1 + \varepsilon_x; \qquad \varepsilon_x \sim \mathcal{N}(0, \frac{3}{4});
$$
\n
$$
Z \leftarrow \frac{1}{2}V_1 + \frac{1}{2}X + \varepsilon_z; \qquad \varepsilon_z \sim \mathcal{N}(0, \frac{1}{4});
$$
\n
$$
Y \leftarrow \frac{1}{2}V_1 + \varepsilon_y; \qquad \varepsilon_y \sim \mathcal{N}(0, \frac{3}{4}).
$$
\n
$$
(13)
$$

We build F ∗ 1 by letting f1(v) be the density of the multivariate normal generated by the SEM in (13). For the remaining densities in F ∗ 1 , we let f1(v | do(x ′ )) := f∗(v), where f<sup>∗</sup> is the density of the multivariate normal generated by taking the SEM in (13) and replacing X′ with its interventional value x ′ (Pearl, 2009).

Now consider the DAG D<sup>2</sup> ′ in Figure 5(d), and note that D<sup>2</sup> ′ is constructed by removing edges from D<sup>2</sup> . Next consider the following SEM with independent errors:

$$
V_1 \leftarrow \varepsilon_{v_1}; \qquad \varepsilon_{v_1} \sim \mathcal{N}(0, 1); \qquad (14)
$$
  
\n
$$
X \leftarrow -\frac{1}{7}V_1 + \frac{6}{7}Z + \varepsilon_x; \qquad \varepsilon_x \sim \mathcal{N}(0, \frac{3}{7});
$$
  
\n
$$
Z \leftarrow \frac{3}{4}V_1 + \varepsilon_z; \qquad \varepsilon_z \sim \mathcal{N}(0, \frac{7}{16});
$$
  
\n
$$
Y \leftarrow \frac{1}{2}V_1 + \varepsilon_y; \qquad \varepsilon_y \sim \mathcal{N}(0, \frac{3}{4}),
$$

Just as we built F ∗ 1 based on the SEM in (13), we build F ∗ 2 based on the SEM in (14). It follows that D<sup>2</sup> ′—and therefore D2—is compatible with F ∗ 2 .

Thus we have two families of interventional densities such that D<sup>i</sup> is compatible with F ∗ i . Further, we can show that f1(v) = f2(v) so that (11) holds. To complete the proof, we show that (12) holds. It suffices to show that E[Y | do(X = 1), Z = 0] is not the same under f<sup>1</sup> and f2. We start by calculating this expectation under f2:

$$
\mathbb{E}_{f_2}[Y \mid do(X = 1), Z = 0] = \mathbb{E}_{f_2}[Y \mid Z] \mid_{Z=0}
$$
  
=  $\mathbb{E}_{f_2}[Y] + \frac{\text{Cov}_{f_2}(Y, Z)}{\text{Var}_{f_2}(Z)} \cdot (Z - \mathbb{E}_{f_2}[Z]) \Big|_{Z=0}$   
=  $\frac{3}{8}Z \big|_{Z=0}$   
= 0.

The first equality follows from Pearl's do calculus (Theorem 10), since Y ⊥<sup>d</sup> X |Z in D<sup>2</sup> ′ X and since f<sup>2</sup> is consistent with D<sup>2</sup> ′ . The second equality follows from properties of multivariate normals (see Lemma 11).

![](_page_17_Figure_0.jpeg)

Figure 6: MPDAG used in Example 14

To calculate the same expectation under f1, recall that f1(v | do(x)) := f∗(v), where f∗(v) is the multivariate normal density generated by the following SEM with independent errors:

$$
V_1 \leftarrow \varepsilon_{v_1}; \qquad \varepsilon_{v_1} \sim \mathcal{N}(0, 1); \qquad (15)
$$
  
\n
$$
X \leftarrow x; \qquad \qquad Z \leftarrow \frac{1}{2}V_1 + \frac{1}{2}x + \varepsilon_z; \qquad \qquad \varepsilon_z \sim \mathcal{N}(0, \frac{1}{4}); \qquad \qquad Y \leftarrow \frac{1}{2}V_1 + \varepsilon_y; \qquad \qquad \varepsilon_y \sim \mathcal{N}(0, \frac{3}{4}),
$$

It follows that f1(y | do(x), z) := f∗(y | z) is the conditional density of Y |Z under f∗(v). Based on this and properties of multivariate normals (see Lemma 11),

$$
\mathbb{E}_{f_1}[Y \mid do(X = 1), Z = 0] = \mathbb{E}_{f_*}[Y \mid Z] \mid_{x=1, Z=0}
$$
  
\n
$$
= \mathbb{E}_{f_*}[Y] + \frac{\text{Cov}_{f_*}(Y, Z)}{\text{Var}_{f_*}(Z)} \cdot (Z - \mathbb{E}_{f_*}[Z]) \Big|_{x=1, Z=0}
$$
  
\n
$$
= \frac{1}{2}(Z - \frac{1}{2}x) \Big|_{x=1, Z=0}
$$
  
\n
$$
\neq 0.
$$

Example 14 (Path in S<sup>2</sup> that Starts Undirected) Let G = (V, E) be the MPDAG in Figure 6. If we attempt to identify the conditional effect of X on Y given Z, Algorithm 1 outputs a FAIL. We want to show this effect is not identifiable in G. To do this, we follow the same strategy as Example 13, and thus, exclude duplicate technical details. However, note that—unlike Example 13—G contains the path X − V<sup>1</sup> → Z ← Y , which belongs to the set S<sup>2</sup> given in (10) and which starts undirected.

Let D<sup>1</sup> , D<sup>2</sup> be the DAGs in [G] with edges X → V<sup>1</sup> and X ← V1, respectively. Then let D<sup>1</sup> ′ , D<sup>2</sup> ′ be the DAGs constructed by removing the edge X → Y from D<sup>1</sup> , D<sup>2</sup> , so that

$$
\mathcal{D}^{1'} : X \to V_1 \to Z \leftarrow Y, \text{ and}
$$
  
$$
\mathcal{D}^{2'} : X \leftarrow V_1 \to Z \leftarrow Y.
$$

Define F ∗ 1 (as in Example 13) based on the following SEM with independent errors:

$$
X \leftarrow \varepsilon_x; \qquad \varepsilon_x \sim \mathcal{N}(0, 1);
$$
  
\n
$$
V_1 \leftarrow \frac{1}{2}X + \varepsilon_{v_1}; \qquad \varepsilon_{v_1} \sim \mathcal{N}(0, \frac{3}{4});
$$
  
\n
$$
Z \leftarrow \frac{1}{2}V_1 + \frac{1}{2}Y + \varepsilon_z; \qquad \varepsilon_z \sim \mathcal{N}(0, \frac{1}{2});
$$
  
\n
$$
Y \leftarrow \varepsilon_y; \qquad \varepsilon_y \sim \mathcal{N}(0, 1).
$$

Analogously, define F ∗ 2 based on the following SEM with independent errors:

$$
X \leftarrow \frac{1}{2}V_1 + \varepsilon_x; \qquad \varepsilon_x \sim \mathcal{N}(0, \frac{3}{4});
$$
  
\n
$$
V_1 \leftarrow \varepsilon_{v_1}; \qquad \varepsilon_{v_1} \sim \mathcal{N}(0, 1);
$$
  
\n
$$
Z \leftarrow \frac{1}{2}V_1 + \frac{1}{2}Y + \varepsilon_z; \qquad \varepsilon_z \sim \mathcal{N}(0, \frac{1}{2});
$$
  
\n
$$
Y \leftarrow \varepsilon_y; \qquad \varepsilon_y \sim \mathcal{N}(0, 1).
$$

Thus we have two families of interventional densities where D<sup>i</sup> is compatible with F ∗ i and where we can show f1(v) = f2(v). To complete the proof, we show that E[Y | do(X = 1), Z = 0] is not the same under f<sup>1</sup> and f2.

$$
\mathbb{E}_{f_1}[Y \mid do(X = 1), Z = 0] = \mathbb{E}_{f_1}[Y \mid X = 1, Z = 0] = -\frac{2}{15}X + \frac{8}{15}Z \big|_{X=1, Z=0} \neq 0.
$$
  
$$
\mathbb{E}_{f_2}[Y \mid do(X = 1), Z = 0] = \mathbb{E}_{f_2}[Y \mid Z = 0] = \frac{1}{2}Z \big|_{Z=0} = 0.
$$

The first equality of each line follows from Rules 2 and 3 of Pearl's do calculus (Theorem 10), respectively, since Y ⊥<sup>d</sup> X |Z in D<sup>1</sup> ′ <sup>X</sup>; Y ⊥<sup>d</sup> X |Z in D<sup>2</sup> ′ X ; and f<sup>i</sup> is consistent with D<sup>i</sup> ′ . The remaining equalities follow from properties of multivariate normals (see Lemma 11).

#### 5.5 An Extension for Non-identifiable Effects

Prior research on causal effect identification includes suggestions for estimation when an effect is not identifiable. The IDA algorithm of Maathuis et al. (2009) does this by outputting a multiset of all possible causal effects. It relies on the fact that even when an effect is not identifiable given a completed partially directed acyclic graph (CPDAG) C, the effect is identifiable in each DAG in [C]. This multiset does not tell us which of its elements is the true effect, but it does provide some information, such as bounds on the causal effect. Subsequent research extended these results to consider additional settings and to improve computation (Maathuis et al., 2010; Perkovi´c et al., 2017; Nandy et al., 2017; Fang and He, 2020; Guo and Perkovi´c, 2021).

Following this line of research, we offer Algorithm 2 (CIDME)—an extension of our identification algorithm (Algorithm 1) that outputs a multiset of possible expressions for the interventional density f(y | do(x), z) given an MPDAG G. When the conditional effect is identifiable, this multiset will be the identical output to that of Algorithm 1. But when the conditional effect is not identifiable, this multiset will be a set of possible expressions for f(y | do(x), z)—one for each partition of the equivalence class [G].

Algorithm 2 produces these partitions in the following way. Whenever there is a proper possibly causal path from X′ to Y ∪Z ′ in G that starts with an undirected edge X −V2, the algorithm takes a shortest such a path and considers both orientations of ⟨X, V2⟩. Orienting X → V<sup>2</sup> in G and completing R1-R4 of Meek (1995) forms a new MPDAG G<sup>1</sup> with fewer possibly causal paths from X′ to Y ∪ Z ′ that start undirected, and orienting X ← V<sup>2</sup> forms an analogous MPDAG G2. Algorithm 2 takes these new MPDAGs and begins anew, outputting CIDME(X′ , Z ′ , Y, G1) and CIDME(X′ , Z ′ , Y, G2). If the causal effect of X′ on Y given Z ′ is identifiable given G<sup>1</sup> and G2, then lines 12-13 of Algorithm 2 output a multiset with two elements: expressions for f(y | do(x), z) given G<sup>1</sup> and G2, respectively. Otherwise, the algorithm iterates by continuing to orient the first edge of any possibly causal path from X′ to Y ∪ Z ′ that starts undirected, until none remain.

#### Algorithm 2: Conditional Identification for MPDAGs + Enumeration (CIDME)

Input : Disjoint node sets X, Y, Z ⊆ V and causal MPDAG G = (V, E) Output: Set of possible expressions for f(y | do(x), z), for any f consistent with G

1 Let Z ′ = Z and X′ = X;

<sup>2</sup> While ∃ a proper possibly causal path X′ to Y ∪ Z ′ in G that starts undirected <sup>3</sup> Pick X ∈ X′ on such a path; <sup>4</sup> If ( Y ⊥<sup>d</sup> X | X′ \ {X}, Z ′ ) <sup>G</sup>X′\{X}<sup>X</sup> 5 Add X to Z ′ ; <sup>6</sup> Remove X from X′ ; 7 else 8 Pick a shortest proper possibly causal path in G <sup>9</sup> from X′ to Y ∪ Z ′ that starts with X − V2; Partitions [G] by orienting X − V<sup>2</sup> <sup>10</sup> Form G1: orient X → V2, complete R1-R4 of Meek (1995); <sup>11</sup> Form G2: orient X ← V2, complete R1-R4 of Meek (1995); <sup>12</sup> Return CIDME(X′ , Z ′ , Y, G1); <sup>13</sup> Return CIDME(X′ , Z ′ , Y, G2); <sup>14</sup> If ( Y ⊥<sup>d</sup> X′ | Z ′ ) <sup>G</sup>X′(Z′) where X′ (Z ′ ) := X′ \ PossAn(Z ′ , G) 15 Return f(y | z ′ ); 16 else 17 Let Z <sup>D</sup> = Z ′ ∩ PossDe(X′ , G); 18 Let Z <sup>N</sup> = Z ′ \ PossDe(X′ , G); 19 Let A = identification formula for f(y, z <sup>D</sup> | do(x ′ ), z <sup>N</sup>); 20 Let B = identification formula for f(z <sup>D</sup> | do(x ′ ), z <sup>N</sup>); <sup>21</sup> Return <sup>A</sup> B ;

# 6 Discussion

In this paper, we propose strategies to identify a conditional causal effect from observational data. We assume knowledge of an MPDAG, a graph that can be learned from observational data and that allows for the addition of background knowledge. Our results include

- an identification formula (Theorem 3), which is sound and complete for identifying a conditional effect when the conditioning set is unaffected by treatment (Proposition 5),
- a do calculus for MPDAGs (Theorem 6), which is sound for identifying a conditional effect, and
- an identification algorithm (Algorithm 1), which is sound and complete for identifying a conditional effect (Theorem 7) and which combines our preceding results.

Our work builds on prior research in causal identification, and we detail these connections in the sections above. Most directly, our identification formula broadens the scope of Perkovi´c's (2020) formula for unconditional effects given an MPDAG. Similarly, our do calculus is comparable to Zhang (2008) and Jaber et al.'s (2022) calculus for PAGs. And our identification algorithm (CIDM) relates to a broad history of conditional identification algorithms, such as the IDC algorithm of Shpitser and Pearl (2006) and the CIDP algorithm of Jaber et al. (2022). Our extension of CIDM for non-identifiable effects follows a rich thread of algorithms for enumerating possible causal effects, including the algorithms of Maathuis et al. (2009, 2010); Nandy et al. (2017); Fang and He (2020); and Guo and Perkovi´c (2021).

The main limitation of our work compared to the results of Shpitser and Pearl (2006), Zhang (2008), and Jaber et al. (2022) is that we consider a setting that does not allow latent confounding. But we want to highlight that research on identification in these graphs (e.g., PAGs) does not cover the general MPDAG setting. For example, our CIDM algorithm cannot be seen as a simplification of the CIDP algorithm of Jaber et al. (2022). That is, a naive translation of the CIDP algorithm to the MPDAG setting would not be complete for identification given an MPDAG (see Example 15, in App. H). This holds since the completeness of the CIDM algorithm relies on properties of PAGs (e.g., undirected components must be chordal, undirected paths must be possibly causal) that do not hold generally for MPDAGs.

However, a key advantage of our work is that we consider a setting that allows the addition of expert knowledge, which follows research on the MPDAG setting seen in Perkovi´c (2020) and LaPlante and Perkovi´c (2024). This process of adding expert knowledge to causal graphs is largely excluded from research on identification in causal PAGs (e.g., Zhang, 2008; Jaber et al., 2022). Though we point out the work of Venkateswaran and Perkovi´c (2024), which considers a setting that allows for both latent variables and the addition of expert knowledge. We hope that our results in combination with those of Venkateswaran and Perkovi´c (2024) and LaPlante and Perkovi´c (2024) can be used toward future research on conditional identification in the presence of both latent variables and expert knowledge.

#### Acknowledgments and Disclosure of Funding

This material is based upon work supported by the National Science Foundation under Grant No. 2210210.

# Supplement to: Identifying Conditional Causal Effects in MPDAGs

# Contents

| 1 | Introduction                                                                                                                                                                                                | 1                                |
|---|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------|
| 2 | Preliminaries                                                                                                                                                                                               | 3                                |
| 3 | Identification Formula<br>3.1<br>Review of the PCO Algorithm<br>.<br>3.2<br>Identification Formula<br>.<br>3.3<br>Special Cases<br>.<br>3.4<br>Examples<br>.<br>3.5<br>Identifiability Condition<br>.       | 5<br>5<br>6<br>7<br>8<br>9       |
| 4 | Do Calculus for MPDAGs<br>4.1<br>The Calculus<br>.<br>4.2<br>Examples<br>.                                                                                                                                  | 10<br>10<br>11                   |
| 5 | Identification Algorithm<br>5.1<br>The Algorithm<br>.<br>5.2<br>Examples<br>.<br>5.3<br>Further Examples<br>5.4<br>Soundness and Completeness<br>.<br>5.5<br>An Extension for Non-identifiable Effects<br>. | 12<br>13<br>14<br>15<br>16<br>19 |
| 6 | Discussion                                                                                                                                                                                                  | 20                               |
| A | Further Definitions                                                                                                                                                                                         | 23                               |
| B | Existing Results                                                                                                                                                                                            | 23                               |
| C | Broad MPDAG Results<br>C.1<br>Results on Possibly Causal Paths<br>C.2<br>Remarks on the Ordering of Buckets<br>.<br>C.3<br>Results on Paths Among Buckets                                                   | 26<br>26<br>28<br>28             |
| D | Proofs for Section 3.2: Identification Formula<br>D.1<br>Main Result<br>D.2<br>Supporting Results                                                                                                           | 30<br>30<br>35                   |
| E | Proofs for Section 3.5: Identifiability Condition<br>E.1<br>Main Results<br>.<br>E.2<br>Supporting Results                                                                                                  | 38<br>38<br>40                   |

| F | Proofs for Section 4: Do Calculus for MPDAGs                                                        | 41             |
|---|-----------------------------------------------------------------------------------------------------|----------------|
|   | F.1<br>Results for All do Rules<br>.                                                                | 41             |
|   | F.2<br>Results for do Rule 1                                                                        | 43             |
|   | F.3<br>Results for do Rule 2                                                                        | 45             |
|   | F.4<br>Results for do Rule 3                                                                        | 48             |
| G | Proofs for Section 5.4: Identification Algorithm<br>G.1<br>Main Result<br>G.2<br>Supporting Results | 50<br>50<br>57 |
| H | A Note on Jaber's (2022)<br>CIDP Algorithm                                                          | 65             |

# A Further Definitions

Concatenation. We denote the concatenation of paths by the symbol ⊕, so that for a path p = ⟨X1, X2, . . . , Xm⟩, p = p(X1, Xr) ⊕ p(Xr, Xm), for 1 ≤ r ≤ m.

Definition 8 (Bucket Decomposition; Perkovi´c, 2020) Let D be a node set in an MPDAG G. Then B1, . . . , Bk, k ≥ 1, is the bucket decomposition of D in G if B<sup>i</sup> , i ∈ {1, . . . , k}, is a bucket in D and ∪ k <sup>i</sup>=1B<sup>i</sup> = D.

Definition 9 (Distance to Z; Perkovi´c et al., 2017) Let {X, Y } and Z be disjoint node sets in an MPDAG G, and let p be a path in G from X to Y such that G has a possibly directed path (possibly of zero length) from every collider on p to Z. Further, let {C1, . . . , Ck} be the set of colliders on p, and let ℓi, i ∈ {1, . . . , k}, be the length of a shortest possibly directed path in G from C<sup>i</sup> to Z. Then the distance to Z for p is P<sup>k</sup> <sup>i</sup>=1 ℓi.

# B Existing Results

Theorem 10 (Rules of the do Calculus; Theorem 3.4.1 of Pearl (2009)) Let X, Y, Z, and W be pairwise disjoint (possibly empty) node sets in a causal DAG D. Let D<sup>X</sup> denote the graph obtained by deleting all edges into X from D. Similarly, let D<sup>X</sup> denote the graph obtained by deleting all edges out of X in D, and let DXZ denote the graph obtained by deleting all edges into X and all edges out of Z in D. The following rules hold for all densities consistent with D.

Rule 1. If (Y ⊥<sup>d</sup> Z | X,W)D<sup>X</sup> , then

$$
f(\mathbf{y}|do(\mathbf{x}), \mathbf{z}, \mathbf{w}) = f(\mathbf{y}|do(\mathbf{x}), \mathbf{w}).
$$
\n(16)

Rule 2. If (Y ⊥<sup>d</sup> X | Z,W)DXW , then

$$
f(\mathbf{y}|do(\mathbf{x}), \mathbf{z}, do(\mathbf{w})) = f(\mathbf{y}|\mathbf{x}, \mathbf{z}, do(\mathbf{w})).
$$
\n(17)

Rule 3. If (Y ⊥<sup>d</sup> X | Z,W)DW,X(Z) , then

$$
f(\mathbf{y}|do(\mathbf{x}), \mathbf{z}, do(\mathbf{w})) = f(\mathbf{y}|\mathbf{z}, do(\mathbf{w})),
$$
\n(18)

where X(Z) := X \ An(Z, DW).

Lemma 11 (Theorem 3.2.4 of Mardia et al., 1980) Let X = (X<sup>1</sup> T , X<sup>2</sup> T ) T be a p-dimensional multivariate Gaussian random vector with mean vector µ = (µ<sup>1</sup> T , µ<sup>2</sup> T ) <sup>T</sup> and covariance matrix Σ = Σ<sup>11</sup> Σ<sup>12</sup> <sup>Σ</sup><sup>21</sup> <sup>Σ</sup>22 , so that X<sup>1</sup> is a q-dimensional multivariate Gaussian random vector with mean vector µ<sup>1</sup> and covariance matrix Σ<sup>11</sup> and X<sup>2</sup> is a (p − q)-dimensional multivariate Gaussian random vector with mean vector µ<sup>2</sup> and covariance matrix Σ22. Then E[X2|X<sup>1</sup> = x1] = µ<sup>2</sup> + Σ21Σ<sup>11</sup> −1 (x<sup>1</sup> − µ1).

Lemma 12 (Wright's Rule; Wright, 1921, 1934) Consider the following structural equation model (SEM) over a vector of random variables X = (X1, . . . , Xk) T . The set of equations is given by X = AX + ε, where A ∈ R k×k is a matrix with zeroes on the diagonal and coefficients from the SEM on the off-diagonals, ε = (ε1, . . . , εk) T is a vector of mutually independent errors with finite means, and V ar(Xi) = 1 for all i ∈ {1, . . . , k}. Let D be a DAG over X such that X<sup>i</sup> → X<sup>j</sup> is in D if and only if Aji ̸= 0 for i, j ∈ {1, . . . , k}, i ̸= j. (We call Aji the edge coefficient of X<sup>i</sup> → X<sup>j</sup> when Aji ̸= 0.) Further, let {p1, . . . , ps} be the set of paths between X<sup>i</sup> and X<sup>j</sup> in D that do not contain a collider, and let π<sup>r</sup> be the product of all edge coefficients along the path pr, r ∈ {1, . . . , s}. Then Cov(X<sup>i</sup> , X<sup>j</sup> ) = P<sup>s</sup> <sup>r</sup>=1 πr.

Lemma 13 (cf. proof of Lemma B.4, Henckel et al. (2022)) Consider the following structural equation model (SEM) over a vector of random variables X = (X1, . . . , Xk) T . The set of equations is given by X = AX + ε, where A ∈ R k×k is a matrix with zeroes on the diagonal and coefficients from the SEM on the off-diagonals, ε = (ε1, . . . , εk) T is a vector of mutually independent errors with finite means, and finite variances. Let D be a DAG over X such that X<sup>i</sup> → X<sup>j</sup> is in D if and only if Aji ̸= 0 for i, j ∈ {1, . . . , k}, i ̸= j. (We call Aji the edge coefficient of X<sup>i</sup> → X<sup>j</sup> when Aji ̸= 0.) Then we can write

$$
X_i = \sum_{j: X_j \in \text{An}(X_i, \mathcal{D})} \tau_{ji} \varepsilon_j
$$

where we define τji as follows. Let τii = 1. For the remaining τji, consider the set of all causal paths {p1, . . . , ps} from X<sup>j</sup> to X<sup>i</sup> in D, and let π<sup>r</sup> be the product of all edge coefficients along the path pr, r ∈ {1, . . . , s}. Then let τji = P<sup>s</sup> <sup>r</sup>=1 πr. Further, we have

$$
Cov(X_i, X_j) = \sum_{k: X_k \in An(X_i, \mathcal{D}) \cap An(X_j, \mathcal{D})} \tau_{ki} \tau_{kj} \text{Var}(\varepsilon_k),
$$

Lemma 14 (cf. Theorem 1 and Proposition 3 of Lauritzen et al., 1990) Let D = (V, E) be a DAG, and let f be an observational density over V. Then f is Markov compatible with D if and only if

$$
V_i \perp \left[ \mathbf{V} \setminus (\mathrm{De}(V_i, \mathcal{D}) \cup \mathrm{Pa}(V_i, \mathcal{D})) \right] | \mathrm{Pa}(V_i, \mathcal{D})
$$

for all V<sup>i</sup> ∈ V, where ⊥⊥ indicates independence with respect to f.

Lemma 15 (cf. Lemma F.1 of Rothenh¨ausler et al., 2018) Let X and Y be nodes in an MPDAG G = (V, E) such that X − Y is in G. Let G ′ be an MPDAG constructed from G by adding X → Y and completing the orientation rules R1 - R4 of Meek (1995). For any Z, W ∈ V, if Z − W is in G and Z → W is in G ′ , then W ∈ De(Y, G ′ ).

Algorithm 3: PCO Algorithm of Perkovi´c (2020)

Inputs : Node set D ⊆ V and MPDAG G = (V, E) Output: List of buckets B=(B1, . . . , Bk), k ≥ 1, in D given G

1 Let ConComp be the bucket decomposition of V in G (Definition 8);

- 2 Let B be an empty list;
- 3 While ConComp ̸= ∅
- 4 Let C ∈ ConComp;
- 5 Let C be the set of nodes in ConComp that are not in C;
- 6 If all edges between C and C are into C in G
- 7 Remove C from ConComp;
- <sup>8</sup> Let B<sup>∗</sup> = C ∩ D;
- <sup>9</sup> If B<sup>∗</sup> ̸= ∅

<sup>10</sup> Add B<sup>∗</sup> to the beginning of B;

11 Return B;

Lemma 16 (cf. Lemma F.2 of Rothenh¨ausler et al., 2018) Let X be a node in an MPDAG G = (V, E), and let S be a set such that for all S ∈ S, X − S is in G. Then there is an MPDAG G ′ = (V, E′ ) that is formed by taking G, orienting X → S for all S ∈ S, and completing R1-R4 of Meek (1995).

Lemma 17 (cf. Lemma 1 of Meek, 1995) Let X, Y , and Z be nodes in a CPDAG C. If C contains X → Y − Z, then C contains X → Y .

Lemma 18 (Lemma 3.2 of Perkovi´c et al., 2017) Let X and Y be nodes in an MPDAG G and let p be a path from X to Y in G. If there exists a DAG D ∈ [G] such that the path in D corresponding to p in G is causal, then p is possibly causal.

Lemma 19 (Lemma 3.5 of Perkovi´c et al., 2017) Let p = ⟨V1, . . . , Vk⟩, k ≥ 2, be a definite status path in an MPDAG. Then p is possibly causal if and only if p has no edge V<sup>i</sup> ← Vi+1 for any i ∈ {1, . . . , k − 1}.

Lemma 20 (Lemma 3.5 of Perkovi´c, 2020) Let D be a node set in an MPDAG G and let PCO(D, G) = (B1, . . . , Bk), k ≥ 1, be the output of the PCO Algorithm (Algorithm 3). Then for i, j ∈ {1, . . . , k}, B<sup>i</sup> and B<sup>j</sup> are buckets in D, and if i < j, then B<sup>i</sup> < B<sup>j</sup> in G.

Lemma 21 (Lemma C.2 of Perkovi´c, 2020) Let C be a bucket in V in an MPDAG G = (V, E) and let X ∈ V \ C. If there is a causal path from X to C in G, then for every node C ∈ C, there is a causal path from X to C in G.

Lemma 22 (cf. Proof of Lemma C.2 of Perkovi´c, 2020) Let C be a bucket in V in an MPDAG G = (V, E) and let X ∈ V \ C. If X ∈ Pa(C, G), then X ∈ Pa(C, G) for every node C ∈ C.

Lemma 23 (Lemma D.1(i) of Perkovi´c, 2020) Let X and Y be disjoint node sets in an MPDAG G = (V, E), where there is no proper possibly causal path from X to Y that starts with an undirected edge in G. Then there is no proper possibly causal path from X to An(Y, GV\X) that starts with an undirected edge in G.

# C Broad MPDAG Results

This section presents broad results for MPDAGs used in the proofs of Appendix D. We include these results here rather than in Appendix D, because they are likely useful beyond the scope of this paper.

#### C.1 Results on Possibly Causal Paths

Lemma 24 (cf. Lemma 3.6 of Perkovi´c et al., 2017) Let X and Y be distinct nodes in an MPDAG G and let p be a possibly causal path from X to Y in G. Then any shortest subsequence of p in G forms an unshielded, possibly causal path from X to Y .

Proof of Lemma 24. Let k be the number of nodes on p. Pick an arbitrary shortest subsequence of p and call it p ∗ := ⟨X = V0, . . . , V<sup>ℓ</sup> = Y ⟩, 0 < ℓ ≤ k. Note that there is no edge V<sup>i</sup> ← V<sup>j</sup> , 0 ≤ i < j ≤ k in G, since this would contradict that p is possibly causal. Thus, p ∗ is also possibly causal. Further, note that p ∗ is unshielded, since if any triple on the path is shielded, it either contradicts that p ∗ is possibly causal (i.e., V<sup>i</sup> ← Vi+2 cannot be in p ∗ ) or that p ∗ is a shortest subsequence of p (i.e., V<sup>i</sup> → Vi+2 and V<sup>i</sup> − Vi+2 cannot be in p ∗ ).

Lemma 25 Let p = ⟨P0, . . . , Pk⟩ be a path in an MPDAG G. Then p is possibly causal if and only if G does not contain any path P<sup>i</sup> ← · · · ← P<sup>j</sup> , 0 ≤ i < j ≤ k.

Proof of Lemma 25. ⇐ Follows immediately. ⇒ Let p be possibly causal, and for sake of contradiction, suppose G contains a path q from P<sup>i</sup> to P<sup>j</sup> , 0 ≤ i < j ≤ k, of the form P<sup>i</sup> = Q<sup>0</sup> ← · · · ← Q<sup>ℓ</sup> = P<sup>j</sup> . Then define r = ⟨P<sup>i</sup> = R0, . . . , R<sup>m</sup> = P<sup>j</sup> ⟩ to be a shortest subsequence of p(P<sup>i</sup> , P<sup>j</sup> ) in G, and note that by Lemma 24, r is an unshielded, possibly causal path.

To see that r(R0, R1) takes the form R<sup>0</sup> − R1, note that G cannot contain R<sup>0</sup> ← R1, since r is possibly causal. Further, G cannot contain R<sup>0</sup> → R1, since r being unshielded would imply, by R1 of Meek (1995), that G contains the cycle P<sup>i</sup> = R<sup>0</sup> → · · · → R<sup>m</sup> = P<sup>j</sup> = Q<sup>ℓ</sup> → · · · → Q<sup>0</sup> = P<sup>i</sup> . Then since G contains R<sup>0</sup> − R1, there must be a DAG D ∈ [G] that contains R<sup>0</sup> → R1. But since r is unshielded, this implies, by R1 of Meek (1995), that D contains the cycle P<sup>i</sup> = R<sup>0</sup> → · · · → R<sup>m</sup> = P<sup>j</sup> = Q<sup>ℓ</sup> → · · · → Q<sup>0</sup> = P<sup>i</sup> , which is a contradiction.

Lemma 26 Let X, Y , and Z be distinct nodes in an MPDAG G.

(i) If p is a possibly causal path from X to Y and q is a causal path from Y to Z, then p ⊕ q is a possibly causal path from X to Z.

### (ii) If p is a causal path from X to Y and q is a possibly causal path from Y to Z, then p ⊕ q is a possibly causal path from X to Z.

Proof of Lemma 26. Let p = ⟨X = P0, . . . , P<sup>k</sup> = Y ⟩ and q = ⟨Y = Q0, . . . , Q<sup>r</sup> = Z⟩, where either (i) p is possibly causal and q is causal, or (ii) q is possibly causal and p is causal. To see that p ⊕ q exists, suppose for sake of contradiction that p and q share at least one node other than Y . Let S denote the collection of such nodes, and consider the node in S with the lowest index on q. That is, consider Q<sup>j</sup> ∈ S such that j ≤ ℓ for all Q<sup>ℓ</sup> ∈ S. Let Q<sup>j</sup> = P<sup>i</sup> for some P<sup>i</sup> ̸= Y on p. Under (i), q is causal so that G contains P<sup>k</sup> = Q<sup>0</sup> → · · · → Q<sup>j</sup> = P<sup>i</sup> . But by Lemma 25, this contradicts that p is possibly causal. Similarly, under (ii), p is causal so that G contains Q<sup>j</sup> = P<sup>i</sup> → · · · → P<sup>k</sup> = Q0, which contradicts that q is possibly causal.

To complete the proof, we show that there is no backward edge between any two nodes on p ⊕ q. By the choice of p and q, note that there is no edge Pi<sup>1</sup> ← Pj<sup>1</sup> for 0 ≤ i<sup>1</sup> < j<sup>1</sup> ≤ k in G, and there is no edge Qi<sup>2</sup> ← Qj<sup>2</sup> for 0 ≤ i<sup>2</sup> < j<sup>2</sup> ≤ r in G. Thus, suppose for sake of contradiction that there exists an edge P<sup>i</sup> ← Q<sup>j</sup> in G for i ∈ {0, . . . , k−1} and j ∈ {1, . . . , r}. Note that P<sup>i</sup> is on p and not q, and analogously, Q<sup>j</sup> is on q and not p, since we have shown p and q cannot share nodes other than Y .

CASE (i): Note that p(P<sup>i</sup> , Y ) is possibly causal. Then pick an arbitrary shortest subsequence of p(P<sup>i</sup> , Y ) and call it t := ⟨P<sup>i</sup> = T0, . . . , T<sup>m</sup> = Y ⟩, m ≥ 1. By Lemma 24, t forms an unshielded, possibly causal path. Since t is possibly causal, G must contain T<sup>0</sup> → T<sup>1</sup> or T<sup>0</sup> − T1. Thus, there is a DAG D ∈ [G] that contains the edge T<sup>0</sup> → T1. Further, since t is unshielded, D contains T<sup>0</sup> → · · · → T<sup>m</sup> by R1 of Meek (1995). But this is a contradiction, since q is causal and thus D contains the cycle P<sup>i</sup> = T<sup>0</sup> → · · · → T<sup>m</sup> = Y = Q<sup>0</sup> → · · · → Q<sup>j</sup> → P<sup>i</sup> .

CASE (ii): Note that q(Y, Q<sup>j</sup> ) is possibly causal. Then pick an arbitrary shortest subsequence of q(Y, Q<sup>j</sup> ) and call it t := ⟨Y = T0, . . . , T<sup>m</sup> = Q<sup>j</sup> ⟩, m ≥ 1. By Lemma 24, t forms an unshielded, possibly causal path. Since t is possibly causal, G must contain T<sup>0</sup> → T<sup>1</sup> or T<sup>0</sup> −T1. Thus, there is a DAG D ∈ [G] that contains the edge T<sup>0</sup> → T1. Further, since t is unshielded, D contains T<sup>0</sup> → · · · → T<sup>m</sup> by R1 of Meek (1995). But this is a contradiction, since p is causal and thus D contains the cycle Y = T<sup>0</sup> → · · · → T<sup>m</sup> = Q<sup>j</sup> → P<sup>i</sup> → · · · → P<sup>k</sup> = Y .

Remark 27 Perhaps contrary to intuition, even if a path is possibly causal in an MPDAG G, there may not exist a DAG in [G] where the corresponding path is causal.

To see this, consider the MPDAG G in Figure 7 and let p = ⟨X, V1, V2, Y ⟩. Note that p is possibly causal. Let D be an arbitrary DAG in G and define p ∗ to be the path in D corresponding to p in G. If p ∗ begins X ← V1, it is non-causal. Thus, consider when p ∗ begins X → V1. It follows that D contains V<sup>1</sup> → V<sup>2</sup> by R1 of Meek (1995) as well as V<sup>2</sup> ← Y by R4 of Meek (1995), so that again, p ∗ is non-causal.

Lemma 28 Let X and Y be nodes in an MPDAG G. Then there is a possibly causal path from X to Y in G if and only if there is at least one DAG in [G] with a causal path from X to Y .

![](_page_27_Figure_0.jpeg)

Figure 7: An MPDAG used in Remark 27.

Proof of Lemma 28. ⇐ Holds by Lemma 18. ⇒ Let p be a possibly causal path from X to Y in G = (V, E) and let p <sup>∗</sup> = ⟨X = V0, . . . , V<sup>k</sup> = Y ⟩, k ≥ 1, be a shortest subsequence of p in G. By Lemma 24, p ∗ forms an unshielded, possibly causal path. Since p ∗ is possibly causal, G must contain V<sup>0</sup> → V<sup>1</sup> or V<sup>0</sup> − V1. Thus, there is a DAG D ∈ [G] that contains the edge V<sup>0</sup> → V1. Further, since p ∗ is unshielded, D contains X = V<sup>0</sup> → · · · → V<sup>k</sup> = Y by R1 of Meek (1995).

### C.2 Remarks on the Ordering of Buckets

Remark 29 Note that the output of the PCO Algorithm (Algorithm 3) is an ordered bucket decomposition (Definition 2) of the input node set in the input MPDAG. This follows from the steps of Algorithm 3 and Lemma 20.

Definition 30 (Bucket Decomposition Matching) Let D be a node set in an MPDAG G = (V, E). Let (B1, . . . , Bk), k ≥ 1, be an ordered bucket decomposition of D in G (Definition 2), and let (C1, . . . , Cℓ), ℓ ≥ k, be an ordered bucket decomposition of V in G. We say that (C1, . . . , Cℓ) is an ordered bucket decomposition that matches the ordering of (B1, . . . , Bk) if the following holds. For any i, j ∈ {1, . . . , k} and m, n ∈ {1, . . . , ℓ} such that B<sup>i</sup> ∩ C<sup>m</sup> ̸= ∅ and B<sup>j</sup> ∩ C<sup>n</sup> ̸= ∅, if B<sup>i</sup> < B<sup>j</sup> , then C<sup>m</sup> < Cn.

Remark 31 Let D be a node set in the MPDAG G = (V, E), and let P CO(D, G) = (B1, . . . , Bk), k ≥ 1, be the output of the PCO Algorithm (Algorithm 3). Since the algorithm relies on the intersection of D with an ordering of the bucket decomposition of V in G, there must exist an ordered bucket decomposition of V in G (Definition 2) that matches the ordering (Definition 30) of (B1, . . . , Bk).

#### C.3 Results on Paths Among Buckets

Lemma 32 Let G = (V, E) be an MPDAG, and let C1, . . . , C<sup>ℓ</sup> , ℓ ≥ 1, be the bucket decomposition of V in G (Definition 8). Further, let X and Y be nodes in G such that X ∈ C<sup>x</sup> and Y ∈ C<sup>y</sup> for some x, y ∈ {1, . . . , ℓ}, x ̸= y. If p = ⟨X = P0, . . . , P<sup>k</sup> = Y ⟩, k ≥ 1, is a proper possibly causal path from C<sup>x</sup> to C<sup>y</sup> in G, then G contains a subsequence of p that is a causal path from X to Y .

Proof of Lemma 32. Let p = ⟨X = P0, . . . , P<sup>k</sup> = Y ⟩, k ≥ 1, be a proper possibly causal path from C<sup>x</sup> to C<sup>y</sup> in G. Since p is proper, X is the only node in C<sup>x</sup> on p. Thus P<sup>1</sup> is the first node in the bucket C<sup>a</sup> where a ∈ {1, . . . , ℓ} \ {x}. By the definition of buckets and the fact that p is possibly causal, p contains X → P1. Then by Lemma 22, G contains X → A for all A ∈ Ca.

When Y ∈ Ca, G contains the subsequence X → Y and we are done. When Y /∈ Ca, define Pq, q ∈ {1, . . . , k}, to be the last node on p in Ca. Note that G contains X → P<sup>q</sup> and consider the node Pq+1. By Lemma 33, p(P1, Pq) is entirely contained in Ca. Thus, Pq+1 is the first node in the bucket C<sup>b</sup> where b ∈ {1, . . . , ℓ} \ {a, x}. By the definition of buckets and the fact that p is possibly causal, p contains P<sup>q</sup> → Pq+1. Then by Lemma 22, G contains P<sup>q</sup> → B for all B ∈ Cb.

When Y ∈ Cb, G contains the subsequence X → P<sup>q</sup> → Y and we are done. When Y /∈ Cb, we can continue in this way until we reach the first node in Cy—call it Pr+1. By the same logic as above, p must contain P<sup>r</sup> → Pr+1, where P<sup>r</sup> ∈/ C<sup>y</sup> and where G contains X → P<sup>q</sup> → · · · → Pr. So again by Lemma 22, G contains P<sup>r</sup> → W for all W ∈ C<sup>y</sup> and thus G contains the subsequence X → P<sup>q</sup> → · · · → P<sup>r</sup> → Y .

Lemma 33 Let G = (V, E) be an MPDAG, and let C1, . . . , Ck, k ≥ 1, be the bucket decomposition of V in G (Definition 8). If X, Y ∈ C<sup>i</sup> , i ∈ {1, . . . , k}, then there is no possibly causal path from X to Y in G containing nodes in V \ C<sup>i</sup> .

Proof of Lemma 33. For sake of contradiction, suppose that there is a possibly causal path from X to Y in G containing nodes in V\Ci—call this path p = ⟨X = P0, . . . , P<sup>u</sup> = Y ⟩, u ≥ 1. Let Ps, s ∈ {1, . . . , u − 1}, be an arbitrary node on p such that P<sup>s</sup> ∈ V \ C<sup>i</sup> . Let Pr, r ∈ {0, . . . , s − 1} be the node on p closest to P<sup>s</sup> such that P<sup>r</sup> ∈ C<sup>i</sup> . And let P<sup>t</sup> , t ∈ {s + 1, . . . , u} be the node on p closest to P<sup>s</sup> such that P<sup>t</sup> ∈ C<sup>i</sup> .

By the definition of P<sup>t</sup> , we have that Pt−<sup>1</sup> ∈/ C<sup>i</sup> and P<sup>t</sup> ∈ C<sup>i</sup> . Consider the edge between Pt−<sup>1</sup> and P<sup>t</sup> . Since C<sup>i</sup> is a maximal undirected connected subset of V, then p does not contain Pt−<sup>1</sup> − P<sup>t</sup> . Further since p is possibly causal, it does not contain Pt−<sup>1</sup> ← P<sup>t</sup> . Therefore p must contain Pt−<sup>1</sup> → P<sup>t</sup> . But then by Lemma 22, G must contain Pt−<sup>1</sup> → Pr, which contradicts that p is possibly causal.

Lemma 34 Let G = (V, E) be an MPDAG and let (C1, . . . , Ck), k ≥ 1, be an ordered bucket decomposition of V in G (Definition 2). Then for any i, j ∈ {1, . . . , k}, i < j, there is no possibly causal path from C<sup>j</sup> to C<sup>i</sup> in G.

Proof of Lemma 34. For sake of contradiction, let there be a possibly causal path from C<sup>j</sup> to C<sup>i</sup> in G. Choose a shortest such path p := ⟨P0, . . . , Pu⟩, u ≥ 1, and let S be the smallest collection of buckets in V such that every node on p is in one bucket in S. Consider the order in which p enters and exits each bucket in S. p begins in C<sup>j</sup> , but once it exits C<sup>j</sup> , it never returns. This holds by Lemma 33 and the fact that p is possibly causal. By the same logic, once p enters any other bucket in S, the first time it exits that bucket, it will never return. Thus, let Cℓ<sup>1</sup> , . . . , Cℓm, 1 < m ≤ k, be an arrangement of the buckets in S in order of their appearance on p.

Note that P<sup>0</sup> is the only node on p in C<sup>j</sup> by the choice of p as a shortest path. Therefore, p is a proper possibly causal path from C<sup>j</sup> to C<sup>i</sup> . It follows by Lemma 32 and the choice of p as a shortest path that p is causal. Based on the existence of this causal path, any partial causal ordering of V consistent with G must require Cℓ<sup>1</sup> < · · · < Cℓm. Since ℓ<sup>1</sup> = j and ℓ<sup>m</sup> = i by the definition of p, then any partial causal ordering of V consistent with G must require C<sup>j</sup> < C<sup>i</sup> . But this contradicts the definition of (C1, . . . , Ck) as an ordered bucket decomposition of V in G, where C<sup>i</sup> < C<sup>j</sup> .

Corollary 35 Let D be a node set in an MPDAG G and let (B1, . . . , Bk), k ≥ 1, be the output of P CO(D, G). Then for any i, j ∈ {1, . . . , k}, i < j, there is no possibly causal path from B<sup>j</sup> to B<sup>i</sup> in G.

Proof of Corollary 35. Let (C1, . . . , Cℓ), ℓ ≥ k, be the ordered bucket decomposition of V in G = (V, E) that matches the ordering of (B1, . . . , Bk) (see Remark 31). Let B<sup>i</sup> ∩ C<sup>m</sup> ̸= ∅ and B<sup>j</sup> ∩ C<sup>n</sup> ̸= ∅, where m, n ∈ {1, . . . , ℓ}. By construction, m < n. If there were a possibly causal path from B<sup>j</sup> ∈ B<sup>j</sup> to B<sup>i</sup> ∈ B<sup>i</sup> in G, then there would be a possibly causal path from B<sup>j</sup> ∈ C<sup>n</sup> to B<sup>i</sup> ∈ C<sup>m</sup> in G, which contradicts Lemma 34.

Corollary 36 Let G = (V, E) be an MPDAG and let (C1, . . . , Ck), k ≥ 1, be an ordered bucket decomposition of V in G. Then for any i, j ∈ {1, . . . , k}, i < j, there is no DAG in [G] with a causal path from C<sup>j</sup> to C<sup>i</sup> .

Proof of Corollary 36. For sake of contradiction, suppose there is a DAG in [G] with a causal path p from C<sup>j</sup> to C<sup>i</sup> . Then by Lemma 18, the path in G corresponding to p is possibly causal from C<sup>j</sup> to C<sup>i</sup> , which contradicts Lemma 34.

Corollary 37 Let D be a node set in an MPDAG G and let (B1, . . . , Bk), k ≥ 1, be the output of P CO(D, G). Then for any i, j ∈ {1, . . . , k}, i < j, there is no DAG in [G] with a causal path from B<sup>j</sup> to B<sup>i</sup> .

Proof of Corollary 37. For sake of contradiction, suppose there is a DAG in [G] with a causal path p from B<sup>j</sup> to B<sup>i</sup> . Then by Lemma 18, the path in G corresponding to p is possibly causal from B<sup>j</sup> to B<sup>i</sup> , which contradicts Corollary 35.

# D Proofs for Section 3.2: Identification Formula

This section includes the statement and proof of Lemma 38, which provides the core justification for the proof of Theorem 3 found in Section 3.2. Three supporting results needed for the proof of Lemma 38 follow.

### D.1 Main Result

Lemma 38 (Setup for Theorem 3) Let X, Y, and Z be pairwise disjoint node sets in a causal MPDAG G = (V, E), where Z ∩ PossDe(X, G) = ∅ and where there is no proper possibly causal path from X to Y that starts with an undirected edge in G. Let D = An(Y, GV\X) \ Z, let (B1, . . . , Bk) = PCO(D, G), k ≥ 1, and let B<sup>0</sup> = ∅. Then the following hold for every density f consistent with G, and every i ∈ {1, . . . , k}.

(i) If Z ∩ PossDe(B<sup>i</sup> , G) = ∅, then

$$
f(\mathbf{b_i}|\mathbf{b_{i-1}},\ldots,\mathbf{b_0},do(\mathbf{x}),\mathbf{z}) = f(\mathbf{b_i}|\mathrm{pa}(\mathbf{b_i},\mathcal{G}))
$$
\n(19)

for values pa(b<sup>i</sup> , G) of Pa(B<sup>i</sup> , G) that are in agreement with x. (ii) If Z ∩ PossDe(B<sup>i</sup> , G) ̸= ∅, then

$$
f(\mathbf{b}_i|\mathbf{b}_{i-1},\ldots,\mathbf{b}_0,do(\mathbf{x}),\mathbf{z}) = f(\mathbf{b}_i|\mathbf{b}_i^N,\mathbf{z}),
$$
\n(20)

where B<sup>N</sup> <sup>i</sup> = ∪ i−1 <sup>j</sup>=0B<sup>j</sup> \ PossDe(X, G).

Proof of Lemma 38. Let D be an arbitrary DAG in [G], let f be an arbitrary density consistent with G, and pick i ∈ {1, . . . , k}. Then let (C1, . . . , Cℓ), ℓ ≥ k, be the ordered bucket decomposition of V in G that matches the ordering of (B1, . . . , Bk) (see Remark 31). Further, let C<sup>n</sup> ∩ B<sup>i</sup> ̸= ∅, n ∈ {1, . . . , ℓ}, so that B<sup>i</sup> ⊆ C<sup>n</sup> and ∪ i−1 <sup>j</sup>=0B<sup>j</sup> ⊆ ∪n−<sup>1</sup> <sup>j</sup>=1 C<sup>j</sup> .

PART (i) Note that this result is analogous to Lemma D.1 of Perkovi´c (2020) for the unconditional causal effect setting. Start by defining the following sets.

$$
\begin{aligned} \mathbf{P_i} = & (\cup_{j=0}^{i-1} \mathbf{B_j} \cup \mathbf{Z}) \cap \mathrm{Pa}(\mathbf{B_i}, \mathcal{G}). & \mathbf{X_{p_i}} = \mathbf{X} \cap \mathrm{Pa}(\mathbf{B_i}, \mathcal{G}). \\ \mathbf{N_i} = & (\cup_{j=0}^{i-1} \mathbf{B_j} \cup \mathbf{Z}) \setminus \mathrm{Pa}(\mathbf{B_i}, \mathcal{G}). & \mathbf{X_{n_i}} = \mathbf{X} \setminus \mathrm{Pa}(\mathbf{B_i}, \mathcal{G}). \\ & \mathbf{X'_{n_i}} = \mathbf{X_{n_i}} \setminus \mathrm{An}(\mathbf{P_i}, \mathcal{D}_{\overline{\mathbf{X_{p_i}}}}). \end{aligned}
$$

We show the result in the three steps below.

$$
f(\mathbf{b_i}|\mathbf{b_{i-1}},\ldots,\mathbf{b_0},do(\mathbf{x}),\mathbf{z}) = f(\mathbf{b_i}|\mathbf{p_i},do(\mathbf{x}))
$$
\n(21)

$$
= f(\mathbf{b_i}|\mathbf{p_i}, do(\mathbf{x_{p_i}}))
$$
\n(22)

$$
= f(\mathbf{b_i} | \operatorname{pa}(\mathbf{b_i}, \mathcal{G})). \tag{23}
$$

In order to use Rules 1, 3, and 2 of the do calculus (Theorem 10) to show the equalities in (21), (22), and (23), respectively, we must show the following.

$$
(\mathbf{B}_{\mathbf{i}} \perp_d \mathbf{N}_{\mathbf{i}} \, |\mathbf{X}, \mathbf{P}_{\mathbf{i}})_{\mathcal{D}_{\overline{\mathbf{X}}}}.\tag{24}
$$

$$
(\mathbf{B}_{\mathbf{i}} \perp_d \mathbf{X}_{\mathbf{n}_{\mathbf{i}}} |\mathbf{X}_{\mathbf{p}_{\mathbf{i}}}, \mathbf{P}_{\mathbf{i}})_{\mathcal{D}_{\overline{\mathbf{X}_{\mathbf{p}_{\mathbf{i}}}\mathbf{X}'_{\mathbf{n}_{\mathbf{i}}}}}.
$$
\n(25)

$$
(\mathbf{B_i} \perp_d \mathbf{X_{p_i}} | \mathbf{P_i})_{\mathcal{D}_{\mathbf{X_{p_i}}}}.\t(26)
$$

We first show a broader independence claim and complete the proof by showing that each of the independence statements above is a special case of the broader claim.

Broader Claim: Define the sets N, H, X′ , and N′ such that N, H, X′ , B<sup>i</sup> , and P<sup>i</sup> are pairwise disjoint and such that the following hold.

$$
N \subseteq N_i \cup X_{n_i} = (\bigcup_{j=1}^{i-1} B_j \cup Z \cup X) \setminus Pa(B_i, \mathcal{G}).
$$
  
\n
$$
H \subseteq X_{p_i} = X \cap Pa(B_i, \mathcal{G}).
$$
  
\n
$$
X' \subseteq X.
$$
  
\n
$$
N' \subseteq X_{n_i} \setminus An(P_i, \mathcal{D}_{\overline{X'}}).
$$
  
\n
$$
Pa(B_i, \mathcal{G}) \subseteq X' \cup P_i \cup H.
$$
  
\n
$$
N \setminus N' \subseteq \bigcup_{j=1}^{n-1} C_j \cup Z.
$$
  
\n(27)

The broader claim we will show is

$$
(\mathbf{B}_{\mathbf{i}} \perp_d [\mathbf{N} \cup \mathbf{H}] |\mathbf{X}', \mathbf{P}_{\mathbf{i}})_{\mathcal{D}_{\overline{\mathbf{X}'\mathbf{N}'\mathbf{H}}}}.\tag{28}
$$

Before beginning the proof of this broader claim, note that from the assumptions above, we also have the following.

There is no possibly causal path in 
$$
G
$$
 from  
\n $\mathbf{B_i}$  to  $(\mathbf{N} \cup \mathbf{H} \cup \mathbf{P_i}) \setminus \mathbf{N'}$ .

To see this, note that H ⊆ X ∩ Pa(B<sup>i</sup> , G), and by Lemmas 34 and 40(i), -X ∩ Pa(B<sup>i</sup> , G) ∩ ∪ ℓ <sup>j</sup>=<sup>n</sup> C<sup>j</sup> = ∅. Thus, H ⊆ ∪n−<sup>1</sup> <sup>j</sup>=1 C<sup>j</sup> . Then by (27) and the definition of P<sup>i</sup> , we have N ∪ H ∪ P<sup>i</sup> \ N′ ⊆ ∪n−<sup>1</sup> <sup>j</sup>=1 C<sup>j</sup> ∪ Z. The result follow by the fact that B<sup>i</sup> ⊆ Cn, Lemma 34, and the fact that Z ∩ PossDe(B<sup>i</sup> , G) = ∅.

We turn to prove the broader claim using a strategy similar to that of the proof of Lemma D.1 of Perkovi´c (2020). For sake of contradiction, suppose that there is a path from <sup>B</sup><sup>i</sup> to <sup>N</sup> <sup>∪</sup> <sup>H</sup> in <sup>D</sup>X′N′<sup>H</sup> that is d-connecting given <sup>X</sup>′ <sup>∪</sup> <sup>P</sup><sup>i</sup> . Let p = ⟨B<sup>i</sup> , . . . , N⟩, B<sup>i</sup> ∈ B<sup>i</sup> , N ∈ N ∪ H, be a shortest such path, and let p <sup>∗</sup> be the corresponding path in G.

Consider when p begins with an arrow out of B<sup>i</sup> . If p were causal, then N /∈ N′ since p is in DX′N′H. Further, the corresponding path in D would also be causal, which by Lemma 18 would imply that p ∗ is a possibly causal path from B<sup>i</sup> to N ∪ H \ N′ . But this contradicts (∗). Thus, let C be the closest collider to B<sup>i</sup> on p. Since p is d-connecting given X′ ∪ P<sup>i</sup> in DX′N′H, then C ∈ An(P<sup>i</sup> , DX′N′H). But this implies that there is a causal path in DX′N′H—and therefore in D—from B<sup>i</sup> to P<sup>i</sup> . By Lemma 18, the corresponding path in G is possibly causal, which again contradicts (∗).

Consider next when p begins with B<sup>i</sup> ← A. By choice of p, A /∈ B<sup>i</sup> and so A ∈ Pa(B<sup>i</sup> , DX′N′H). But A /∈ Pa(B<sup>i</sup> , G), since Pa(B<sup>i</sup> , G) ⊆ X′ ∪ P<sup>i</sup> ∪ H and p is d-connecting given X′ ∪P<sup>i</sup> in DX′N′H. Thus, p <sup>∗</sup> begins with B<sup>i</sup> −A. If p <sup>∗</sup> were undirected, then N ∈ C<sup>n</sup> and so N /∈ H ⊆ ∪n−<sup>1</sup> <sup>j</sup>=1 C<sup>j</sup> . Thus by Lemma 39(ii), p <sup>∗</sup> would be a possibly causal path from B<sup>i</sup> to N ∈ N and (−p ∗ ) would be a possibly causal path from N ∈ N to B<sup>i</sup> . The former contradicts (∗) when N ∈ N \ N′ . The latter contradicts Lemma 40(i) when N ∈ N′ ⊆ X.

Since p <sup>∗</sup> must contain a directed edge, let T be the node closest to B<sup>i</sup> on p ∗ such that p ∗ (T, N) starts with such an edge. Let S and U be the nodes on p ∗ immediately preceding and following T, respectively. Note that T /∈ H by choice of p.

Consider when p ∗ contains T → U. Note that p(T, N) also contains T → U. When p(T, N) contains at least one collider, then by Lemma 39(iv), G contains a causal path from T to P<sup>i</sup> . When instead p(T, N) is causal, then N /∈ N′ since p is in DX′N′H. Thus by Lemma 39(iii), G contains a causal path from T to N ∪ H \ N′ . In either case, G contains a causal path from T to N ∪ H ∪ P<sup>i</sup> \ N′ . Since G also contains p ∗ (B<sup>i</sup> , T)—which is possibly causal by Lemma 39(ii) and the fact that T /∈ H—then by Lemma 26, G contains a possibly causal path from B<sup>i</sup> ∈ B<sup>i</sup> to N ∪ H ∪ P<sup>i</sup> \ N′ , which contradicts (∗).

Finally, consider when p ∗ contains T ← U. Then by R1 of Meek (1995), G—and therefore D—contains the edge ⟨S, U⟩. Note that D also contains T ← U. By Lemma 39(i), the path in D corresponding to p(B<sup>i</sup> , T) cannot contain colliders on the path in D corresponding to p. Thus, D contains S ← T ← U and therefore S ← U. Further since DX′N′<sup>H</sup> must also contain <sup>S</sup> <sup>←</sup> <sup>T</sup> <sup>←</sup> <sup>U</sup>, then S /<sup>∈</sup> <sup>X</sup>′ <sup>∪</sup> <sup>N</sup>′ and U /<sup>∈</sup> <sup>H</sup>, and so <sup>D</sup>X′N′<sup>H</sup> contains <sup>S</sup> <sup>←</sup> <sup>U</sup>. But then p(B<sup>i</sup> , S) ⊕ ⟨S, U⟩ ⊕ p(U, N) contradicts the choice of p.

Special Cases: With the broader claim shown, we now complete the proof by showing that the independence statements in (24), (25), and (26) are special cases of (28).

(24) Let N = N<sup>i</sup> , H = ∅, X′ = X, and N′ = ∅. Since X, Z, and D are pairwise disjoint, then N, X′ , B<sup>i</sup> , and P<sup>i</sup> are pairwise disjoint by definition. Clearly, N ⊆ N<sup>i</sup> ∪ Xn<sup>i</sup> and X′ ⊆ X. Then note that Pa(B<sup>i</sup> , G) = Xp<sup>i</sup> ∪ P<sup>i</sup> ⊆ X′ ∪ P<sup>i</sup> ∪ H. Finally, note that N \ N′ = N<sup>i</sup> , where N<sup>i</sup> ⊆ ∪i−<sup>1</sup> <sup>j</sup>=1B<sup>j</sup> <sup>∪</sup> <sup>Z</sup> ⊆ ∪n−<sup>1</sup> <sup>j</sup>=1 C<sup>j</sup> ∪ Z by definition.

(25) Let N = Xn<sup>i</sup> , H = ∅, X′ = Xp<sup>i</sup> , and N′ = X′ ni . Since X, Z, and D are pairwise disjoint, then N, X′ , B<sup>i</sup> , and P<sup>i</sup> are pairwise disjoint by definition. Clearly, N ⊆ N<sup>i</sup> ∪ Xn<sup>i</sup> and X′ ⊆ X. Further, N′ = Xn<sup>i</sup> \ An(P<sup>i</sup> , <sup>D</sup>Xpi ) ⊆ Xn<sup>i</sup> \ An(P<sup>i</sup> , DX′). Then note that Pa(B<sup>i</sup> , G) = Xp<sup>i</sup> ∪ P<sup>i</sup> ⊆ X′ ∪ P<sup>i</sup> ∪ H.

Finally, to see that N \ N′ ⊆ ∪n−<sup>1</sup> <sup>j</sup>=1 C<sup>j</sup> , let N be an arbitrary node in N \ N′ = Xn<sup>i</sup> ∩ An(P<sup>i</sup> , <sup>D</sup>Xpi ). This implies that there is a causal path in <sup>D</sup>Xpi from N to some P<sup>i</sup> ∈ P<sup>i</sup> ⊆ Pa(B<sup>i</sup> , G). This path is also in D, and thus by Lemma 18, its corresponding path in G is possibly causal from N to Pa(B<sup>i</sup> , G). Therefore by Lemma 26, there is a possibly causal path in G from N to B<sup>i</sup> . Since B<sup>i</sup> ⊆ Cn, then N /∈ ∪<sup>k</sup> <sup>j</sup>=n+1C<sup>j</sup> by Lemma 34. Further, since N ∈ X and B<sup>i</sup> ⊆ D, then N /∈ C<sup>n</sup> by Lemma 40(i).

(26) Let N = ∅, H = Xp<sup>i</sup> , X′ = ∅, and N′ = ∅. Since X, Z, and D are pairwise disjoint, then H, B<sup>i</sup> , and P<sup>i</sup> are pairwise disjoint by definition. Clearly, H ⊆ Xp<sup>i</sup> . Then note that Pa(B<sup>i</sup> , G) = Xp<sup>i</sup> ∪ P<sup>i</sup> ⊆ X′ ∪ P<sup>i</sup> ∪ H. Finally, note that N \ N′ = ∅ ⊆ ∪n−<sup>1</sup> <sup>j</sup>=1 C<sup>j</sup> ∪ Z.

PART (ii) Let B<sup>D</sup> <sup>i</sup> = ∪ i−1 <sup>j</sup>=0B<sup>j</sup> ∩ PossDe(X, G). We show the result in the steps below.

$$
f(\mathbf{b}_{i}|\mathbf{b}_{i-1},\ldots,\mathbf{b}_{0},do(\mathbf{x}),\mathbf{z}) = f(\mathbf{b}_{i}|\mathbf{b}_{i}^{\mathbf{N}},do(\mathbf{x}),\mathbf{z})
$$
\n(29)

$$
= f(\mathbf{b_i}|\mathbf{b_i^N}, \mathbf{z}).
$$
\n(30)

In order to use Rules 1 and 3 of the do calculus (Theorem 10) to show the equalities in (29) and (30), respectively, we must show the following.

$$
(\mathbf{B}_{\mathbf{i}} \perp_d \mathbf{B}_{\mathbf{i}}^{\mathbf{D}} | \mathbf{X}, \mathbf{Z}, \mathbf{B}_{\mathbf{i}}^{\mathbf{N}})_{\mathcal{D}_{\overline{\mathbf{X}}}}.\tag{31}
$$

$$
(\mathbf{B}_{\mathbf{i}} \perp_d \mathbf{X} \ | \mathbf{B}_{\mathbf{i}}^{\mathbf{N}}, \mathbf{Z})_{\mathcal{D}_{\overline{\mathbf{W}}}},\tag{32}
$$

where we let W = X \ An(B<sup>N</sup> <sup>i</sup> ∪ Z, D). We prove these independencies below.

(31) Suppose for sake of contradiction that there is a path in D<sup>X</sup> from B<sup>i</sup> to B<sup>D</sup> i that is d-connecting given X ∪ Z ∪ B<sup>N</sup> i . Let q = ⟨B<sup>i</sup> = Q0, . . . , Q<sup>m</sup> = B<sup>D</sup> i ⟩, m ≥ 1, be a shortest such path and let q <sup>∗</sup> be the corresponding path in G. Further, let Ch, h ∈ {1, . . . , n − 1}, be the bucket in V such that B<sup>D</sup> <sup>i</sup> ∈ Ch.

Before beginning the proof, note the following.

There is no causal path in D<sup>X</sup> from (∗∗)

C<sup>h</sup> to B<sup>i</sup> ∪ Z ∪ B N i .

To see this, suppose for sake of contradiction that such a path p did exist, and let p <sup>∗</sup> be the corresponding path in G. Since the corresponding path in D is also causal, then by Lemma 18, p ∗ is a possibly causal path from C<sup>h</sup> to B<sup>i</sup> ∪ Z ∪ B<sup>N</sup> i , where by Lemma 40(i), C<sup>h</sup> ⊆ De(X, G). Thus by Lemma 26, G contains a possibly causal path from X to B<sup>i</sup> ∪ Z ∪ B<sup>N</sup> i . But by assumption, definition, and Lemma 40(ii), (B<sup>i</sup> ∪ Z ∪ B<sup>N</sup> i )∩PossDe(X, G) = ∅. With the claim shown, we turn to find a contradiction in the two cases below.

Case 1: Consider when q contains Qm−<sup>1</sup> ← B<sup>D</sup> i . Note that (−q) cannot be causal from B<sup>D</sup> <sup>i</sup> ∈ C<sup>h</sup> to B<sup>i</sup> ∈ B<sup>i</sup> by (∗∗) and therefore, must contain a collider. Let L be the set containing the collider closest to B<sup>D</sup> i on q and all of its descendants in DX. Since q is d-connecting given X ∪ Z ∪ B<sup>N</sup> i in DX, then L must contain an element in Z ∪ B<sup>N</sup> i . But since L ⊆ De(Ch, DX), this contradicts (∗∗).

Case 2: Consider instead when q contains Qm−<sup>1</sup> → B<sup>D</sup> i . Note that q is not causal from B<sup>i</sup> ∈ C<sup>n</sup> to B<sup>D</sup> <sup>i</sup> ∈ Ch, since otherwise the corresponding path in D would also be causal, which would contradict Corollary 36. Thus, q contains a node Qc, c ∈ {1, . . . , m − 1}, such that q contains Qc−<sup>1</sup> ← Q<sup>c</sup> → · · · → B<sup>D</sup> i . Let Ce, e ∈ {1, . . . , n − 1}, be the bucket in V such that Q<sup>c</sup> ∈ Ce.

For sake of contradiction, suppose e ̸= h. That is, Q<sup>c</sup> and B<sup>D</sup> i are in the distinct buckets C<sup>e</sup> and Ch, respectively. Define Qd, where d ∈ {1, . . . , m − 1}, d ≥ c, to be the last node on q in Ce. Note that since q(Qd, B<sup>D</sup> i ) is causal, the corresponding path in D is also causal. Therefore, by Lemma 18, q ∗ (Qd, B<sup>D</sup> i ) is a proper possibly causal path from C<sup>e</sup> to C<sup>h</sup> and so by Lemma 32, G contains at least one subsequence of q ∗ (Qd, B<sup>D</sup> i ) that is causal from Q<sup>d</sup> to B<sup>D</sup> i . Let r <sup>∗</sup> be an arbitrary such path.

Note that since q is d-connecting given X∪Z∪B<sup>N</sup> i , no node on q(Qd, B<sup>D</sup> i )—and therefore no node on r <sup>∗</sup>—is in X. That is, r ∗ is a causal path in G from Q<sup>d</sup> to B<sup>D</sup> <sup>i</sup> ∈ An(Y, GV\X) \Z that does not contain any nodes in X. Thus, Q<sup>d</sup> ∈ Z ∪D. By the same logic, Q<sup>d</sup> ∈/ Z ∪ B<sup>N</sup> i , and further, by the choice of q as a shortest path, Q<sup>d</sup> ∈/ B<sup>D</sup> i . But this implies that Q<sup>d</sup> ∈ ∪ k <sup>j</sup>=iB<sup>j</sup> , which contradicts Corollary 35.

Note that we have shown q contains Qc−<sup>1</sup> ← Qc, where Q<sup>c</sup> ∈ Ch. We can derive our final contradictions by using identical logic to that of Case 1 above.

(32) Note that by Lemma 28, De(X, D) ⊆ PossDe(X, G). From this and since (B<sup>N</sup> <sup>i</sup> ∪Z)∩ PossDe(X, G) = ∅, it follows that (B<sup>N</sup> <sup>i</sup> ∪ Z) ∩ De(X, D) = ∅ and thus W = X. Therefore, we want to show (B<sup>i</sup> ⊥<sup>d</sup> X|B<sup>N</sup> i , Z)D<sup>X</sup> .

Let p be an arbitrary path in D<sup>X</sup> from X ∈ X to B<sup>i</sup> ∈ B<sup>i</sup> . By the definition of DX, p begins with X →. But note that p cannot be causal, since this would imply that B<sup>i</sup> ∈ De(X, D) ⊆ PossDe(X, G), which would contradict Lemma 40(ii). Thus, p must have at least one collider.

Let S be the set containing the collider that is closest to X on p and all of its descendants in DX. Since S ⊆ De(X, DX) ⊆ De(X, D) ⊆ PossDe(X, G) and since (B<sup>N</sup> <sup>i</sup> ∪ Z) ∩ PossDe(X, G) = ∅, then p must be d-separated given B<sup>N</sup> <sup>i</sup> ∪ Z.

#### D.2 Supporting Results

Lemma 39 (Setup for Proof of Lemma 38(i)) Let N, H, X′ , B, and P be pairwise disjoint node sets in an MPDAG G = (V, E), and let D be a DAG in [G]. Suppose there is a path from <sup>B</sup> to <sup>N</sup> <sup>∪</sup> <sup>H</sup> that is d-connecting given <sup>X</sup>′ <sup>∪</sup> <sup>P</sup> in <sup>D</sup>X′N′H, where <sup>N</sup>′ is a node set in <sup>G</sup> such that <sup>N</sup>′ <sup>⊆</sup> <sup>N</sup> and <sup>N</sup>′ <sup>∩</sup> An(P, <sup>D</sup>X′) = <sup>∅</sup>. Let <sup>p</sup><sup>1</sup> <sup>=</sup> ⟨B, . . . , N⟩, <sup>B</sup> <sup>∈</sup> <sup>B</sup>, N ∈ N ∪ H, be a shortest such path, and let p <sup>∗</sup> and p<sup>2</sup> be the corresponding paths in G and D, respectively. Finally, let q<sup>1</sup> = ⟨Q0, . . . , Qk⟩, k ≥ 1, be a subpath of p1, and let q <sup>∗</sup> and q<sup>2</sup> be the corresponding paths in G and D, respectively.

- (i) If q ∗ is undirected, then q<sup>2</sup> does not contain a collider on p2.
- (ii) If q ∗ is undirected and Q<sup>k</sup> ∈/ H, then q <sup>∗</sup> and (−q ∗ ) are possibly causal.
- (iii) If q<sup>1</sup> is causal and q ∗ begins with Q<sup>0</sup> → Q1, then q ∗ is causal.
- (iv) If q<sup>1</sup> contains at least one collider and q ∗ begins with Q<sup>0</sup> → Q1, then G contains a causal path from Q<sup>0</sup> to P.

Proof of Lemma 39. Let Q−<sup>1</sup> designate the node immediately preceding Q<sup>0</sup> on p<sup>1</sup> when Q<sup>0</sup> ̸= B, and let Qk+1 designate the node immediately following Q<sup>k</sup> on p<sup>1</sup> when Q<sup>k</sup> ̸= N.

(i) Let q <sup>∗</sup> be undirected. For sake of contradiction, suppose that q<sup>2</sup> contains a collider on p<sup>2</sup> at some node Q<sup>j</sup> , 0 ≤ j ≤ k. But since q ∗ is undirected in G, then Q<sup>j</sup> is not a collider on p ∗ . Thus by properties of MPDAGs, G—and therefore D—must contain an edge ⟨Qj−1, Qj+1⟩. We show below that this edge also exists in DX′N′H.

Note that Q<sup>j</sup> is also a collider on p1. Since p<sup>1</sup> is d-connecting given X′ ∪P, then Q<sup>j</sup> and therefore <sup>Q</sup>j−<sup>1</sup> and <sup>Q</sup>j+1 are in An(P, <sup>D</sup>X′N′H) <sup>⊆</sup> An(P, <sup>D</sup>X′). So since <sup>N</sup>′ <sup>∩</sup> An(P, <sup>D</sup>X′) = ∅, then Qj−1, Qj+1 ∈/ N′ . Further, since Qj−<sup>1</sup> and Qj+1 are not colliders on p1, they cannot be nodes in X′ (or P). Finally, since DX′N′<sup>H</sup> contains Qj−<sup>1</sup> → Q<sup>j</sup> ← Qj+1, then Qj−1, Qj+1 ∈/ H. Therefore DX′N′<sup>H</sup> must also contain an edge ⟨Qj−1, Qj+1⟩.

Define the path m<sup>1</sup> = p1(B, Qj−1) ⊕ ⟨Qj−1, Qj+1⟩ ⊕ p1(Qj+1, N) in DX′N′H. By the choice of p1, m<sup>1</sup> must be blocked given X′ ∪ P. Since Qj−1, Qj+1 ∈/ X′ ∪ P, then m<sup>1</sup> must be blocked given X′ ∪ P by a collider at Qj−<sup>1</sup> or Qj+1. But this contradicts that Qj−1, Qj+1 ∈ An(P, DX′N′H).

(ii) Let q <sup>∗</sup> be undirected and Q<sup>k</sup> ∈/ H. We show that q ∗ is possibly causal. The proof for (−q ∗ ) follows analogous logic. Note that by part (i), q<sup>2</sup> does not contain a collider on p2, and therefore, q<sup>1</sup> does not contain a collider on p1.

For sake of contradiction, suppose that q ∗ is non-causal. Then there exists an edge Q<sup>g</sup> ← Q<sup>h</sup> in G—and therefore in D—for some g, h ∈ {0, . . . , k}, h > g + 1. To see that DX′N′<sup>H</sup> also contains Q<sup>g</sup> ← Qh, note that Q<sup>h</sup> ∈/ H by assumption and choice of p1. Additionally, Q<sup>g</sup> ∈/ X′ ∪ N′ , since q<sup>2</sup> does not contain a collider on p<sup>2</sup> and D does not contain a cycle, which implies that D—and therefore DX′N′H– must contain Q<sup>g</sup> ← Qg+1.

Define a path u<sup>1</sup> = p1(B, Qg) ⊕ ⟨Qg, Qh⟩ ⊕ p1(Qh, N) in DX′N′H. By the choice of p1, u<sup>1</sup> must be blocked given X′ ∪ P at Q<sup>g</sup> or Qh. However, note that since q<sup>1</sup> cannot contain colliders on p1, then Q<sup>g</sup> and Q<sup>h</sup> are non-colliders on p1. Further, since DX′N′<sup>H</sup> contains Q<sup>g</sup> ← Q<sup>h</sup> and Q<sup>g</sup> ← Qg+1, then Q<sup>g</sup> and Q<sup>h</sup> are also non-colliders on u1. So if u<sup>1</sup> is blocked given X′ ∪ P at Q<sup>g</sup> or Qh, then so is p1, which is a contradiction.

(iii) Let q<sup>1</sup> be causal and let q <sup>∗</sup> begin with Q<sup>0</sup> → Q1. Note that q<sup>2</sup> is also causal. Suppose for sake of contradiction that q ∗ is shielded. That is, G—and therefore D—contains at least one edge ⟨Qd, Qd+2⟩ for some d ∈ {0, . . . , k − 2}. Since q<sup>2</sup> is causal, D must contain Q<sup>d</sup> → Qd+2. Further, because DX′N′<sup>H</sup> contains Q<sup>d</sup> → Qd+1 → Qd+2, then Qd+2 ∈/ <sup>X</sup>′ <sup>∪</sup> <sup>N</sup>′ and <sup>Q</sup><sup>d</sup> <sup>∈</sup>/ <sup>H</sup>, and so <sup>D</sup>X′N′<sup>H</sup> must also contain <sup>Q</sup><sup>d</sup> <sup>→</sup> <sup>Q</sup>d+2. But then the path p1(B, Qd) ⊕ ⟨Qd, Qd+2⟩ ⊕ p1(Qd+2, N) contradicts the choice of p1. Thus, q ∗ is unshielded.

Since q<sup>2</sup> is causal, q ∗ can only contain edges of the form Q<sup>i</sup> − Qi+1 and Q<sup>i</sup> → Qi+1 for all i ∈ {0, . . . , k − 1}. Since additionally q <sup>∗</sup> begins with Q<sup>0</sup> → Q<sup>1</sup> and is unshielded, the result follows by R1 of Meek (1995).

(iv) Let q<sup>1</sup> contain at least one collider and q <sup>∗</sup> begin with Q<sup>0</sup> → Q1. Note that q<sup>1</sup> also begins with Q<sup>0</sup> → Q1. Then let T<sup>0</sup> be the closest collider to Q<sup>0</sup> on q1. Note that T<sup>0</sup> is also a collider on <sup>p</sup>1. Since <sup>p</sup><sup>1</sup> is d-connecting given <sup>X</sup>′ <sup>∪</sup> <sup>P</sup> in <sup>D</sup>X′N′H, then <sup>T</sup><sup>0</sup> <sup>∈</sup> An(P, <sup>D</sup>X′N′H). Thus let t<sup>1</sup> = ⟨T0, . . . , Tw⟩, w ≥ 0, T<sup>w</sup> ∈ P, be a shortest causal path in DX′N′<sup>H</sup> from T<sup>0</sup> to P, and let t <sup>∗</sup> and t<sup>2</sup> be the corresponding paths in G and D, respectively.

Note that q1(Q0, T0) is causal, and therefore, by part (iii), the subpath q ∗ (Q0, T0) is causal. We want to show that there is a causal path from Q<sup>0</sup> to T<sup>w</sup> in G. If t ∗ is causal, then q ∗ (Q0, T0) ⊕ t ∗ is such a path and we are done.

Consider when t ∗ is not causal, and focus on the nodes adjacent to T<sup>0</sup> on q1. Let S be the node immediately preceding and U the node immediately following T<sup>0</sup> on q1. Note that since S and U are non-colliders on p<sup>1</sup> and p<sup>1</sup> is d-connecting given X′ ∪ P, then S, U /<sup>∈</sup> <sup>X</sup>′ <sup>∪</sup> <sup>P</sup>. Also since <sup>D</sup>X′N′<sup>H</sup> contains <sup>S</sup> <sup>→</sup> <sup>T</sup><sup>0</sup> <sup>←</sup> <sup>U</sup>, then S, U /<sup>∈</sup> <sup>H</sup>. Further since <sup>T</sup><sup>0</sup> <sup>∈</sup> An(P, <sup>D</sup>X′N′H), then S, U <sup>∈</sup> An(P, <sup>D</sup>X′N′H) <sup>⊆</sup> An(P, <sup>D</sup>X′). Therefore, S, U /<sup>∈</sup> <sup>N</sup>′ . Putting this together, we have that S, U /∈ X′ ∪ P ∪ H ∪ N′ .

For sake of contradiction, suppose ⟨S, T0, U⟩ is shielded in G—and therefore in D. Since S, U /<sup>∈</sup> <sup>X</sup>′ <sup>∪</sup> <sup>N</sup>′ <sup>∪</sup> <sup>H</sup>, then <sup>D</sup>X′N′<sup>H</sup> also contains ⟨S, U⟩. Define a path <sup>m</sup><sup>1</sup> <sup>=</sup> <sup>p</sup>1(B, S) <sup>⊕</sup> ⟨S, U⟩ ⊕ <sup>p</sup>(U, N) in <sup>D</sup>X′N′H. By the choice of <sup>p</sup>1, <sup>m</sup><sup>1</sup> must be blocked given <sup>X</sup>′ <sup>∪</sup> <sup>P</sup>. Since S, U /<sup>∈</sup> <sup>X</sup>′ <sup>∪</sup> <sup>P</sup>, then either <sup>S</sup> or <sup>U</sup> must be a collider on <sup>m</sup><sup>1</sup> that is not in An(P, <sup>D</sup>X′N′H), which is a contradiction. Thus, ⟨S, T0, U⟩ is unshielded in G. Since D must also contain S → T<sup>0</sup> ← U, then by properties of MPDAGs, so does G.

Turn to consider t ∗ . Suppose for sake of contradiction that G—and therefore D contains at least one edge ⟨T<sup>f</sup> , Tf+2⟩ for some f ∈ {0, . . . , w − 2}. Note that t<sup>2</sup> is causal, and so D must contain T<sup>f</sup> → Tf+2. Since DX′N′<sup>H</sup> contains an edge into and out of each node on <sup>t</sup><sup>1</sup> except for <sup>T</sup><sup>w</sup> <sup>∈</sup> <sup>P</sup>, then no node on <sup>t</sup><sup>1</sup> is in <sup>X</sup>′∪N′∪<sup>H</sup> and so <sup>D</sup>X′N′<sup>H</sup> must also contain T<sup>f</sup> → Tf+2. But then the path t1(T0, T<sup>f</sup> ) ⊕ ⟨T<sup>f</sup> , Tf+2⟩ ⊕ t1(Tf+2, Tw) contradicts the choice of t1, and thus, t ∗ is unshielded.

Next, define a node Tv, v ∈ {0, . . . , w}, as follows. When t ∗ is entirely undirected, let T<sup>v</sup> = Tw. Otherwise, let T<sup>v</sup> be the first node on t ∗ followed by a directed arrow. Note that since t<sup>2</sup> is causal, t ∗ can only contain edges of the form T<sup>i</sup> − Ti+1 or T<sup>i</sup> → Ti+1 for i ∈ {0, . . . , w−1}. Thus, when T<sup>v</sup> ̸= Tw, t ∗ contains T<sup>v</sup> → Tv+1. Then since t ∗ is unshielded, by R1 of Meek (1995), t ∗ takes the form T<sup>0</sup> − · · · − T<sup>v</sup> → · · · → Tw.

We now show that G contains the edge S → Tv, which will make q ∗ (Q0, S) ⊕ ⟨S, Tv⟩ ⊕ t ∗ (Tv, Tw) a causal path in G from Q<sup>0</sup> to P. We have already shown that G and D contain S → T<sup>0</sup> ← U. For sake of induction, suppose that G—and therefore D—contains S → T<sup>d</sup> ← U for some d ∈ {0, . . . , v−1}. Since G contains the paths S → Td−Td+1 and U → Td−Td+1, then G—and therefore D—must contain the edges ⟨S, Td+1⟩ and ⟨U, Td+1⟩ by R1 of Meek (1995). Since D contains S → T<sup>0</sup> → · · · → Td+1 and U → T<sup>0</sup> → · · · → Td+1, it must also contain S → Td+1 ← U. Then because ⟨S, T0, U⟩ is unshielded in G, so is ⟨S, Td+1, U⟩. Thus, by properties of MPDAGs, G must also contain S → Td+1 ← U.

Lemma 40 (Setup for Proof of Lemma 38) Let X, Y, and Z be pairwise disjoint node sets in an MPDAG G = (V, E), where Z ∩ PossDe(X, G) = ∅ and where there is no proper possibly causal path from X to Y that starts with an undirected edge in G. Further, let D = An(Y, GV\X) \ Z.

- (i) Let X ∈ X, D ∈ D ∩ PossDe(X, G), and C<sup>d</sup> be the bucket in V such that D ∈ Cd. Then C<sup>d</sup> ⊆ De(X, G).
- (ii) Let (B1, . . . , Bk) = PCO(D, G), k ≥ 1, and let i ∈ {1, . . . , k} such that Z∩PossDe(B<sup>i</sup> , G) ̸= ∅. Then B<sup>i</sup> ∩ PossDe(X, G) = ∅.

#### Proof of Lemma 40.

(i) We start by showing that D ∈ De(X, G). To see this, pick an arbitrary possibly causal path in G from X to D, and let p = ⟨X = P0, . . . , P<sup>r</sup> = D⟩, r ≥ 1, be a shortest subsequence in G of that path. By Lemma 24, p is a possibly causal, unshielded path from X to D. Since D ⊆ An(Y, GV\X), then by Lemma 23, there is no proper possibly causal path from X to D that starts with an undirected edge in G, and so p must contain P<sup>0</sup> → P1. Then by R1 of Meek (1995), p takes the form P<sup>0</sup> → · · · → Pr.

Now suppose for sake of contradiction that X ∈ Cd. Let X′ be the last node on p in X, and let H be the node on p immediately following X′ . That is, G contains X → · · · → X′ → H → · · · → D, where it may be that X′ = X and H = D. Note that by Lemma 33, p is entirely contained in C<sup>d</sup> and so X′ , H ∈ Cd.

By the definition of C<sup>d</sup> as a bucket in V, G must contain an undirected path from X′ to H. Let u = ⟨X′ = U0, . . . , U<sup>r</sup> = H⟩, r ≥ 2 be a shortest such path. We show by induction that G contains X′ → U<sup>c</sup> for all c ∈ {2, . . . , r}. We already have that G contains X′ → Ur. So suppose G contains X′ → Ud+1 for some d ∈ {2, . . . , r − 1}. Since G contains X′ → Ud+1 − Ud, G must contain an edge ⟨X′ , Ud⟩. By the choice of u, G cannot contain X′ − Ud. Neither can G contain X′ ← Ud, since by R2 of Meek (1995) this would force u to contain U<sup>d</sup> → Ud+1. Therefore G contains X′ → Ud.

Turn to note that, by definition of H, p(H, D) is a causal path with no nodes in X, where D ∈ An(Y, GV\X) \ Z. Thus, G contains a causal path from H to Y with no nodes in X. Since G contains X′ → H and Z ∩ PossDe(X, G) = ∅, then H /∈ Z. Thus, H ∈ D, and by Lemma 23, there is no proper possibly causal path from X to H in G that starts with an undirected edge. Note that u may not be proper, but there is a subpath of u that is a proper path from X to H, which therefore cannot be possibly causal. Thus, G must contain U<sup>a</sup> ← U<sup>b</sup> for some a, b ∈ {0, . . . , r}, a + 1 < b. Pick the earliest such U<sup>a</sup> on u.

Suppose for sake of contradiction that U<sup>a</sup> ̸= X′ . Then G contains Ua−<sup>1</sup> − U<sup>a</sup> ← U<sup>b</sup> and so R1 of Meek (1995), G must contain an edge ⟨Ua−1, Ub⟩. G cannot contain Ua−<sup>1</sup> − U<sup>b</sup> since this would contradict the choice of u. Neither can G contain Ua−<sup>1</sup> → U<sup>b</sup> since by R2 of Meek (1995), this would force u to contain the directed edge Ua−<sup>1</sup> → Ua. Thus G contains Ua−<sup>1</sup> ← Ub, but this contradicts the choice of Ua. Therefore G contains X′ ← Ub, b ∈ {2, . . . , r}, but this contradicts that G contains X′ → U<sup>c</sup> for all c ∈ {2, . . . , r}.

We have shown that X /∈ Cd, where G contains a causal path from X to D ∈ Cd. The result follows from Lemma 21.

(ii) Suppose for sake of contradiction that B<sup>i</sup> ∩ PossDe(X, G) ̸= ∅. By part (i), there is a causal path in G from X to every node in B<sup>i</sup> . Since Z ∩ PossDe(B<sup>i</sup> , G) ̸= ∅, then there is also a possibly causal path in G from some B<sup>i</sup> ∈ B<sup>i</sup> to Z. Thus by Lemma 26, there is a possibly causal path in G from X to Z, which contradicts that Z ∩ PossDe(X, G) = ∅.

# E Proofs for Section 3.5: Identifiability Condition

This section includes the proof of Proposition 5 found in Section 3.5. We note that one direction of the proof (⇐) relies heavily on a stronger claim that does not require Z ∩ PossDe(X, G) = ∅ (see Proposition 41). But we do not include this claim in the main text, since its converse does not hold (see Examples 13-14). The statement and proof of this claim are in the main results below. Two supporting results follow.

#### E.1 Main Results

Proof of Proposition 5. Follows from Theorem 3 and Proposition 41.

Proposition 41 (Necessity Condition) Let X, Y, and Z be pairwise disjoint node sets in a causal MPDAG G. If the conditional causal effect of X on Y given Z is identifiable in G, then there is no proper possibly causal path from X to Y in G that starts with an undirected edge and does not contain nodes in Z.

Proof of Proposition 41. We prove the contrapositive using similar logic to the proof of Proposition 3.2 in Perkovi´c (2020). Thus, suppose there is a proper possibly causal path from X to Y in G = (V, E) that starts with an undirected edge and does not contain nodes in Z. Then by Lemma 42, there is one such path—call it q = ⟨X = V0, . . . , V<sup>k</sup> = Y ⟩, X ∈ X, Y ∈ Y, k ≥ 1—where the corresponding paths in two DAGs in [G] take the forms X → · · · → Y and X ← V<sup>1</sup> → · · · → Y (X ← Y when k = 1). Call these DAGs D<sup>1</sup> and D<sup>2</sup> with paths q<sup>1</sup> and q2, respectively.

To prove that the conditional causal effect of X on Y given Z is not identifiable in G, it suffices to show that there are two families of interventional densities over V—call them F ∗ 1 and F ∗ 2 , where for i ∈ {1, 2}, we define F ∗ <sup>i</sup> = {fi(v|do(x ′ )) : X′ ⊆ V}—such that the following properties hold.

- (i) D<sup>1</sup> and D<sup>2</sup> are compatible with F ∗ 1 and F ∗ 2 , respectively. <sup>1</sup>
- (ii) f1(v) = f2(v).

<sup>1</sup>For brevity, we say a DAG is "compatible with" a set of interventional densities and an interventional density is "consistent with" a DAG as shorthand for these claims holding only were the DAG to be causal.

(iii) f1(y|do(x), z) ̸= f2(y|do(x), z).

To define such families, we start by introducing an additional DAG and an observational density f(v). That is, let D<sup>1</sup> ′ be a DAG constructed by removing every edge from D<sup>1</sup> except for the edges on q1. Then let f(v) be the multivariate normal density under the following linear structural equation model (SEM). Each random variable A ∈ V has mean zero and is a linear combination of its parents in D<sup>1</sup> ′ and ε<sup>A</sup> ∼ N(0, σ<sup>2</sup> A ), where {ε<sup>A</sup> : A ∈ V} are mutually independent. The coefficients in this linear combination are defined by the edge coefficients of D<sup>1</sup> ′ . We pick these edge coefficients in conjunction with {σ 2 A : A ∈ V} in such a way that each coefficient is in (0, 1) and Var(A) = 1 for all A ∈ V.

From this, we define F ∗ <sup>1</sup> = {f1(v|do(x ′ )) : X′ ⊆ V} such that D<sup>1</sup> ′ is compatible with F ∗ 1 and such that f1(v) = f(v). Note that f(v) is Markov compatible with D<sup>1</sup> ′ by construction, and we build the interventional densities in F ∗ <sup>1</sup> by replacing the intervening random variables in the SEM with their interventional values (Pearl, 2009).

To construct the second family of interventional densities, we introduce the DAG D<sup>2</sup> ′ , which we form by removing every edge from D<sup>2</sup> except for the edges on q2. Then note that we could have defined f(v) using a linear SEM based on the parents in D<sup>2</sup> ′ . In this case, the resulting observational density would again be a multivariate normal with mean vector zero and a covariance matrix with ones on the diagonal. The off-diagonal entries would be the covariances between the variables in D<sup>2</sup> ′ . But note that by Lemma 12, these values will equal the product of all edge coefficients between the relevant nodes in D<sup>2</sup> ′ . Since D<sup>1</sup> ′ and D<sup>2</sup> ′ contain no paths with colliders, the observational density f(v) built using D<sup>2</sup> ′ will be an identical density to that built under D<sup>1</sup> ′ . Thus, in an analogous way to F ∗ 1 , we define F ∗ <sup>2</sup> = {f2(v|do(x ′ )) : X′ ⊆ V} such that D<sup>2</sup> ′ is compatible with F ∗ 2 and such that f2(v) = f(v).

Having defined F ∗ 1 and F ∗ 2 , we check that their desired properties hold. Note that by construction, D<sup>1</sup> ′ and D<sup>2</sup> ′ are compatible with F ∗ 1 and F ∗ 2 , respectively. Thus (i) holds by Lemma 43. Similarly by construction, (ii) holds. To show that (iii) holds, it suffices to show that E[Y |do(X = 1), Z] is not the same under f<sup>1</sup> and f2.

To calculate these expectations, we first want to apply Rules 1-3 of the do calculus (Theorem 10). Since fi(v|do(x)), i ∈ {1, 2}, is consistent with D<sup>i</sup> ′ , we apply these rules using graphical relationships in D<sup>i</sup> ′ . Because the path in D<sup>i</sup> ′ corresponding to q<sup>i</sup> , i ∈ {1, 2}, does not contain nodes in Z or X \ {X}, then Y ⊥<sup>d</sup> Z|X and Y ⊥<sup>d</sup> X \ {X}|X in D<sup>i</sup> ′ X . Further, Y ⊥<sup>d</sup> X in D<sup>1</sup> ′ <sup>X</sup> and Y ⊥<sup>d</sup> X in D<sup>2</sup> ′ X . Thus by Rules 1-3 of the do calculus (Theorem 10), the following hold.

$$
E_1[Y|do(\mathbf{X} = 1), \mathbf{Z}] = E_1[Y|do(X = 1)] = E_1[Y|X = 1] := a.
$$
  
\n
$$
E_2[Y|do(\mathbf{X} = 1), \mathbf{Z}] = E_2[Y|do(X = 1)] = E_2[Y] := b,
$$

where E<sup>i</sup> , i ∈ {1, 2} is the expectation under f<sup>i</sup> . To calculate a and b, we rely on the observational density f(v), which was constructed using D<sup>1</sup> ′ . By Lemma 11, a equals the covariance of X and Y under f(v), and by Lemma 12, Cov(X, Y ) equals the product of all edge coefficients in D<sup>1</sup> ′ , which were chosen to be in (0, 1). Therefore, a ̸= 0. But by definition of f(v), b = 0.

#### E.2 Supporting Results

Lemma 42 Let X, Y, and Z be pairwise disjoint node sets in an MPDAG G = (V, E). Suppose that there is a proper possibly causal path from X to Y in G that starts with an undirected edge and does not contain nodes in Z. Then there is one such path ⟨X = V0, . . . , V<sup>k</sup> = Y ⟩, X ∈ X, Y ∈ Y, k ≥ 1, where the corresponding paths in two DAGs in [G] take the forms X → · · · → Y and X ← V<sup>1</sup> → · · · → Y (X ← Y when k = 1), respectively.

Proof of Lemma 42. This lemma is similar to Lemma A.3 of Perkovi´c (2020) and its proof borrows from the proof strategy of Lemma C.1 of Perkovi´c et al. (2017).

Let q <sup>∗</sup> be an arbitrary proper possibly causal path from X to Y in G that starts with an undirected edge and does not contain nodes in Z. Then let q = ⟨X = V0, . . . , V<sup>k</sup> = Y ⟩, X ∈ X, Y ∈ Y, k ≥ 1, be a shortest subsequence of q ∗ in G that also starts with an undirected edge. Note that q is a proper possibly causal path from X to Y in G that starts with an undirected edge and does not contain nodes in Z.

Consider when q is of definite status. Since q is possibly causal, all non-endpoints of q are definite non-colliders. Let D<sup>1</sup> be a DAG in [G] that contains X → V1. Then since V<sup>1</sup> is either Y or a definite non-collider on q, the path corresponding to q in D<sup>1</sup> takes the form X → · · · → Y by induction. Let D<sup>2</sup> be a DAG in [G] with no additional edges into V<sup>1</sup> compared to G (Lemma 16). Since G contains X − V1, D<sup>2</sup> contains X ← V1. When k > 1, G contains either V<sup>1</sup> − V<sup>2</sup> or V<sup>1</sup> → V2, and so D<sup>2</sup> contains X ← V<sup>1</sup> → V2. Thus by the same inductive reasoning as above, the path corresponding to q in D<sup>2</sup> takes the form X ← V<sup>1</sup> → · · · → Y (or simply X ← Y when k = 1).

Consider instead when q is not of definite status. Note that k > 1. To see that q contains V<sup>1</sup> −V2, note that by the choice of q and the fact that q is possibly causal, q(V1, Y ) is unshielded and possibly causal. Thus, q(V1, Y ) is of definite status. However, q is not of definite status, so V<sup>1</sup> must not be of definite status on q, which implies that q cannot contain V<sup>1</sup> → V2. Since q is possibly causal, it also cannot contain V<sup>1</sup> ← V2.

To find two DAGs in [G] with paths corresponding to q that fit our desired forms, we narrow our search to [G ′ ], where we let G ′ be an MPDAG constructed from G by adding V<sup>1</sup> → V<sup>2</sup> and completing R1-R4 of Meek (1995). We show below that the path corresponding to q in G ′ takes the form X −V<sup>1</sup> → · · · → Y , and thus, there must be two DAGs in [G ′ ] ⊆ [G] with corresponding paths of the forms X → · · · → Y and X ← V<sup>1</sup> → · · · → Y .

We first show that G ′ contains X − V<sup>1</sup> by the contraposition of Lemma 15. Note that we have already shown that G contains V<sup>1</sup> − V2, that G ′ is formed by adding V<sup>1</sup> → V<sup>2</sup> to G, and that G contains X − V1. It remains to show that X, V<sup>1</sup> ∈/ De(V2, G ′ ). To see this, note that G must contain an edge ⟨X, V2⟩, because V<sup>1</sup> is not of definite status on q. This edge must take the form X → V<sup>2</sup> by the choice of q and the fact that q is possibly causal. Thus, G ′ contains X → V<sup>2</sup> and V<sup>1</sup> → V2. Therefore, X, V<sup>1</sup> ∈/ De(V2, G ′ ). Finally, note that G ′ contains V<sup>1</sup> → · · · → Y by R1 of Meek (1995), since we constructed G ′ be adding V<sup>1</sup> → V<sup>2</sup> to a path q(V1, Y ) that is unshielded and possibly causal.

Lemma 43 Let X, Y, and Z be pairwise disjoint node sets in a causal DAG D = (V, E). Then let D<sup>∗</sup> = (V, E′ ) be a causal DAG constructed by removing edges from D, and let f(v|do(x)) be an interventional density over V. If f(v|do(x)) is consistent with D<sup>∗</sup> , then it is consistent with D.

Proof of Lemma 43. Suppose that f(v|do(x)) is consistent with D<sup>∗</sup> . Then by definition, there exists a set of interventional densities F ∗ such that D<sup>∗</sup> is compatible with F ∗ . Let f(v) be the density in F <sup>∗</sup> under a null intervention. Note that by the truncated factorization in Equation (1), f(v) is Markov compatible with D<sup>∗</sup> . Thus by Lemma 14,

$$
V_i \perp \left[ \mathbf{V} \setminus \left( \mathrm{De}(V_i, \mathcal{D}^*) \cup \mathrm{Pa}(V_i, \mathcal{D}^*) \right) \right] | \mathrm{Pa}(V_i, \mathcal{D}^*) \tag{33}
$$

for all V<sup>i</sup> ∈ V, where ⊥⊥ indicates independence with respect to f(v). Further, since De(V<sup>i</sup> , D<sup>∗</sup> ) ⊆ De(V<sup>i</sup> , D), then De(V<sup>i</sup> , D<sup>∗</sup> )∩Pa(V<sup>i</sup> , D) = ∅ and thus Pa(V<sup>i</sup> , D) ⊆ V\De(V<sup>i</sup> , D<sup>∗</sup> ). Therefore it follows from (33) that

$$
V_i \perp \left[ \text{Pa}(V_i, \mathcal{D}) \setminus \text{Pa}(V_i, \mathcal{D}^*) \right] \middle| \text{Pa}(V_i, \mathcal{D}^*). \tag{34}
$$

Let f(v|do(x ′ )), X′ ⊆ V, be an arbitrary density in F ∗ . Then by definition and (34)

$$
f(\mathbf{v}|do(\mathbf{x}')) = \prod_{V_i \in \mathbf{V} \setminus \mathbf{X}'} f(v_i | pa(v_i, \mathcal{D}^*)) \mathbb{1}(\mathbf{X}' = \mathbf{x}')
$$
  
= 
$$
\prod_{V_i \in \mathbf{V} \setminus \mathbf{X}'} f(v_i | pa(v_i, \mathcal{D})) \mathbb{1}(\mathbf{X}' = \mathbf{x}').
$$

Since f(v|do(x ′ )) was arbitrary, this holds for all densities in F ∗ . Thus, D is compatible with F ∗ . Since f(v|do(x)) ∈ F ∗ , then by definition, it is consistent with D.

# F Proofs for Section 4: Do Calculus for MPDAGs

This section includes lemmas needed for the proof of our do calculus (Theorem 6) found in Section 4. We divide these results into those needed for all of our do rules (Lemmas 44-47) and those needed for Rule 1 (Lemmas 48-49), Rule 2 (Lemmas 48-49), and Rule 3 (Lemmas 52-54). Figure 8 provides a map of these results.

We began Section 4 with a discussion of the mutilated graphs seen in Theorem 6, and we noted two differences between these graphs and their counterparts in Pearl's do calculus. Here, we highlight a third, more technical difference that will be useful in navigating the proofs below. Because the mutilated graphs in Theorem 6 might not be MPDAGs, the definite status of a path in these graphs no longer conveys a certainty about the corresponding paths in related DAGs. To see this, consider an MPDAG G that contains the paths V<sup>1</sup> − V<sup>2</sup> − X and V<sup>1</sup> → X. The graph G<sup>X</sup> only contains the path V<sup>1</sup> − V<sup>2</sup> − X, where V<sup>2</sup> is a definite non-collider by definition. However, note that [G] contains a DAG with the path V<sup>1</sup> → V<sup>2</sup> ← X.

#### F.1 Results for All do Rules

Lemma 44 (cf. Lemma 1 of Zhang (2006)) Let X, Y, Z, and W be pairwise disjoint node sets in a DAG D = (V, E), and let G be an MPDAG such that D ∈ [G]. Additionally, let p be a path in D from Z to Y such that p is d-connecting given X ∪W but no subsequence of p in D is d-connecting given X ∪ W. Then the following hold.

![](_page_41_Figure_0.jpeg)

Figure 8: Proof structure of Theorem 6.

- (i) All colliders on p are unshielded.
- (ii) The path in G corresponding to p is of definite status.

Proof of Lemma 44. Let p = ⟨Z = V1, . . . , V<sup>k</sup> = Y ⟩, Z ∈ Z, Y ∈ Y, k > 1.

(i) Let V<sup>i</sup> , i ∈ {2, . . . , k − 1}, be an arbitrary collider on p. For sake of contradiction, suppose D contains the edge ⟨Vi−1, Vi+1⟩. Define q = p(Z, Vi−1) ⊕ ⟨Vi−1, Vi+1⟩ ⊕ p(Vi+1, Y ). By the choice of p, q must be blocked by X ∪ W. Since Vi−<sup>1</sup> and Vi+1 are non-colliders on p, q must be blocked by a collider at either Vi−<sup>1</sup> or Vi+1. Without loss of generality, pick Vi−<sup>1</sup> so that D contains Vi−<sup>2</sup> → Vi−<sup>1</sup> ← Vi+1, where no descendant of Vi−<sup>1</sup> is in X ∪ W. However, since p is d-connecting given X ∪ W and p contains Vi−<sup>1</sup> → V<sup>i</sup> ← Vi+1, at least one descendant of Vi—and therefore of Vi−1—in D must be in X ∪ W.

(ii) Let p <sup>∗</sup> be the path in G corresponding to p. For sake of contradiction, suppose there is a node V<sup>i</sup> , i ∈ {2, . . . , k−1}, that is not of definite status on p ∗ . This implies that G—and therefore D—must contain the edge ⟨Vi−1, Vi+1⟩.

Define q = p(Z, Vi−1) ⊕ ⟨Vi−1, Vi+1⟩ ⊕ p(Vi+1, Y ) and consider the form of p(Vi−1, Vi+1). Since D contains ⟨Vi−1, Vi+1⟩, then by part (i), it cannot contain Vi−<sup>1</sup> → V<sup>i</sup> ← Vi+1. For sake of contradiction, suppose that D contains Vi−<sup>1</sup> → V<sup>i</sup> → Vi+1. This forces D to contain Vi−<sup>1</sup> → Vi+1. But since p is d-connected given X ∪ W, this implies that q is d-connected given X ∪ W, which contradicts the choice of p. By the same logic, D cannot contain Vi−<sup>1</sup> ← V<sup>i</sup> ← Vi+1. Therefore, D must contain Vi−<sup>1</sup> ← V<sup>i</sup> → Vi+1.

Without loss of generality, let ⟨Vi−1, Vi+1⟩ take the form Vi−<sup>1</sup> → Vi+1 in D. Note that for p to be d-connected and q to be blocked given X ∪W, Vi−<sup>1</sup> must be a collider on p and a node in X ∪W. Then by part (i), Vi−<sup>1</sup> is unshielded on p. So by properties of MPDAGs, Vi−<sup>1</sup> must also be a collider on p ∗ . Thus, G contains Vi−<sup>1</sup> ← V<sup>i</sup> . But this contradicts that Vi is not of definite status on p ∗ .

Lemma 45 Let X and W be disjoint node sets in a DAG D that has no edges into X. If a path in D is d-connecting given X ∪ W, then it does not contain nodes in X and is d-connecting given W.

Proof of Lemma 45. Any path in D that is d-connecting given X ∪ W cannot have non-colliders in X or W. Further, since there are no edges into X in D, all of the colliders on such a path cannot be in X and must have descendants in W.

Lemma 46 Let X, Y, Z, and W be pairwise disjoint node sets in a DAG D, let p be a path in D from Z to Y that is d-connecting given X ∪ W, and let q be a subsequence of p in D. Then all colliders on q are in An(X ∪ W, D).

Proof of Lemma 46. Let p = ⟨Z = V1, . . . , V<sup>k</sup> = Y ⟩, Z ∈ Z, Y ∈ Y, k > 1, and let V<sup>i</sup> , i ∈ {2, . . . , k − 1}, be an arbitrary collider on q.

When V<sup>i</sup> is also a collider on p, then V<sup>i</sup> ∈ An(X ∪ W, D), since p is d-connecting given X ∪ W. Consider when V<sup>i</sup> is not a collider on p. Then p contains Vi−<sup>1</sup> ← V<sup>i</sup> or V<sup>i</sup> → Vi+1. Without loss of generality, suppose p contains V<sup>i</sup> → Vi+1. Note that Vi+1 is not on q, since Vi is a collider on q. Therefore, let V<sup>j</sup> , j ∈ {i + 2, . . . , k}, be the node following V<sup>i</sup> on q so that q contains V<sup>i</sup> ← V<sup>j</sup> . Since D is acyclic, p cannot contain V<sup>i</sup> → · · · → V<sup>j</sup> . Hence, let C be the collider on p(V<sup>i</sup> , V<sup>j</sup> ) closest to V<sup>i</sup> so that V<sup>i</sup> ∈ An(C, D). Since p is d-connecting given X ∪ W, then C ∈ An(X ∪ W, D) and thus, V<sup>i</sup> ∈ An(X ∪ W, D).

Lemma 47 Let X and Z be disjoint node sets in an MPDAG G, let X′ ⊆ X, let D be a DAG in [G], and let p be a path in DXZ. If the path in G corresponding to p is of definite status, then the sequence of nodes in GX′<sup>Z</sup> corresponding to p forms a path where a node is a definite non-collider or collider if and only if it is a non-collider or collider, respectively, on p.

Proof of Lemma 47. To see that the sequence of nodes in GX′<sup>Z</sup> corresponding to p forms a path, note that the set of adjacencies in DXZ is a subset of the set of adjacencies in GX′<sup>Z</sup> . Then let V be an arbitrary node on p, and let p, p ∗ , and p <sup>∗</sup> be the paths in <sup>D</sup>, <sup>G</sup>, and <sup>G</sup>X′<sup>Z</sup> , respectively, corresponding to p. Consider the following.

- (a) V is a non-collider/collider on p.
- (b) V is a non-collider/collider on p.
- (c) V is a definite non-collider/collider on p ∗ .
- (d) V is a definite non-collider/collider on p ∗ .

By definition of the graphs, (a) ⇔ (b) and (b) ⇐ (c). Further, if p ∗ is of definite status, (b) ⇒ (c) and (c) ⇐ (d). Then since removing edges from G outside of p ∗ cannot change a node of definite status on p ∗ , (c) ⇒ (d).

#### F.2 Results for do Rule 1

Lemma 48 Let X, Y, Z, and W be pairwise disjoint node sets in an MPDAG G = (V, E), and let D be a DAG in [G]. Additionally, let p be a path in D<sup>X</sup> from Z to Y such that p is d-connecting given X ∪ W but no subsequence of p in D<sup>X</sup> is d-connecting given X ∪ W. Then the sequence of nodes in G<sup>X</sup> corresponding to p forms a path where a node is a definite non-collider or collider if and only if it is a non-collider or collider, respectively, on p.

Proof of Lemma 48. Let p be the path in D corresponding to p. If p satisfies the assumptions of Lemma 44, then the path in G corresponding to p is of definite status, and the claim follows by Lemma 47. We show these assumptions hold below.

First note that p must be d-connecting given X ∪ W, since p is d-connecting given X ∪ W and adding edges to a graph cannot block existing d-connecting paths. Next, for sake of contradiction, suppose that there is a subsequence of p in D—call it q—that is d-connecting given X ∪ W. By Lemma 45, p—and therefore q—does not contain nodes in X. Thus, the sequence of nodes in D<sup>X</sup> corresponding to q forms a path—call it q. Since q is d-connecting given X ∪ W, none of the non-colliders on q—and therefore on q—are in X ∪W. Further, since p is d-connecting given X ∪W, then by Lemma 46, all colliders on q are in An(X∪W, DX). But this implies that q, which is a subsequence of p, is d-connecting given X ∪ W, which contradicts the choice of p.

Lemma 49 Let X, Y, Z, and W be pairwise disjoint node sets in an MPDAG G = (V, E). If (Z ⊥<sup>d</sup> Y|X,W)G<sup>X</sup> , then (Z ⊥<sup>d</sup> Y|X,W)D<sup>X</sup> for all DAGs D ∈ [G].

Proof of Lemma 49. We prove the contrapositive. Suppose there exists a DAG D ∈ [G] such that D<sup>X</sup> contains a path from Z to Y that is d-connecting given X ∪W. Let S be the set of all shortest such paths, and let p = ⟨Z = V1, . . . , V<sup>k</sup> = Y ⟩, Z ∈ Z, Y ∈ Y, k > 1, be a path in S with the shortest distance to X ∪ W (Definition 9).

To complete the proof, we want to show that the sequence of nodes in G<sup>X</sup> corresponding to p forms a path that is d-connecting given X ∪ W. Note that by definition, p is dconnecting given X∪W and no subsequence of p in D<sup>X</sup> is d-connecting given X∪W. Thus by Lemma 48, we only need to show the following.

- (i) No non-collider on p is in X ∪ W.
- (ii) Every collider on p is in An(X ∪ W, GX).

Claim (i) holds since p is d-connecting given X ∪ W. The remainder of the proof shows that claim (ii) holds.

Let V<sup>i</sup> , i ∈ {2, . . . , k − 1}, be an arbitrary collider on p. Since p is d-connecting given X ∪ W in DX, then V<sup>i</sup> ∈ An(W, DX). When V<sup>i</sup> ∈ W, then V<sup>i</sup> ∈ An(X ∪ W, GX) and we are done.

When V<sup>i</sup> ∈/ W, then let q = ⟨V<sup>i</sup> = Q1, . . . , Q<sup>m</sup> = W⟩, W ∈ W, m > 1, be a shortest directed path in D<sup>X</sup> from V<sup>i</sup> to W, and let q <sup>∗</sup> be the path in G corresponding to q. Note that no node on q ∗ is in X, since D<sup>X</sup> contains Vi−<sup>1</sup> → Q<sup>1</sup> → · · · → Qm. Thus if q ∗ is directed, then the corresponding sequence of nodes in G<sup>X</sup> will also form a directed path, which again implies that V<sup>i</sup> ∈ An(X ∪ W, GX) and the proof is complete. We show below that q ∗ is directed.

We start by showing that q ∗ contains Q<sup>1</sup> → Q2. Note that by Lemma 48, GX—and therefore G—contains Vi−<sup>1</sup> → Q<sup>1</sup> ← Vi+1. For sake of contradiction, suppose that G—and therefore D—contains the edges ⟨Vi−1,Q2⟩ and ⟨Vi+1,Q2⟩. Since D must contain Vi−<sup>1</sup> → Q<sup>1</sup> → Q<sup>2</sup> and Vi+1 → Q<sup>1</sup> → Q2, it must contain Vi−<sup>1</sup> → Q<sup>2</sup> ← Vi+1. And since no node on q ∗ is in X, then D<sup>X</sup> must also contain Vi−<sup>1</sup> → Q<sup>2</sup> ← Vi+1.

When Q<sup>2</sup> is not on p, consider the path p(Z, Vi−1)⊕ ⟨Vi−1, Q2, Vi+1⟩ ⊕p(Vi+1, Y ) in DX. Note that this is a path from Z to Y that is d-connecting given X ∪W, is the same length as p, and has a shorter distance than p to X ∪ W, which contradicts the choice of p.

We complete the contradiction by noting that there are no further cases—that is, Q<sup>2</sup> cannot be a node on p. Suppose for sake of contradiction that it is, and without loss of generality, let Q<sup>2</sup> follow V<sup>i</sup> on p. By the choice of p as a shortest path, the path r = p(Z, Q1)⊕ ⟨Q1, Q2⟩⊕p(Q2, Y ) in D<sup>X</sup> must be blocked given X∪W. Since p is d-connecting given X ∪ W, V<sup>i</sup> ∈/ X ∪ W, and r contains Q<sup>1</sup> → Q2, then Q<sup>2</sup> must be a non-collider on p and a collider on r such that Q<sup>2</sup> ∈/ An(W, DX). But since V<sup>i</sup> ∈ An(W, DX) and V<sup>i</sup> ∈/ W, then Q<sup>2</sup> ∈ An(W, DX), which is a contradiction.

Thus, G does not contain both edges ⟨Vi−1,Q2⟩ and ⟨Vi+1,Q2⟩. Since G contains Vi−<sup>1</sup> → Q<sup>1</sup> ← Vi+1, then by Rule 1 of Meek (1995), q ∗ contains Q<sup>1</sup> → Q2. If m = 2, then q ∗ is directed and we are done.

Consider when m > 2, and suppose for sake of contradiction that q ∗ is shielded. That is, there exists an edge ⟨Q<sup>j</sup> , Qj+2⟩, 1 ≤ j ≤ m − 2, in G. Since no node on q ∗ is in X, then D<sup>X</sup> also contains ⟨Q<sup>j</sup> , Qj+2⟩. Because D<sup>X</sup> contains Q<sup>j</sup> → Qj+1 → Qj+2, then it must contain Q<sup>j</sup> → Qj+2. But then the path q(Q1, Q<sup>j</sup> ) ⊕ ⟨Q<sup>j</sup> , Qj+2⟩ ⊕ q(Qj+2, Qm) contradicts the choice of q. Thus when m > 2, q ∗ is unshielded and begins with Q<sup>1</sup> → Q2. So by Rule 1 of Meek (1995), q ∗ is again directed and we are done.

#### F.3 Results for do Rule 2

Lemma 50 Let X, Y, Z, and W be pairwise disjoint node sets in an MPDAG G = (V, E) and let D be a DAG in [G]. Additionally, let p = ⟨Z = V1, . . . , V<sup>k</sup> = Y ⟩, Z ∈ Z, Y ∈ Y, k > 1, be a proper path from Z to Y in DXZ such that p is d-connecting given X ∪ W and no subsequence of p in DXZ is d-connecting given X ∪W. Let p ∗ be the corresponding path in G.

- (i) If G has no edge Z−Vi, i ∈ {2, . . . , k}, then the sequence of nodes in GXZ corresponding to p forms a path where a node is a definite non-collider or collider if and only if it is a non-collider or collider, respectively, on p.
- (ii) If G has an edge Z − Vi, i ∈ {2, . . . , k}, let V<sup>i</sup> be the closest such node to Y on p ∗ . Then the sequence of nodes in GXZ corresponding to ⟨Z, Vi⟩ ⊕ p(V<sup>i</sup> , Y ) forms a path where a node is a definite non-collider or collider if and only if it is a non-collider or collider, respectively, on p.

Proof of Lemma 50. Let p be the path in D corresponding to p. Before proving parts (i) and (ii), we first show that V<sup>1</sup> and V3, . . . , V<sup>k</sup> are nodes of definite status on p ∗ . This clearly holds for the endpoints V<sup>1</sup> and Vk. Next, pick an arbitrary V<sup>j</sup> , j ∈ {3, . . . , k − 1}, and for sake of contradiction, suppose V<sup>j</sup> is not of definite status on p ∗ . This implies that G contains an edge ⟨Vj−1, Vj+1⟩. Since p is proper and has no nodes in X (Lemma 45), then DXZ must contain ⟨Vj−1, Vj+1⟩.

Define the path r = p(Z, Vj−1) ⊕ ⟨Vj−1, Vj+1⟩ ⊕ p(Vj+1, Y ) in DXZ. Note that by the choice of p, r cannot be d-connecting given X ∪ W. But by Lemma 46, any collider on r is in An(X ∪ W, DXZ). Hence, the only way for p to be d-connecting but r to be blocked given X ∪W is if Vj−<sup>1</sup> or Vj+1 is a node in X ∪W, a collider on p, and a non-collider on r.

Without loss of generality, pick Vj−1. By Lemma 44(i), Vj−<sup>1</sup> is unshielded on p. Further, since p has no nodes in X and DXZ contains Vj−<sup>2</sup> → Vj−<sup>1</sup> ← V<sup>j</sup> , then Vj−2, V<sup>j</sup> ∈/ X ∪ Z. Therefore, V<sup>j</sup> is also an unshielded collider on p, and by properties of MPDAGs, G must contain Vj−<sup>2</sup> → Vj−<sup>1</sup> ← V<sup>j</sup> . But this contradicts that V<sup>j</sup> is not of definite status on p ∗ .

(i) Suppose G has no edge Z − V<sup>i</sup> , i ∈ {2, . . . , k}, so that p ∗ cannot start undirected. Further, note that p ∗ cannot start with Z → V2, since this would imply DXZ contains Z → V2, which is a contradiction. Thus, p <sup>∗</sup> must start with Z ← V2, which makes V<sup>2</sup> a node of definite status on p ∗ . Since we have already shown V<sup>1</sup> and V3, . . . , V<sup>k</sup> are nodes of definite status on p ∗ , we have that p ∗ is of definite status. The claim follows by Lemma 47.

(ii) Suppose there is an edge Z −V<sup>i</sup> , i ∈ {2, . . . , k}, in G where V<sup>i</sup> is the closest such node to Y on p ∗ . Then let q <sup>∗</sup> be the the path ⟨Z, Vi⟩ ⊕ p ∗ (V<sup>i</sup> , Y ) in G. Note that we have already shown Vi+1, . . . , V<sup>k</sup> are nodes of definite status on p ∗ . So by Lemma 47, the sequence of nodes in GXZ corresponding to p(V<sup>i</sup> , Y ) forms a path where a node is a definite non-collider or collider if and only if it is a non-collider or collider, respectively, on p.

Note that GXZ also contains Z − V<sup>i</sup> , and consider the path in GXZ corresponding to ⟨Z, Vi⟩ ⊕ p(V<sup>i</sup> , Y )—call this q ∗ . We have shown the claim holds for q ∗ (V<sup>i</sup> , Y ). Then since V<sup>1</sup> is an endpoint on q ∗ , it remains to consider the status of V<sup>i</sup> on q ∗ .

For sake of contradiction, suppose that V<sup>i</sup> is not of definite status on q ∗ . Then note that V<sup>i</sup> cannot be of definite status on q ∗ , since removing edges from G outside of q ∗ cannot change a node of definite status of q ∗ . It follows that G must contain an edge ⟨Z, Vi+1⟩, which by choice of V<sup>i</sup> , must be directed.

Consider when G contains Z → Vi+1 so that GXZ contains Z − V<sup>i</sup> but not the edge ⟨Z, Vi+1⟩. Since V<sup>i</sup> is not of definite status on q ∗ , then GXZ cannot contain Z − V<sup>i</sup> − Vi+1 or Z − V<sup>i</sup> → Vi+1. Thus, GXZ contains Z − V<sup>i</sup> ← Vi+1. But this implies that G contains Z − V<sup>i</sup> ← Vi+1 and Z → Vi+1, which contradicts Rule 2 of Meek (1995).

Consider instead when G contains Z ← Vi+1. Then DXZ also contains Z ← Vi+1, since Z /∈ X and p is proper. By choice of p, the path t = ⟨Z, Vi+1⟩ ⊕ p(Vi+1, Y ) in DXZ must be blocked by X ∪ W. Since p is d-connecting given X ∪ W and Vi+1 is a non-collider on t, then Vi+1 must be a node in X ∪ W and a collider on p. By Lemma 44(i), Vi+1 must be an unshielded collider on p. Since p has no nodes in X (Lemma 45) and DXZ contains V<sup>i</sup> → Vi+1 ← Vi+2, then V<sup>i</sup> , Vi+2 ∈/ X ∪ Z. Therefore, Vi+1 is also an unshielded collider on p, and by properties of MPDAGs, G must contain V<sup>i</sup> → Vi+1 ← Vi+2. But this contradicts that V<sup>i</sup> is not of definite status on q ∗ .

Thus, V<sup>i</sup> is of definite status on q ∗ . Finally, we show that V<sup>i</sup> is a definite non-collider on both q <sup>∗</sup> and p. Since q ∗ starts undirected and V<sup>i</sup> is of definite status on q ∗ , then V<sup>i</sup> is a definite non-collider on q ∗ . For sake of contradiction, suppose that V<sup>i</sup> is a collider on p. By Lemma 44(i), V<sup>i</sup> must be an unshielded collider on p. Since p has no nodes in X and DXZ contains Vi−<sup>1</sup> → V<sup>i</sup> ← Vi+1, then Vi−1, Vi+1 ∈/ X ∪ Z. Therefore, V<sup>i</sup> is also an unshielded collider on p, and by properties of MPDAGs, G—and therefore GXZ—must contain Vi−<sup>1</sup> → V<sup>i</sup> ← Vi+1. But then GXZ contains Z − V<sup>i</sup> ← Vi+1, which contradicts that Vi is of definite status on q ∗ .

Lemma 51 Let X, Y, Z, and W be pairwise disjoint node sets in an MPDAG G = (V, E). If (Z ⊥<sup>d</sup> Y|X,W)GXZ , then (Z ⊥<sup>d</sup> Y|X,W)DXZ for all DAGs D ∈ [G].

Proof of Lemma 51. We prove the contrapositive. Suppose there exists a DAG D ∈ [G] such that DXZ contains a path from Z to Y that is d-connecting given X ∪ W. Let S be the set of all shortest such paths, and let p = ⟨Z = V1, . . . , V<sup>k</sup> = Y ⟩, Z ∈ Z, Y ∈ Y, k > 1, be a path in S with the shortest distance to X ∪ W (Definition 9).

Note that by definition, p is proper, p is d-connecting given X∪W, and no subsequence of p in DXZ is d-connecting given X ∪ W. Thus by Lemma 50, GXZ contains a definite status path from Z to Y where a node is a definite non-collider or collider if and only if it is a non-collider or collider, respectively, on p. To complete the proof, we want to show that this path is d-connecting given X ∪ W. To do this, we only need to show the following.

- (i) No non-collider on p is in X ∪ W.
- (ii) Every collider on p is in An(X ∪ W, GXZ).

Claim (i) holds since p is d-connecting given X ∪ W. The remainder of the proof shows that claim (ii) holds.

Let V<sup>i</sup> , i ∈ {2, . . . , k − 1}, be an arbitrary collider on p. Since p is d-connecting given X ∪ W in DXZ, then V<sup>i</sup> ∈ An(W, DXZ). When V<sup>i</sup> ∈ W, then V<sup>i</sup> ∈ An(X ∪ W, GXZ) and we are done.

When V<sup>i</sup> ∈/ W, then let q = ⟨V<sup>i</sup> = Q1, . . . , Q<sup>m</sup> = W⟩, W ∈ W, m > 1, be a shortest directed path in DXZ from V<sup>i</sup> to W, and let q <sup>∗</sup> be the path in G corresponding to q. Note that no node on q ∗ is in X ∪ Z, since DXZ contains Vi−<sup>1</sup> → Q<sup>1</sup> → · · · → Q<sup>m</sup> and Q<sup>m</sup> ∈ W. Thus if q ∗ is directed, then the corresponding sequence of nodes in GXZ will also form a directed path, which again implies that V<sup>i</sup> ∈ An(X ∪ W, GXZ) and the proof is complete. We show below that q ∗ is directed.

We start by showing that q ∗ contains Q<sup>1</sup> → Q2. Note that V<sup>i</sup> is an unshielded collider on p by Lemma 44(i). Since p has no nodes in X (Lemma 45) and DXZ contains Vi−<sup>1</sup> → V<sup>i</sup> ← Vi+1, then Vi−1, Vi+1 ∈/ X ∪ Z. Therefore, V<sup>i</sup> is also an unshielded collider on the path in D corresponding to p, and by properties of MPDAGs, G contains Vi−<sup>1</sup> → Q<sup>1</sup> ← Vi+1.

For sake of contradiction, suppose that G—and therefore D—contains the edges ⟨Vi−1,Q2⟩ and ⟨Vi+1,Q2⟩. Since D must contain Vi−<sup>1</sup> → Q<sup>1</sup> → Q<sup>2</sup> and Vi+1 → Q<sup>1</sup> → Q2, it must contain Vi−<sup>1</sup> → Q<sup>2</sup> ← Vi+1. And since no node on q ∗ is in X and Vi−1, Vi+1 ∈/ Z, then DXZ must also contain Vi−<sup>1</sup> → Q<sup>2</sup> ← Vi+1. When Q<sup>2</sup> is not on p, consider the path p(Z, Vi−1)⊕ ⟨Vi−1, Q2, Vi+1⟩ ⊕p(Vi+1, Y ) in DXZ. Note that this is a path from Z to Y that is d-connecting given X ∪ W, is the same length as p, and has a shorter distance than p to X ∪ W, which contradicts the choice of p.

We complete the contradiction by noting that there are no further cases—that is, Q<sup>2</sup> cannot be a node on p. Suppose for sake of contradiction that it is, and without loss of generality, let Q<sup>2</sup> follow V<sup>i</sup> on p. By the choice of p as a shortest path, the path r = p(Z, Q1)⊕⟨Q1, Q2⟩⊕p(Q2, Y ) in DXZ must be blocked given X∪W. Since p is d-connecting given X ∪ W, V<sup>i</sup> ∈/ X ∪ W, and r contains Q<sup>1</sup> → Q2, then Q<sup>2</sup> must be a non-collider on p and a collider on r such that Q<sup>2</sup> ∈/ An(W, DXZ). But since V<sup>i</sup> ∈ An(W, DXZ) and V<sup>i</sup> ∈/ W, then Q<sup>2</sup> ∈ An(W, DXZ), which is a contradiction.

Thus, G does not contain both edges ⟨Vi−1,Q2⟩ and ⟨Vi+1,Q2⟩. Since G contains Vi−<sup>1</sup> → Q<sup>1</sup> ← Vi+1, then by Rule 1 of Meek (1995), q ∗ contains Q<sup>1</sup> → Q2. If m = 2, then q ∗ is directed and we are done.

Consider when m > 2, and suppose for sake of contradiction that q ∗ is shielded. That is, there exists an edge ⟨Q<sup>j</sup> , Qj+2⟩, 1 ≤ j ≤ m − 2, in G. Since no node on q ∗ is in X ∪ Z, then DXZ also contains ⟨Q<sup>j</sup> , Qj+2⟩. Because DXZ contains Q<sup>j</sup> → Qj+1 → Qj+2, then it must contain Q<sup>j</sup> → Qj+2. But then the path q(Q1, Q<sup>j</sup> ) ⊕ ⟨Q<sup>j</sup> , Qj+2⟩ ⊕ q(Qj+2, Qm) contradicts the choice of q. Thus when m > 2, q ∗ is unshielded and begins with Q<sup>1</sup> → Q2. So by Rule 1 of Meek (1995), q ∗ is again directed and we are done.

#### F.4 Results for do Rule 3

Lemma 52 Let X, Y, Z, and W be pairwise disjoint node sets in an MPDAG G = (V, E) and let D be a DAG in [G]. Define Z(W) = Z \ An(W, DX) and Z ′ (W) = Z \ PossAn(W, GV\X). Then Z ′ (W) ⊆ Z(W).

Proof of Lemma 52. Note that we can write Z(W) = Z \ -An(W, DX) \ X . Thus to prove this claim, we show that An(W, DX) \ X ⊆ PossAn(W, GV\X).

Pick any A ∈ An(W, DX)\X and let p be an arbitrary causal path in D<sup>X</sup> from A to W. Since the path in D corresponding to p must be causal, then by Lemma 18, the corresponding path in G must be possibly causal. Note that no node on p is in X. Thus, the sequence of nodes in GV\<sup>X</sup> corresponding to p forms a path. Further, since removing edges from G that are outside of a possibly causal path cannot make that path non-causal, then the path in GV\<sup>X</sup> corresponding to p must be possibly causal. Therefore, A ∈ PossAn(W, GV\X).

Lemma 53 Let X, Y, Z, and W be pairwise disjoint node sets in an MPDAG G = (V, E) and let D be a DAG in [G]. Define Z(W) = Z \ An(W, DX). Then let p be a proper path from Z to Y in DX Z(W) such that p is d-connecting given X ∪ W but no subsequence of p in DX Z(W) is d-connecting given X ∪ W. Define Z ′ (W) = Z \ PossAn(W, GV\X). Then the sequence of nodes in GX Z′(W) corresponding to p forms a path where a node is a definite non-collider or collider if and only if it is a non-collider or collider, respectively, on p.

Proof of Lemma 53. Let p be the path in D corresponding to p. If p satisfies the assumptions of Lemma 44, then the path in G corresponding to p is of definite status, and the claim follows by Lemmas 52 and 47. We show these assumptions hold below.

First note that p must be d-connecting given X∪W, since p is d-connecting given X∪W and adding edges to a graph cannot block existing d-connecting paths. Next, for sake of contradiction, suppose that there is a subsequence of p in D—call it q—that is d-connecting given X ∪ W.

Consider when the sequence of nodes in DX Z(W) corresponding to q forms a path—call it q. Since q is d-connecting given X ∪ W, none of the non-colliders on q—and therefore on q—are in X ∪W. Further, since p is d-connecting given X ∪W, then by Lemma 46, all colliders on q are in An(X ∪ W, DX Z(W) ). But this implies that q, which is a subsequence of p, is d-connecting given X ∪ W, which contradicts the choice of p.

Consider instead when the sequence of nodes in DX Z(W) corresponding to q does not form a path. This implies that q must contain an edge into X ∪ Z(W). By Lemma 45, p—and therefore q—is proper and has no nodes in X. Thus, q must start with an edge into Z and Z must be a node in Z(W). But since p is a path in DX Z(W) , then p—and therefore p—must start with an edge out of Z. Let Q<sup>2</sup> and V<sup>2</sup> be the distinct second nodes on q and p, respectively, so that D contains Z ← Q<sup>2</sup> and Z → V<sup>2</sup> . . . Q2. By the acyclicity of D, there must be a collider on p(Z, Q2)—and therefore on p(Z, Q2).

Let C be the closest collider to Z on p. Since p is d-connecting given X ∪ W in DX Z(W) , then C ∈ An(W, DX Z(W) ). Further, since D contains Z → · · · → C, then Z ∈ An(W, DX Z(W) ) ⊆ An(W, DX), which contradicts that Z ∈ Z(W).

Lemma 54 Let X, Y, Z, and W be pairwise disjoint node sets in an MPDAG G = (V, E). If (Z ⊥<sup>d</sup> Y|X,W)GX Z′(W) , then (Z ⊥<sup>d</sup> Y|X,W)DX Z(W) for all DAGs D ∈ [G], where we define Z ′ (W) = Z \ PossAn(W, GV\X) and Z(W) = Z \ An(W, DX).

Proof of Lemma 54. We prove the contrapositive. Suppose there exists a DAG D ∈ [G] such that DX Z(W) contains a path from Z to Y that is d-connecting given X ∪ W. Let S be the set of all shortest such paths, and let p = ⟨Z = V1, . . . , V<sup>k</sup> = Y ⟩, Z ∈ Z, Y ∈ Y, k > 1, be a path in S with the shortest distance to X ∪ W (Definition 9).

To complete the proof, we want to show that the sequence of nodes in GX Z′(W) corresponding to p forms a path that is d-connecting given X ∪W. Note that by definition, p is proper, p is d-connecting given X∪W, and no subsequence of p in DX Z(W) is d-connecting given X ∪ W. Thus by Lemma 53, we only need to show the following.

- (i) No non-collider on p is in X ∪ W.
- (ii) Every collider on p is in An(X ∪ W, GX Z′(W) ).

Claim (i) holds since p is d-connecting given X ∪ W. The remainder of the proof shows that claim (ii) holds.

Let V<sup>i</sup> , i ∈ {2, . . . , k−1}, be an arbitrary collider on p. Since p is d-connecting given X∪ W in DX Z(W) , then V<sup>i</sup> ∈ An(W, DX Z(W) ). When V<sup>i</sup> ∈ W, then V<sup>i</sup> ∈ An(X∪W, GX Z′(W) ) and we are done.

When V<sup>i</sup> ∈/ W, then let q = ⟨V<sup>i</sup> = Q1, . . . , Q<sup>m</sup> = W⟩, W ∈ W, m > 1, be a shortest directed path in DX Z(W) from V<sup>i</sup> to W, and let q <sup>∗</sup> be the path in G corresponding to q. Note that no node on q ∗ is in X ∪ Z(W), since DX Z(W) contains Vi−<sup>1</sup> → Q<sup>1</sup> → · · · → Qm. By Lemma 52, this implies that no node on q ∗ is in X ∪ Z ′ (W). Thus, if q ∗ is directed, then the corresponding sequence of nodes in GX Z′(W) will also form a directed path, which again implies that V<sup>i</sup> ∈ An(X ∪ W, GX Z′(W) ) and the proof is complete. We show below that q ∗ is directed.

We start by showing that q ∗ contains Q<sup>1</sup> → Q2. Note that by Lemma 53, GX Z′(W) and therefore G—contains Vi−<sup>1</sup> → Q<sup>1</sup> ← Vi+1. For sake of contradiction, suppose that G—and therefore D—contains the edges ⟨Vi−1,Q2⟩ and ⟨Vi+1,Q2⟩. Since D must contain Vi−<sup>1</sup> → Q<sup>1</sup> → Q<sup>2</sup> and Vi+1 → Q<sup>1</sup> → Q2, it must contain Vi−<sup>1</sup> → Q<sup>2</sup> ← Vi+1. And since no node on q ∗ is in X ∪ Z(W), then DX Z(W) must also contain Vi−<sup>1</sup> → Q<sup>2</sup> ← Vi+1.

When Q<sup>2</sup> is not on p, consider the path p(Z, Vi−1) ⊕ ⟨Vi−1, Q2, Vi+1⟩ ⊕ p(Vi+1, Y ) in DX Z(W) . Note that this is a path from Z to Y that is d-connecting given X ∪ W, is the same length as p, and has a shorter distance than p to X ∪W, which contradicts the choice of p.

We complete the contradiction by noting that there are no further cases—that is, Q<sup>2</sup> cannot be a node on p. Suppose for sake of contradiction that it is, and without loss of generality, let Q<sup>2</sup> follow V<sup>i</sup> on p. By the choice of p as a shortest path, the path r = p(Z, Q1) ⊕ ⟨Q1, Q2⟩ ⊕ p(Q2, Y ) in DX Z(W) must be blocked given X ∪ W. Since p is dconnecting given X ∪ W, V<sup>i</sup> ∈/ X ∪ W, and r contains Q<sup>1</sup> → Q2, then Q<sup>2</sup> must be a non-collider on p and a collider on r such that Q<sup>2</sup> ∈/ An(W, DX Z(W) ). But since V<sup>i</sup> ∈ An(W, DX Z(W) ) and V<sup>i</sup> ∈/ W, then Q<sup>2</sup> ∈ An(W, DX Z(W) ), which is a contradiction.

Thus, G does not contain both edges ⟨Vi−1,Q2⟩ and ⟨Vi+1,Q2⟩. Since G contains Vi−<sup>1</sup> → Q<sup>1</sup> ← Vi+1, then by Rule 1 of Meek (1995), q ∗ contains Q<sup>1</sup> → Q2. If m = 2, then q ∗ is directed and we are done.

Consider when m > 2, and suppose for sake of contradiction that q ∗ is shielded. That is, there exists an edge ⟨Q<sup>j</sup> , Qj+2⟩, 1 ≤ j ≤ m − 2, in G. Since no node on q ∗ is in X ∪ Z(W), then DX Z(W) also contains ⟨Q<sup>j</sup> , Qj+2⟩. Because DX Z(W) contains Q<sup>j</sup> → Qj+1 → Qj+2, then it must contain Q<sup>j</sup> → Qj+2. But then the path q(Q1, Q<sup>j</sup> ) ⊕ ⟨Q<sup>j</sup> , Qj+2⟩ ⊕ q(Qj+2, Qm) contradicts the choice of q. Thus when m > 2, q ∗ is unshielded and begins with Q<sup>1</sup> → Q2. So by Rule 1 of Meek (1995), q ∗ is again directed and we are done.

# G Proofs for Section 5.4: Identification Algorithm

This section includes the proof of Theorem 7 found in Section 5.4. Four supporting results needed for this proof follow.

#### G.1 Main Result

Proof of Theorem 7. Suppose there is a path in G = (V, E) from X ∈ X to Y∪Z that does not contain X\{X}, is possibly causal, starts undirected—and where Y ̸⊥<sup>d</sup> X | X\{X}, Z in GX\{X}<sup>X</sup> . We want to show that the conditional effect of X on Y given Z is not identifiable in G. Since Y ̸⊥<sup>d</sup> X | X \ {X}, Z in GX\{X}<sup>X</sup> , the following sets must be non-empty:

$$
\mathbf{S_1} = \left\{ \begin{array}{c} \text{definite status paths in } \mathcal{G}_{\overline{\mathbf{X}} \setminus \{X\} \underline{X}} \text{ from } X \text{ to } \mathbf{Y} \text{ that are} \\ \text{d-connected} \text{div} \mathbf{X} \setminus \{X\} \cup \mathbf{Z} \end{array} \right\} \text{ and } \mathbf{S_2} = \left\{ \text{ paths in } \mathbf{S_1} \text{ with the fewest colliders } \right\}.
$$

Then consider the following set:

S<sup>3</sup> = { paths in S<sup>2</sup> that start undirected }.

We divide the remainder of the proof into two cases based on whether S<sup>3</sup> = ∅. In both cases, we consider DAGs D<sup>1</sup> , D<sup>2</sup> ∈ [G] with paths in the sets above. To show the conditional effect is not identifiable in G, it suffices to show that each D<sup>i</sup> is compatible with a family of interventional densities F ∗ <sup>i</sup> = {fi(v|do(x ′ )) : X′ ⊆ V} such that the following hold.

$$
f_1(\mathbf{v}) = f_2(\mathbf{v}). \tag{35}
$$

$$
f_1(\mathbf{y} \mid \text{do}(\mathbf{x}), \mathbf{z}) \neq f_2(\mathbf{y} \mid \text{do}(\mathbf{x}), \mathbf{z}). \tag{36}
$$

Before proceeding to cases, we briefly show that all paths in S<sup>1</sup> are proper paths from X to Y that are open given Z. To see this, note that since every path in S<sup>1</sup> is of definite status and open given X \ {X} ∪ Z, it cannot have definite non-colliders in X \ {X} ∪ Z. Further, since there are no edges into X \ {X} in GX\{X}<sup>X</sup> , all of the colliders on any path in S<sup>1</sup> cannot be in X \ {X} and must have descendants in Z.

CASE 1: Consider when S<sup>3</sup> ̸= ∅, and define the following sets.

- S<sup>4</sup> = {paths in S<sup>3</sup> with the fewest edges}.
- S<sup>5</sup> = {paths in S<sup>4</sup> with a shortest distance to Z in GX\{X}<sup>X</sup> }.

Pick an arbitrary path p := ⟨X = P1, . . . , P<sup>k</sup> = Y ⟩, k > 1, Y ∈ Y, in S<sup>5</sup> ⊆ S1. Note that the sequence of nodes in G corresponding to p in GX\{X}<sup>X</sup> forms a path p in G that contains the same edge orientations as p. Then note that since p ∈ S1, we have shown that p—and therefore p—is a proper path from X to Y. Further, both paths start undirected, since p ∈ S3.

Consider first when p is possibly causal so that p—and therefore p—has no colliders. Since p ∈ S<sup>1</sup> is of definite status and we have shown that paths in S<sup>1</sup> are open given Z, then p—and therefore p—does not contain nodes in Z. Thus, p is a proper, possibly causal path from X to Y in G that starts undirected and does not contain nodes in Z. It follows by Proposition 41 that the conditional effect of X on Y given Z is not identifiable in G, and we are done.

Hence, we consider when p is not possibly causal for the remainder of this case. For sake of contradiction, suppose p does not contain colliders. Since p is of definite status and starts undirected, then p—and therefore p—cannot contain an edge P<sup>i</sup> ← Pi+1, i ∈ {1, . . . , k −1}. Thus by Lemma 19, p is not of definite status. The only way for p to be of definite status while p is not is for the paths to contain at least one subpath P<sup>i</sup> − Pi+1 − Pi+2 that is unshielded in p but shielded in p. This forces i = 1, since p is a proper path in GX\{X}<sup>X</sup> . That is, p begins X − P<sup>2</sup> − P<sup>3</sup> and G contains X → P3. It follows that p(P2, Pk) is of definite status. Since p—and therefore p(P2, Pk)—does not contain an edge P<sup>i</sup> ← Pi+1, then by Lemma 19, p(P2, Pk) is possibly causal. However, p is not possibly causal, so G must contain an edge X ← P<sup>j</sup> , j ∈ {4, . . . , k}, so that G contains P<sup>3</sup> ← X ← P<sup>j</sup> . But this contradicts that p(P2, Pk) is possibly causal (Lemma 25).

Thus, p has at least one collider. Let C = {C1, . . . , Cm}, 1 ≤ m ≤ k − 3, be the set of all colliders on p in order of their appearance on p. Since we have shown that paths in S<sup>1</sup> are open given Z, every collider in C is in An(Z, GX\{X}<sup>X</sup> ). Then for each i ∈ {1, . . . , m}, let q<sup>i</sup> = ⟨C<sup>i</sup> = Qi<sup>1</sup> , . . . , Qiki = Zi⟩ be a shortest causal path from C<sup>i</sup> ∈ C to Z in GX\{X}<sup>X</sup> .

Using these paths, we turn to the task of finding DAGs in [G] that are compatible with families of interventional densities such that (35)-(36) hold. To do this, we consider the subcases below.

- SUBCASE 1: Let p be of definite status. Consider any two DAGs D<sup>1</sup> , D<sup>2</sup> ∈ [G] that include the edges X → P<sup>2</sup> and X ← P2, respectively. Then construct D<sup>1</sup> ′ and D<sup>2</sup> ′ by removing every edge from D<sup>1</sup> and D<sup>2</sup> other than those on paths corresponding to p and q1, . . . , qm. Since p is of definite status, note that the paths in D<sup>1</sup> ′ and D<sup>2</sup> ′ corresponding to p begin X → P<sup>2</sup> → · · · → C1, and X ← P<sup>2</sup> . . . C1, respectively.
- SUBCASE 2: Let p be of non-definite status. As before, this forces p to begin X − P<sup>2</sup> − P3; G to contain X → P3; and P<sup>2</sup> to be the only node on p not of definite

status. To choose DAGs in [G], we first restrict the class. Thus, construct the MPDAG G <sup>∗</sup> by adding P<sup>2</sup> → P<sup>3</sup> to G and completing Meek's (1995) orientation rules. Note that by Lemma 15, G ∗ contains X − P2. Now consider any two DAGs D<sup>1</sup> , D<sup>2</sup> ∈ [G ∗ ] ⊆ [G] that include the edges X → P<sup>2</sup> and X ← P2, respectively. And construct D<sup>1</sup> ′ and D<sup>2</sup> ′ by removing every edge from D<sup>1</sup> and D<sup>2</sup> other than those on paths corresponding to p and q1, . . . , qm. Note that the paths in D<sup>1</sup> ′ and D<sup>2</sup> ′ corresponding to p begin X → P<sup>2</sup> → · · · → C1, and X ← P<sup>2</sup> → · · · → C1, respectively.

Now that we have chosen D<sup>1</sup> , D<sup>2</sup> ∈ [G], we construct a family of interventional densities F ∗ <sup>i</sup> = {fi(v|do(x ′ )) : X′ ⊆ V} compatible with each DAG. Start by considering the following linear structural equation model (SEM). Each random variable V<sup>i</sup> ∈ V is a linear combination of its parents in D<sup>1</sup> ′ and εv<sup>i</sup> ∼ N(0, σ<sup>2</sup> vi ), where σ 2 vi ∈ (0, 1] and {εv<sup>i</sup> : V<sup>i</sup> ∈ V} are mutually independent:

$$
V_i \leftarrow \sum_{V_j \in \text{Pa}(V_i, \mathcal{D}^1')} A_{ij} V_j + \varepsilon_{v_i}.
$$
\n(37)

Each coefficient Aij in this linear combination is defined by the edge coefficient of each V<sup>i</sup> ← V<sup>j</sup> in D<sup>1</sup> ′ . We pick these edge coefficients in conjunction with {σ 2 vi : V<sup>i</sup> ∈ V} in such a way that each Aij ∈ (0, 1) and Var(Vi) = 1.

We build F ∗ <sup>1</sup> by letting f1(v) be the density of the multivariate normal generated by the SEM in (37). For the remaining densities in F ∗ 1 , we let f1(v | do(x ′ )) := f∗(v), where f<sup>∗</sup> is the density of the multivariate normal generated by taking the SEM in (37) and replacing X′ with its interventional value x ′ (Pearl, 2009). Note that D<sup>1</sup> ′ is compatible with F ∗ <sup>1</sup> by construction—and therefore, so is D<sup>1</sup> (Lemma 43).

To construct F ∗ 2 , define a linear SEM identical to the SEM in (37) but based on the parents in D<sup>2</sup> ′ . Let f2(v) be the density of the resulting distribution, which is another multivariate normal with mean vector zero and a covariance matrix with ones on the diagonal. We show below that the off-diagonal entries—which house the variables' covariances—are identical to the covariances from the SEM in (37). Thus, in an analogous way to F ∗ 1 , we can define F ∗ <sup>2</sup> = {f2(v|do(x ′ )) : X′ ⊆ V} such that D<sup>2</sup> ′—and therefore D2—is compatible with F ∗ 2 and such that f2(v) = f1(v).

To see that the covariances are identical, note that by Lemma 12, the covariances based on D′ ∈ {D<sup>1</sup> ′ , D<sup>2</sup> ′ } will equal the product of edge coefficients along non-collider paths in D′ . Since D<sup>1</sup> ′ and D<sup>2</sup> ′ have identical adjacencies, we only need to show that these DAGs have an identical set of colliders. Let q ′ 1 , . . . , q′ <sup>m</sup>, and p ′ be the paths in D′ corresponding to p and q1, . . . , q<sup>m</sup> in GX\{X}<sup>X</sup> . Recall that C is the set of all colliders on p. Then note that C is also the set of all colliders on p ′ , since P1, P3, . . . , P<sup>k</sup> are nodes of definite status on p in G and since P<sup>2</sup> is always a non-collider on p ′ . Further, by Lemma 57, C<sup>i</sup> is the only node on both p ′ and q ′ i , i ∈ {1, . . . , m}, and there is no shared node between the causal paths q ′ i and q ′ j , i ̸= j. Therefore, C is the set of all colliders on any path in either D<sup>1</sup> ′ or D<sup>2</sup> ′ .

Thus we have two families of interventional densities such that D<sup>i</sup> is compatible with F ∗ i and such that f1(v) = f2(v) so that (35) holds. To complete Case 1, we show that (36) holds. It suffices to show that E[Y | do(X = 1), Z = 0] is not the same under f<sup>1</sup> and f2. We start by calculating this expectation under f2:

$$
\mathbb{E}_{f_2}[Y \,|\, do(\mathbf{X}=\mathbf{1}), \mathbf{Z}=\mathbf{0}]
$$

$$
= \mathbb{E}_{f_2}[Y | Z_1, \dots, Z_m] |_{\mathbf{Z}=\mathbf{0}}
$$
  
=  $[\text{Cov}_{f_2}(Y, Z_1) \cdots \text{Cov}_{f_2}(Y, Z_m)] \Sigma^{-1} \mathbf{Z} |_{\mathbf{Z}=\mathbf{0}}$   
= 0,

where Σ is the covariance matrix of Z under f<sup>2</sup> (and where Σ is invertible since V is nondegenerate). The first equality follows from Rule 3 of Pearl's do calculus (Theorem 10), since Y ⊥<sup>d</sup> X | Z in D<sup>2</sup> ′ X and since f<sup>2</sup> is consistent with D<sup>2</sup> ′ . The second equality follows from properties of multivariate normals (see Lemma 11).

Next, we calculate the same expectation under f1:

$$
\mathbb{E}_{f_1}[Y \mid do(\mathbf{X} = 1), \mathbf{Z} = 0] \n= \mathbb{E}_{f_1}[Y \mid X, Z_1, \dots, Z_m] \mid_{X=1, \mathbf{Z} = 0} \n= \begin{bmatrix} \text{Cov}_{f_1}(Y, X) & \text{Cov}_{f_1}(Y, Z_1) & \cdots & \text{Cov}_{f_1}(Y, Z_m) \end{bmatrix} \Sigma^{-1} \begin{bmatrix} X \\ \mathbf{Z} \end{bmatrix} \bigg|_{X=1, \mathbf{Z} = 0} \n= \begin{bmatrix} 0 & \cdots & 0 & \text{Cov}_{f_1}(Y, Z_m) \end{bmatrix} \Sigma_1^{-1} \begin{bmatrix} 1 \\ 0 \end{bmatrix} \n= \Sigma_{m+1,1} \cdot \text{Cov}_{f_1}(Y, Z_m),
$$

where Σ is the invertible covariance matrix of (X, Z1, . . . , Zm) <sup>T</sup> under f<sup>1</sup> and where Σm+1,<sup>1</sup> is the (m + 1, 1)th entry of Σ−<sup>1</sup> . The first equality follows from Rules 3 and 2 of Pearl's do calculus (Theorem 10), since Y ⊥<sup>d</sup> X \ {X} | X, Z in D<sup>1</sup> ′ X , since Y ⊥<sup>d</sup> X | Z in D<sup>1</sup> ′ <sup>X</sup>, and since f<sup>1</sup> is consistent with D<sup>1</sup> ′ . The second equality follows from properties of multivariate normals (see Lemma 11), and the third follows from applying Wright's Rule (Lemma 12) to D<sup>1</sup> ′ .

To complete Case 1, we show this expectation is non-zero so that (36) holds. Note that Covf<sup>1</sup> (Y, Zm) ̸= 0, since by Lemma 12, it equals the product of all edge coefficients on −(q ′ <sup>m</sup>) ⊕ p ′ (Cm, Y ) in D<sup>1</sup> ′ , which were chosen to be in (0, 1). To show that Σm+1,<sup>1</sup> ̸= 0, we find the following.

$$
\Sigma = \begin{bmatrix}\n1 & \text{Cov}_{f_1}(X, Z_1) & 0 & 0 \\
\text{Cov}_{f_1}(X, Z_1) & 1 & \ddots & 0 \\
\text{Cov}_{f_1}(Z_1, Z_2) & \ddots & \text{Cov}_{f_1}(Z_{m-1}, Z_m) \\
\vdots & \vdots & \ddots & 1 \\
\text{Cov}_{f_1}(Z_{m-1}, Z_m) & 1\n\end{bmatrix}.
$$
\n
$$
\Sigma_{m+1,1} = \frac{(-1)^{m+2}}{\text{Det}(\Sigma)} \cdot \text{Cov}_{f_1}(X, Z_1) \cdot \text{Cov}_{f_1}(Z_1, Z_2) \cdots \text{Cov}_{f_1}(Z_{m-1}, Z_m)
$$
\n
$$
\neq 0.
$$
\n(1)

The final equality follows by applying Wright's Rule (Lemma 12) to D<sup>1</sup> ′ and noting that the paths between X and Z<sup>1</sup> as well as Z<sup>i</sup> and Zi+1, i ∈ {1, . . . , m − 1}, have edge coefficients in (0, 1) and no colliders.

CASE 2: Consider when S<sup>3</sup> = ∅, and define the following sets.

S<sup>6</sup> = {paths in S<sup>2</sup> with the fewest edges}.

S<sup>7</sup> = {paths in S<sup>6</sup> with a shortest distance to Z in GX\{X}<sup>X</sup> }.

Pick an arbitrary path p := ⟨X = P1, . . . , P<sup>k</sup> = Y ⟩, k > 1, Y ∈ Y, in S7. Note that p begins X ← P2, since p ∈ S<sup>2</sup> is a path in GX\{X}<sup>X</sup> and S<sup>3</sup> = ∅. Further, p is a proper path from X to Y that is open given Z, since we have shown this holds for all paths in S1. Let C = {C1, . . . , Cm}, 1 ≤ m ≤ k − 3, be the set of all colliders on p in order of their appearance on p, where possibly C = ∅. Note that every node in C is in An(Z, GX\{X}<sup>X</sup> ), since p is open given Z. Then let q<sup>i</sup> = ⟨Qi<sup>1</sup> , . . . , Qiki ⟩, i ∈ {1, . . . m}, be a shortest causal path from C<sup>i</sup> to Z in GX\{X}<sup>X</sup> . Let p, q1, . . . , q<sup>m</sup> be the paths in G corresponding to p, q1, . . . , q<sup>m</sup> in GX\{X}<sup>X</sup> .

Next, recall from the beginning of the proof that there is a path in G from X to Y ∪ Z that does not contain X \ {X}, is possibly causal, and starts undirected. Let r = ⟨X = R1, . . . , Rn⟩, n > 1, be a shortest such path. When r ends in Y, it is a proper, possibly causal path from X to Y that starts undirected and does not contain nodes in Z. It follows by Proposition 41 that the conditional effect of X on Y given Z is not identifiable in G, and we are done. Hence, suppose r ends in Z for the remainder of this proof.

Using these paths, we turn to the task of finding DAGs in [G] that are compatible with families of interventional densities such that (35)-(36) hold. We start by considering a restriction of the class [G] using an MPDAG G ∗ . When X /∈ Adj(R3, G), then let G <sup>∗</sup> = G. When X ∈ Adj(R3, G), note that G cannot contain X ← R3, since r is possibly causal. Neither can G contain X − R3, since ⟨X, R3⟩ ⊕ r(R3, Rn) would contradict the definition of r as a shortest proper possibly causal path in G from X to Z that starts undirected. Thus, G contains X → R3. In this case, construct the MPDAG G <sup>∗</sup> by adding R<sup>2</sup> → R<sup>3</sup> to G (if it does not already exist) and completing Meek's (1995) orientation rules. Note by Lemma 15 that G ∗ still contains X − R2, since X, R<sup>2</sup> ∈ Pa(R3, G ∗ ).

With G <sup>∗</sup> defined, we let D<sup>1</sup> be a DAG in [G ∗ ] ⊆ [G] that contains X → R2. To see that the path in D<sup>1</sup> corresponding to r in G takes the form X → R<sup>2</sup> → · · · → Rn, note that r(R2, Rn) is unshielded by the definition of r as a shortest possibly causal path. So when X /∈ Adj(R3, G), the claim holds by R1 of Meek (1995) since we formed D<sup>1</sup> by adding X → R<sup>2</sup> to G. When X ∈ Adj(R3, G), then the same logic holds since we formed D<sup>1</sup> by adding X → R<sup>2</sup> → R<sup>3</sup> to G. Further, note that by Lemma 58, G—and therefore D1 contains the edge ⟨P2, R2⟩. Since D<sup>1</sup> is acyclic and has the path P<sup>2</sup> → X → R2, then it contains P<sup>2</sup> → R<sup>2</sup> so that P<sup>2</sup> is a non-collider on ⟨P3, P2, R2⟩ in D<sup>1</sup> .

Similarly, we let D<sup>2</sup> be a DAG in [G ∗ ] ⊆ [G] that contains X ← R<sup>2</sup> → R3. (This DAG clearly exists when G ∗ contains X −R<sup>2</sup> → R3. When instead G ∗ contains X −R<sup>2</sup> −R3, this DAG exists by Lemma 16.) Then note that the path in D<sup>2</sup> corresponding to r in G takes the form X ← R<sup>2</sup> → · · · → R<sup>n</sup> by R1 of Meek (1995), since r(R2, Rn) is unshielded and possibly causal. To see that P<sup>2</sup> is a non-collider on ⟨P3, P2, R2⟩ in D<sup>1</sup> , note that by Lemma 58, G must contain P<sup>2</sup> → R2; or P<sup>3</sup> ← P2; or P<sup>3</sup> − P<sup>2</sup> − R<sup>2</sup> such that P<sup>3</sup> ∈/ Adj(R2, G).

Now that we have chosen D<sup>1</sup> , D<sup>2</sup> ∈ [G], we construct a family of interventional densities F ∗ <sup>i</sup> = {fi(v|do(x ′ )) : X′ ⊆ V} compatible with each DAG. Start by constructing a DAG D<sup>1</sup> ′ by removing every edge from D<sup>1</sup> except those on the paths corresponding to p, q1, . . . , qm, r, and ⟨P2, R2⟩. Then consider the following linear SEM. Each random variable V<sup>i</sup> ∈ V is a linear combination of its parents in D<sup>1</sup> ′ and εv<sup>i</sup> ∼ N(0, σ<sup>2</sup> vi ), where {εv<sup>i</sup> : V<sup>i</sup> ∈ V} are mutually independent; where the coefficients in the SEM are all <sup>1</sup> 2 ; and where we choose σ 2 vi such that Var(Vi) = 1 for all V<sup>i</sup> ∈ V:

$$
V_i \leftarrow \sum_{V_j \in \text{Pa}(V_i, \mathcal{D}^{1'})} \frac{1}{2} V_j + \varepsilon_{v_i}.
$$
\n(38)

We build F ∗ <sup>1</sup> by letting f1(v) be the density of the multivariate normal generated by this SEM. For the remaining densities in F ∗ 1 , we let f1(v | do(x ′ )) := f∗(v), where f<sup>∗</sup> is the density of the multivariate normal generated by taking the SEM in (38) and replacing X′ with its interventional value x ′ (Pearl, 2009). Note that D<sup>1</sup> ′ is compatible with F ∗ <sup>1</sup> by construction—and therefore, so is D<sup>1</sup> (Lemma 43).

To construct F ∗ 2 consider the following linear SEM. Each random variable V<sup>i</sup> ∈ V is a linear combination of its parents in D<sup>2</sup> ′ and εv<sup>i</sup> ∼ N(0, σ<sup>2</sup> vi ), where {εv<sup>i</sup> : V<sup>i</sup> ∈ V} are mutually independent:

$$
V_i \leftarrow \sum_{V_j \in \text{Pa}(V_i, \mathcal{D}^2)} A_{ij} V_j + \varepsilon_{v_i}.
$$
\n(39)

Each coefficient Aij in this linear combination is defined by the edge coefficient of ⟨V<sup>i</sup> , V<sup>j</sup> ⟩ in D<sup>2</sup> ′ . We set the edge coefficients for ⟨X, P2⟩, ⟨X, R2⟩, ⟨P2, R2⟩ to − 1 7 , 6 7 , 3 4 , respectively, and we set the remaining Aij = 1 2 . Further, we choose {σ 2 vi : V<sup>i</sup> ∈ V} so that Var(Vi) = 1. Then let f2(v) be the density of the resulting distribution, which is another multivariate normal with mean vector zero and a covariance matrix with ones on the diagonal. We show below that the off-diagonal entries—which house the variables' covariances—are identical to the covariances from the SEM in (38). Thus, in an analogous way to F ∗ 1 , we can define F ∗ <sup>2</sup> = {f2(v|do(x ′ )) : X′ ⊆ V} such that D<sup>2</sup> ′—and therefore D2—is compatible with F ∗ 2 and such that f2(v) = f1(v).

To see that the covariances are identical, note that by Lemma 12, the covariances based on D′ ∈ {D<sup>1</sup> ′ , D<sup>2</sup> ′ } will equal the product of edge coefficients along non-collider paths in D′ . Consider the paths in D′ and their colliders. By Lemmas 57-58, the paths in D′ corresponding to p, q1, . . . , qm, r do not overlap anywhere except at X and C<sup>i</sup> , i ∈ {1, . . . , m}. Then note that D′ contains no colliders on q1, . . . , qm, ⟨R1, . . . , Rn⟩, or ⟨P3, P2, R2, R3⟩. To see that that C is the set of all colliders on ⟨P1, . . . , Pk⟩, note that p is of definite status in G, since p ∈ S<sup>1</sup> is a definite status path in GX\{X}<sup>X</sup> that begins X ← P<sup>2</sup> and has no nodes in X \ {X}. However, note that D<sup>1</sup> ′ contains X → R<sup>2</sup> ← P2, whereas D<sup>2</sup> ′ contains P<sup>2</sup> → X ← R2. Therefore, the claim that the covariances from (38) and (39) are identical holds after calculating the following for both models: Cov(P2, X) = <sup>1</sup> 2 , Cov(P2, R2) = <sup>3</sup> 4 , Cov(P2, R3) = <sup>3</sup> 8 , Cov(X, R2) = <sup>3</sup> 4 .

Thus we have two families of interventional densities such that D<sup>i</sup> is compatible with F ∗ i and such that (35) holds. To complete Case 2, we show that (36) holds. It suffices to show that E[Y | do(X = 1), Z = 0] is not the same under f<sup>1</sup> and f2. We start by calculating this expectation under f2. For ease of notation, let Z<sup>0</sup> = R<sup>n</sup> and let Z<sup>i</sup> = Qiki for all i ∈ {1, . . . , m}.

$$
\mathbb{E}_{f_2}[Y \,|\, do(\mathbf{X} = \mathbf{1}), \mathbf{Z} = \mathbf{0}]
$$

$$
= \mathbb{E}_{f_2}[Y | Z_0, ..., Z_m] |_{\{Z_0, ..., Z_m\} = 0}
$$
  
=  $[\text{Cov}_{f_2}(Y, Z_0) \cdots \text{Cov}_{f_2}(Y, Z_m)] \Sigma^{-1} \begin{bmatrix} Z_0 \\ \vdots \\ Z_m \end{bmatrix} |_{\{Z_0, ..., Z_m\} = 0}$   
= 0,

where Σ is the covariance matrix of {Z0, . . . , Zm} <sup>T</sup> under f<sup>2</sup> (and where Σ is invertible since V is non-degenerate). The first equality follows from Rules 3 and 1 of Pearl's do calculus (Theorem 10), since Y ⊥<sup>d</sup> X | Z in D<sup>2</sup> ′ X ; since Y ⊥<sup>d</sup> Z \ {Z0, . . . , Zm} |Z0, . . . , Z<sup>m</sup> in D<sup>2</sup> ′ ; and since f<sup>2</sup> is consistent with D<sup>2</sup> ′ . The second equality follows from properties of multivariate normals (see Lemma 11).

Next, we calculate the same expectation under f1. In each of the subcases below, we show that Ef<sup>1</sup> [Y |do(X = 1), Z = 0] is non-zero so that (36) holds. For these calculations, note that f1(y | do(x), z) is the conditional density of Y | Z under f∗(v).

• SUBCASE 1: When p ′ has no colliders in D<sup>1</sup> ′ ,

$$
\mathbb{E}_{f_1}[Y \mid do(\mathbf{X} = 1), \mathbf{Z} = 0] = \mathbb{E}_{f_*}[Y \mid \mathbf{Z}] \big|_{\mathbf{x} = 1, \mathbf{Z} = 0}
$$
  
\n
$$
= \mathbb{E}_{f_*}[Y \mid Z_0] \big|_{x = 1, Z_0 = 0}
$$
  
\n
$$
= \mathbb{E}_{f_*}[Y] + \frac{\text{Cov}_{f_*}(Y, Z_0)}{\text{Var}_{f_*}(Z_0)} \cdot \left(Z_0 - \mathbb{E}_{f_*}[Z_0]\right) \big|_{x = 1, Z_0 = 0}
$$
  
\n
$$
= \frac{\text{Cov}_{f_*}(Y, Z_0)}{\text{Var}_{f_*}(Z_0)} \cdot \left(-\frac{1}{2}^{n-1}\right)
$$
  
\n
$$
\neq 0.
$$

The third equality follows from properties of multivariate normals (see Lemma 11). For the final equality, consider Lemma 13, and note that the SEM that defines f∗(v) under do(X) has a matrix of coefficients that are non-zero exactly when D<sup>1</sup> ′ X contains an edge. It follows that Covf<sup>∗</sup> (Y, Z0) ̸= 0, since D<sup>1</sup> ′ X contains a node in {P2, . . . , Pk} with causal paths to Y and Z0.

• SUBCASE 2: When p ′ has at least one collider,

$$
\mathbb{E}_{f_1}[Y \mid do(\mathbf{X} = 1), \mathbf{Z} = 0]
$$
\n
$$
= \mathbb{E}_{f_*}[Y \mid \mathbf{Z}] \mid_{\mathbf{x} = 1, \mathbf{Z} = 0}
$$
\n
$$
= \mathbb{E}_{f_*}[Y \mid Z_0, \dots, Z_m] \mid_{x = 1, \{Z_0, \dots, Z_m\} = 0}
$$
\n
$$
= \mathbb{E}_{f_*}[Y] + [\text{Cov}_{f_*}(Y, Z_0) \cdots \text{Cov}_{f_*}(Y, Z_m)] \Sigma^{-1} \begin{bmatrix} Z_0 - \mathbb{E}_{f_*}[Z_0] \\ \vdots \\ Z_m - \mathbb{E}_{f_*}[Z_m] \end{bmatrix} \bigg|_{\substack{x = 1, \\ Z_0, \dots, Z_m} = 0}
$$
\n
$$
= \frac{1}{2}^{k'_m} \cdot \Sigma_{m+1, 1} \cdot \big( - \frac{1}{2}^{n-1} \big),
$$

where k ′ <sup>m</sup> is the number of edges on (−q ′ <sup>m</sup>)(Zm, Cm) ⊕ p ′ (Cm, Y ); where Σ is the invertible covariance matrix of (Z0, . . . , Zm) <sup>T</sup> under f∗; and where Σm+1,<sup>1</sup> is the (m+ 1, 1)th entry of Σ−<sup>1</sup> . The third equality follows from properties of multivariate normals (see Lemma 11). The last two equalities follow by Lemma 13, since D<sup>1</sup> ′ X contains no node with causal paths to Y and Z<sup>i</sup> , i ∈ {0, . . . , m − 1}, but D<sup>1</sup> ′ X does contain a node with causal paths to Y and Z0.

To complete Subcase 2, we show that Σm+1,<sup>1</sup> ̸= 0.

$$
\Sigma = \begin{bmatrix} 1 & \text{Cov}_{f_{*}}(Z_{0}, Z_{1}) & & \cdots & & & 0 \\ \text{Cov}_{f_{*}}(Z_{0}, Z_{1}) & 1 & \cdots & & & 0 \\ & & \text{Cov}_{f_{*}}(Z_{1}, Z_{2}) & \cdots & & & & 0 \\ 0 & & & \cdots & \text{Cov}_{f_{*}}(Z_{m-1}, Z_{m}) & & \\ & & & 1 & & \text{Cov}_{f_{*}}(Z_{m}, Y) \\ & & & & 1 & \end{bmatrix}.
$$

$$
\Sigma_{m+1,1} = \frac{(-1)^{m+2}}{\mathrm{Det}(\Sigma)} \mathrm{Cov}_{f_*}(Z_0, Z_1) \cdots \mathrm{Cov}_{f_*}(Z_{m-1}, Z_m)
$$
  
\n
$$
\neq 0.
$$

The final equality follows from Lemma 13, since for each i ∈ {0, . . . , m − 1}, D<sup>1</sup> ′ X contains a node in {P2, . . . , Pk} with causal paths to Z<sup>i</sup> and Zi+1.

#### G.2 Supporting Results

Lemma 55 Let p = ⟨V1, . . . , Vk⟩, k > 1, be a definite status path in G = (V, E), where G is either a causal MPDAG or there exists a causal MPDAG G ′ and node sets A ⊆ V, and B ⊆ V \ A such that G ≡ G′ AB. Further, let C ⊆ V.

Suppose p is d-connecting given C in G and suppose G contains an edge ⟨V<sup>i</sup> , V<sup>j</sup> ⟩, 1 ≤ i < j ≤ k, such that t = p(V1, . . . , Vi) ⊕ ⟨V<sup>i</sup> , V<sup>j</sup> ⟩ ⊕ p(V<sup>j</sup> , Vk) is also a definite status path in G. If V<sup>i</sup> and V<sup>j</sup> are definite non-colliders or endpoints on p, then t is also d-connecting given C.

Proof of Lemma 55. If V<sup>i</sup> and V<sup>j</sup> are still definite non-colliders (or endpoints) on t, the statement clearly holds. Hence, suppose that one of V<sup>i</sup> or V<sup>j</sup> is a collider on t. Without loss of generality, we will assume that it is V<sup>i</sup> that is a collider on t. Then Vi−<sup>1</sup> → V<sup>i</sup> → Vi+1 must be on p, whereas Vi−<sup>1</sup> → V<sup>i</sup> ← V<sup>j</sup> is on G.

Consider p(V<sup>i</sup> , V<sup>j</sup> ). This path cannot take the form V<sup>i</sup> → · · · → V<sup>j</sup> by the acyclicity of G ′ . Further, p cannot contain V<sup>l</sup> → Vl+1 − Vl+1, it is of definite status. Hence, there must be a collider on p(V<sup>i</sup> , V<sup>j</sup> ) in De(V<sup>i</sup> , G). Since this collider is in An(C, G), it also holds that V<sup>i</sup> ∈ An(C, G). Therefore, t is still d-connecting given C.

Lemma 56 Let X, Y, Z be pairwise disjoint node sets in a causal MPDAG G = (V, E). Suppose there is no possibly causal path in G from X to Y that starts undirected and does not contain X\ {X} ∪ Z. Further, suppose there is a possibly causal path in G from X to Z that starts undirected and does not contain X \ {X} ∪ Y, where (X ̸⊥<sup>d</sup> Y|X \ {X}, Z)GX\{X}<sup>X</sup> . Then consider the following sets.

$$
\mathbf{S_1} = \left\{ \begin{array}{c} \text{definite status paths in } \mathcal{G}_{\overline{\mathbf{X} \setminus \{X\} \underline{X}}} \text{ from } X \text{ to } \mathbf{Y} \text{ that are} \\ \text{d-connected } \text{given } \mathbf{X} \setminus \{X\} \cup \mathbf{Z} \end{array} \right\}.
$$

S<sup>2</sup> = {paths in S<sup>1</sup> with the fewest colliders}.

S<sup>3</sup> = {paths in S<sup>2</sup> that start undirected}. S<sup>4</sup> = {paths in S<sup>3</sup> with the fewest edges}. S<sup>5</sup> = {paths in S<sup>4</sup> with a shortest distance to Z in GX\{X}<sup>X</sup> }. S<sup>6</sup> = {paths in S<sup>2</sup> with the fewest edges}.

S<sup>7</sup> = {paths in S<sup>6</sup> with a shortest distance to Z in GX\{X}<sup>X</sup>

When S<sup>3</sup> ̸= ∅, pick an arbitrary path in S5. When S<sup>3</sup> = ∅, pick an arbitrary path in S7. Call this path p := ⟨X = P1, . . . , P<sup>k</sup> = Y ⟩, k > 1, Y ∈ Y, and let p ∗ be the path in G corresponding to p in GX\{X}<sup>X</sup> . Then the following hold.

}.

- (i) p contains no nodes in X \ {X} or Y \ {Y }.
- (ii) G does not contain X − P<sup>i</sup> for any i > 2.
- (iii) Every collider on p or p ∗ is unshielded in GX\{X}<sup>X</sup> or G, respectively.

#### Proof of Lemma 56.

- (i) Since p is a d-connecting given X\{X}∪Z, no definite non-collider on p is in X\{X}. Also, since all edges into X \ {X} are removed in GX\{X}<sup>X</sup> , no collider on p is in X \ {X}. To show that P<sup>k</sup> = Y is the only node from Y on p, it is enough to notice that otherwise, for P<sup>l</sup> ∈ Y, l ∈ {2, . . . , k − 1} we could choose p(X, Pl) instead of p.
- (ii) We show that X − P<sup>i</sup> is not in G for any i > 2 by contradiction. Hence, let j ∈ {3, . . . , k} be the largest index such that X − P<sup>j</sup> is in G. Now, j ̸= k since otherwise, X − Y is in G, which contradicts our assumptions.

Next, suppose that 2 < j < k and X − P<sup>j</sup> is in G. If P<sup>j</sup> → Pj+1 is on p, we have a contradiction with the choice of p, since we could have chosen ⟨X, P<sup>j</sup> ⟩ ⊕ p(P<sup>j</sup> , Y ). We get the same contradiction if P<sup>j</sup> − Pj+1 is in G and X /∈ Adj(Pj+1, GX\{X}<sup>X</sup> ).

Two cases are left to consider, the case when P<sup>j</sup> − Pj+1 and X ← Pj+1 are in G and GX\{X}<sup>X</sup> , and the case when P<sup>j</sup> ← Pj+1 and X ← Pj+1 are in G and GX\{X}<sup>X</sup> (by choice of j, we cannot have X −Pj+1 in G). In both cases, s = ⟨X, Pj+1⟩⊕p(Pj+1, Y ), s ∈ S<sup>1</sup> (as Pj+1 is a definite non-collider on both p and s). Furthermore, s cannot have more colliders than p, so s ∈ S2.

Suppose next that S<sup>3</sup> = ∅, that is p ∈ S7. Since s has fewer edges than p, we have a contradiction with the choice of p.

Otherwise, S<sup>3</sup> ̸= ∅. Now, for p to be in S<sup>5</sup> ⊆ S<sup>3</sup> ⊆ S2, we need to have that p(X, Pj+1) contains no colliders and that p starts undirected. Furthermore, since p is of definite status, we have that Pi−<sup>1</sup> − P<sup>i</sup> ← Pi+1, i ∈ {2, . . . , j} cannot be on p(X, Pj+1). Combining the information that P<sup>i</sup> → Pi+1 ← Pi+2 and P<sup>i</sup> −Pi+1 ← Pi+2 cannot be on p(X, Pj+1), for i ∈ {1, j − 1} and that X − P<sup>2</sup> is on p(X, Pj+1) leads us to conclude that P<sup>l</sup> ← Pl+1, l ∈ {1, . . . , j} cannot be on p(X, Pj+1), either.

If p ∗ is of definite status, then since P<sup>l</sup> ← Pl+1, l ∈ {1, . . . , j} is not on p ∗ (X, Pj+1), we have that p ∗ (X, Pj+1) is possibly causal in G (Lemma 19). Therefore, X ← Pj+1 being in G is a contradiction.

Otherwise, p ∗ is not of definite status in G. This implies that X → P<sup>3</sup> is in G (and not in GX\{X}<sup>X</sup> ). Moreover, case (i) implies that p ∗ (P2, Pj+1) is of definite status. Hence, since P<sup>l</sup> ← Pl+1, l ∈ {1, . . . , j} is not on p ∗ (X, Pj+1), we have that p ∗ (P2, Pj+1) is possibly causal in G (Lemma 19). But then the fact that p ∗ (P3, Pj+1) is possibly causal and Pj+1 → X → P<sup>3</sup> is in G, contradicts Lemma 25.

(iii) Next, we show that every collider on p is unshielded. Hence, for the rest of the proof we will assume that there is at least one collider on p. By case (i), p does not contain any node in X \ {X}. So for the colliders on p ∗ to be unshielded, it is enough to show that colliders on p are unshielded. Also, note that any path in S<sup>1</sup> must be d-connecting given Z (since all edges into X \ {X} are removed in GX\{X}<sup>X</sup> ).

Let C = {C1, . . . , Cm}, 1 ≤ m ≤ k−3, be the set of all colliders on p, labeled such that if 1 ≤ i < j ≤ m, C<sup>i</sup> ≡ P<sup>l</sup> , C<sup>j</sup> ≡ Pr, 2 ≤ l < r ≤ k − 1. Then each C<sup>i</sup> , i ∈ {1, . . . , m} is in An(Z, GX\{X}<sup>X</sup> ). Let q<sup>i</sup> = ⟨C<sup>i</sup> = Qi<sup>1</sup> , . . . , Qiki ⟩, be a shortest directed path from C<sup>i</sup> to Z in GX\{X}<sup>X</sup> . Note that Qiki is the only node in Z on q<sup>i</sup> and that q<sup>i</sup> cannot contain nodes in X.

Suppose for a contradiction that a collider C<sup>i</sup> on p is shielded, that is for C<sup>i</sup> ≡ P<sup>j</sup> , j ∈ {3, . . . , k − 1}, we have that ⟨Pj−1, Pj+1⟩ is in GX\{X}<sup>X</sup> . Then consider the path s = p(X, Pj−1) ⊕ ⟨Pj−1, Pj+1⟩ ⊕ p(Pj+1, Y ) in GX\{X}<sup>X</sup> . If s is of definite status in GX\{X}<sup>X</sup> , then by Lemma 55, s must be d-connecting given Z. Then since s starts with the same edge as p, but is shorter than p, we have a contradiction with the choice of p.

Otherwise, s is not of definite status, meaning that ⟨Pj−2, Pj+1⟩ or ⟨Pj−1, Pj+2⟩, or both. are in GX\{X}<sup>X</sup> . We now split the proof into four parts depending on the position of collider C<sup>i</sup> on p and the number of colliders on p.

(1) Let i = 1 = k. That means C<sup>i</sup> = P<sup>j</sup> is the first and only collider on p. Hence, let Pl , l ≥ 1 be the closest node to X on p(X, Pj−1) that is adjacent to a node on p(Pj+1, Y ). Furthermore, let Pr, be the closest node to Y on p(Pj+1, Y ) such that ⟨P<sup>l</sup> , Pr⟩ is in GX\{X}<sup>X</sup> . Furthermore, consider the path t = p(X, Pl) ⊕ ⟨P<sup>l</sup> , Pr⟩ ⊕ p(Pr, Y ). Note that it is possible that l = 1 and r = k, meaning it is possible that p(X, Pl), p(Pr, Y ) are of length zero.

Then t must be of definite status path by construction. Also, since neither P<sup>l</sup> nor P<sup>r</sup> are colliders on p, by Lemma 55, t must also be d-connecting given X \ {X} ∪ Z. Now, if l = 1, then t starts with an edge into X (by case (ii)) and has fewer colliders than p, so we have a contradiction. If l > 1, then we again have a contradiction with the choice of p, because t and p start with the same edge, and t either has fewer colliders than p, or the same number of colliders but fewer edges than p.

(2) Let i = 1 < k. In this case, we assume i = 1 < k, so C<sup>i</sup> = P<sup>j</sup> is the collider closest to X on p, but not the only collider on p. We will now proceed similarly to the case (1).

First, let C<sup>2</sup> ≡ P<sup>w</sup> for some j + 1 < w < k. Then, let P<sup>l</sup> be the closest node to X on p(X, Pj−1) that is adjacent to a node on p(Pj+1, Pw−1). Furthermore, let Pr, be the closest node to Pw−<sup>1</sup> on p(Pj+1, Pw−1) such that ⟨P<sup>l</sup> , Pr⟩ is in GX\{X}<sup>X</sup> . Furthermore, consider the path t = p(X, Pl) ⊕ ⟨P<sup>l</sup> , Pr⟩ ⊕ p(Pr, Y ).

Note that t must be of definite status by construction, even in the case where P<sup>r</sup> ≡ Pw−1, simply because p(Pw−1, Y ) is out of Pw−1. Furthermore, since both P<sup>l</sup> and P<sup>r</sup> are non-colliders on p, we have that t is d-connecting given X\{X}∪Z by Lemma 55. Then if l = 1, t starts with an edge into X (by case (ii)) and has one fewer collider than p, which leads us to a contradiction. Otherwise, l ̸= 1, and t starts with the same edge as p, but t either has fewer colliders than p, or the same number of colliders as p but fewer edges than p which gives us the desired contradiction.

(3) Let 1 < i < k. That is, C<sup>i</sup> is not the closest collider to X or to Y on p. Let P<sup>u</sup> = Ci−<sup>1</sup> and let P<sup>w</sup> = Ci+1 and note that, 1 < u < j − 1 and j + 1 < w < k. Then, let P<sup>l</sup> be the closest node to Pu+1 on p(Pu+1, Pj−1) that is adjacent to a node on p(Pj+1, Pw−1). Furthermore, let Pr, be the closest node to Pw−<sup>1</sup> on p(Pj+1, Pw−1) such that ⟨P<sup>l</sup> , Pr⟩ is in GX\{X}<sup>X</sup> . Furthermore, consider the path t = p(X, Pl) ⊕ ⟨P<sup>l</sup> , Pr⟩ ⊕ p(Pr, Y ).

As in the cases above, t must be of definite status by construction, even in the case where P<sup>r</sup> = Pu+1, as −p(Pu+1, X) is out of Pu+1 and even if P<sup>l</sup> ≡ Pw−1, p(Pw−1, Y ) is out of Pw−1. Now, similarly to the above cases, we can show that t must also be d-connecting given X \ {X} ∪ Z (Lemma 55). And similarly to the above cases t then contradicts the choice of p.

(4) Let 1 < i = k. That is, C<sup>i</sup> is the closest collider to Y on p. Let P<sup>u</sup> = Ci−<sup>1</sup> and note that, 1 < u < j−1. Then, let P<sup>l</sup> be the closest node to Pu+1 on p(Pu+1, Pj−1) that is adjacent to a node on p(Pj+1, Y ). Furthermore, let Pr, be the closest node to Y on p(Pj+1, Y ) such that ⟨P<sup>l</sup> , Pr⟩ is in GX\{X}<sup>X</sup> . Furthermore, consider the path t = p(X, Pl) ⊕ ⟨P<sup>l</sup> , Pr⟩ ⊕ p(Pr, Y ). Now, using Lemma 55, path t leads us to a contradiction similar to above.

Lemma 57 Let X, Y, Z be pairwise disjoint node sets in a causal MPDAG G = (V, E). Suppose there is no possibly causal path in G from X to Y that starts undirected and does not contain X\ {X} ∪ Z. Further, suppose there is a possibly causal path in G from X to Z that starts undirected and does not contain X \ {X} ∪ Y, where (X ̸⊥<sup>d</sup> Y|X \ {X}, Z)GX\{X}<sup>X</sup> . Then consider the following sets.

$$
\mathbf{S_1} = \left\{ \begin{array}{c} \text{definite status paths in } \mathcal{G}_{\overline{\mathbf{X}} \setminus \{X\} \times} \text{ from } X \text{ to } \mathbf{Y} \text{ that are} \\ \text{d-connected } \mathbf{X} \setminus \{X\} \cup \mathbf{Z} \end{array} \right\}.
$$
\n
$$
\mathbf{S_2} = \left\{ \text{paths in } \mathbf{S_1} \text{ with the fewest colliders} \right\}.
$$

S<sup>3</sup> = {paths in S<sup>2</sup> that start undirected}.

S<sup>4</sup> = {paths in S<sup>3</sup> with the fewest edges}. S<sup>5</sup> = {paths in S<sup>4</sup> with a shortest distance to Z in GX\{X}<sup>X</sup> }.

S<sup>6</sup> = {paths in S<sup>2</sup> with the fewest edges}.

S<sup>7</sup> = {paths in S<sup>6</sup> with a shortest distance to Z in GX\{X}<sup>X</sup> }.

When S<sup>3</sup> ̸= ∅, pick an arbitrary path in S5. When S<sup>3</sup> = ∅, pick an arbitrary path in S7. Call this path p := ⟨X = P1, . . . , P<sup>k</sup> = Y ⟩, k > 1, Y ∈ Y. Let C = {C1, . . . , Cm}, 1 ≤ m ≤ k − 3, be the set of all colliders on p in order of their appearance on p, and let q<sup>i</sup> = ⟨C<sup>i</sup> = Qi<sup>1</sup> , . . . , Qiki ⟩ be a shortest causal path from C<sup>i</sup> to Z in GX\{X}<sup>X</sup> . Further, let C be the CPDAG that respresents all the DAGs in [G], and let p <sup>∗</sup> and q ∗ i , i ∈ {1, . . . , m}, be the paths in C corresponding to p and q<sup>i</sup> in GX\{X}<sup>X</sup> .

Then if C ̸= ∅, the following hold.

- (i) Each q ∗ i is causal.
- (ii) C<sup>i</sup> is the only node on both p and qi.
- (iii) q<sup>i</sup> and q<sup>j</sup> do not share any nodes, where i ̸= j.

#### Proof of Lemma 57.

(i) Note that none of the nodes on q<sup>i</sup> are in X, as q<sup>i</sup> is a path in GX\{X}<sup>X</sup> . Also, the only node on q<sup>i</sup> that is in Z is Qiki (otherwise, we can choose a shorter path). Therefore, q ∗ <sup>i</sup> must be a possibly directed unshielded path from C<sup>i</sup> to Z in C.

Furthermore, by Lemma 56, all colliders on p are unshielded and none of nodes on p are in X\{X}. Hence, let P<sup>j</sup> = C<sup>i</sup> , j > 2, then Pj−<sup>1</sup> → P<sup>j</sup> ← Pj+1 is an unshielded collider on p ∗ in C. Then if either Pj−<sup>1</sup> ∈/ Adj(Qi<sup>2</sup> , C), or Pj+1 ∈/ Adj(Qi<sup>2</sup> , C), Qi<sup>1</sup> → Qi<sup>2</sup> is in C by Lemma 17. Then in turn, q ∗ <sup>i</sup> must be a directed path in C.

Otherwise, Pj−<sup>1</sup> → Qi<sup>2</sup> ← Pj+1 must be in C (and G). But in this case, depending on whether Qi<sup>2</sup> is on p, we can derive a contradiction with the choice of p.

For instance, if Qi<sup>2</sup> is not a node on p, then clearly p(X, Pj−1) ⊕ ⟨Pj−1, Qi<sup>2</sup> , Pj+1⟩ ⊕ p(Pj+1, Y ) is a path with exactly the same properties as p, but with a shorter distance to Z, which leads us to a contradiction with the choice fo p. Otherwise, Qi<sup>2</sup> is on p, so either (a) Qi<sup>2</sup> is on p(X, Pj−1), or (b) Qi<sup>2</sup> is on p(Pj+1, Y )

(a) If Qi<sup>2</sup> is a collider on p(X, Pj−1), then p(X, Qi<sup>2</sup> ) ⊕ ⟨Qi<sup>2</sup> , Pj+1⟩ ⊕ p(Pj+1, Y ) gives us the desired path to derive the contradiction. If Qi<sup>2</sup> is a definite non-collider on p and if −p(Qi<sup>2</sup> , X) is out of Qi<sup>2</sup> , we again have that p(X, Qi<sup>2</sup> )⊕ ⟨Qi<sup>2</sup> , Pj+1⟩⊕ p(Pj+1, Y ) gives us the desired contradiction. Otherwise, Qi<sup>2</sup> is a definite noncollider on p and −p(Qi<sup>2</sup> , X) starts with an undirected edge, that is Qi2−P<sup>u</sup> . . . X, 1 < u << j − 1. But then since Pj+1 → Qi<sup>2</sup> is in C, Lemma 17, lets us conclude that Pj+1 → P<sup>l</sup> for every 1 ≤ l < u such that −p ∗ (Pu, Pl) is an undirected path. Then either Pj+1 → X is in C, or there exists an 1 < r < u, such that −p ∗ (Pr, X) starts with an edge out of Pr, and Pj+1 → P<sup>r</sup> is in C. Then we have that either ⟨X, Pj+1⟩ ⊕ p(Pj+1, Y ) (which has one fewer collider than p), or p(X, Pr) ⊕ ⟨Pr, Pj+1⟩ ⊕ p(Pj+1, Y ) that leads us to the desired contradiction.

- (b) If Qi<sup>2</sup> is a collider on p(Pj+1, Y ), then p(X, Pj−1) ⊕ ⟨Pj−1, Qi<sup>2</sup> ⟩ ⊕ p(Qi<sup>2</sup> , Y ) gives us the desired path to derive the contradiction. If Qi<sup>2</sup> is a definite non-collider on p(Pj+1, Y ) and if p(Qi<sup>2</sup> , Y ) is out of Qi<sup>2</sup> , we have that p(X, Pj−1)⊕ ⟨Pj−1, Qi<sup>2</sup> ⟩ ⊕ p(Qi<sup>2</sup> , Y ) gives us the desired contradiction. Otherwise, Qi<sup>2</sup> is a definite noncollider on p(Pj+1, Y ) and p(Qi<sup>2</sup> , Y ) starts with an undirected edge, that is Qi<sup>2</sup> − P<sup>u</sup> . . . Y , j + 1 < u < k. But then since Pj−<sup>1</sup> → Qi<sup>2</sup> is in C, Lemma 17, lets us conclude that Pj−<sup>1</sup> → P<sup>l</sup> for every u < l ≤ k such that p ∗ (Pu, Pl) is an undirected path. Then either Pj−<sup>1</sup> → Y is in C, or there exists an u < r < k, such that p ∗ (Pr, Y ) starts with an edge out of Pr, and Pj−<sup>1</sup> → P<sup>r</sup> is in C. Then we have that either p(X, Pj−1) ⊕ ⟨Pj−1, Y ⟩, or p(X, Pj−1) ⊕ ⟨Pj−1, Pr⟩ ⊕ p(Pr, Y ) that leads us to the desired contradiction.
- (ii) Next, we show that the only node that q<sup>i</sup> and p have in common is C<sup>i</sup> . Hence, suppose for a contradiction that Qi<sup>d</sup> , d ∈ {2, . . . , Qiki } is the closest node to C<sup>i</sup> on q that is also p. Then Qi<sup>d</sup> is either (a) on p(X, Pj−1), or (b) on p(Pj+1, Y ).
  - (a) In this case, Qi<sup>d</sup> is either a collider or a definite non-collider on p(X, Pj−1). If Qi<sup>d</sup> is a collider on p(X, Pj−1), then p(X, Qi<sup>d</sup> ) ⊕ (−qi(Qi<sup>d</sup> , P<sup>j</sup> )) ⊕ p(P<sup>j</sup> , Y ) gives us the desired path to derive the contradiction. If Qi<sup>d</sup> is a definite non-collider on p(X, Pj−1) and −p(Qi<sup>d</sup> , X) is a path that starts with a directed edge out of Qi<sup>d</sup> , we again have that p(X, Qi<sup>d</sup> ) ⊕ (−qi(Qi<sup>d</sup> , P<sup>j</sup> )) ⊕ p(P<sup>j</sup> , Y ) gives us the desired contradiction. Otherwise, Qi<sup>d</sup> is a definite non-collider on p(X, Pj−1) and −p(Qi<sup>d</sup> , X) starts with an undirected edge, that is Qi<sup>d</sup> − P<sup>u</sup> . . . X, for some u ∈ {1, . . . , j − 2}. But then, we have by case (i) that Qid−<sup>1</sup> → Qi<sup>d</sup> is in C. Then Lemma 17, lets us conclude that Qid−<sup>1</sup> → P<sup>l</sup> for every 1 ≤ l < u such that −p ∗ (Pu, Pl) is an undirected path. Then either Qid−<sup>1</sup> → X is in C, or there exists an 1 < r < u, such that −p ∗ (Pr, X) starts with an edge out of Pr, and Qid−<sup>1</sup> → P<sup>r</sup> is in C. Then we have that either ⟨X, Qid−<sup>1</sup> ⟩ ⊕ (−q(Qid−<sup>1</sup> , P<sup>j</sup> )) ⊕ p(P<sup>j</sup> , Y ), or p(X, Pr) ⊕ ⟨Pr, Qi<sup>2</sup> ⟩ ⊕ (−q(Qid−<sup>1</sup> , P<sup>j</sup> )) ⊕ p(P<sup>j</sup> , Y ) contradict the choice of p, since both of these paths contain one fewer collider compared to p.
  - (b) In this case, Qi<sup>d</sup> is either a collider or a definite non-collider on p(Pj+1, Y ). If Qi<sup>d</sup> is a collider on p(Pj+1, Y ), then p(X, Pj−1) ⊕ qi(Pj−1, Qi<sup>d</sup> ) ⊕ p(Qi<sup>d</sup> , Y ) gives us the desired path to derive the contradiction. If Qi<sup>d</sup> is a definite noncollider on p(Pj+1, Y ) and p(Qi<sup>d</sup> , Y ) is a path that starts with a directed edge out of Qi<sup>d</sup> , we again have that p(X, P<sup>j</sup> ) ⊕ qi(PjQi<sup>d</sup> )) ⊕ p(Qi<sup>d</sup> , Y ) gives us the desired contradiction. Otherwise, Qi<sup>d</sup> is a definite non-collider on p(Pj+1, Y ) and p(Qi<sup>d</sup> , Y ) starts with an undirected edge, that is Qi<sup>d</sup> − P<sup>u</sup> . . . Y , for some u ∈ {j + 2, . . . , k}. But then, since by case (i) Qid−<sup>1</sup> → Qi<sup>d</sup> is in C, Lemma 17, lets us conclude that Qid−<sup>1</sup> → P<sup>l</sup> for every u ≤ l < k such that p ∗ (Pu, Pl) is an undirected path. Then either Qid−<sup>1</sup> → Y is in C, or there exists an u < r < k, such that p ∗ (Pr, Y ) starts with a directed edge out of Pr, and Qid−<sup>1</sup> → P<sup>r</sup> is in C. Then we have that either p(X, Pj−1) ⊕ q(Pj−1, Qid−<sup>1</sup> ) ⊕ ⟨Qid−<sup>1</sup> , Y ⟩, or p(X, Pj−1) ⊕ q(Pj−1, Qid−<sup>1</sup> ) ⊕ ⟨Qid−<sup>1</sup> , Pr⟩ ⊕ p(Pr, Y ) contradict the choice of p, since both of these paths contain one fewer collider compared to p.

(iii) Lastly, we show that q<sup>i</sup> and q<sup>j</sup> such that i, j ∈ {1, . . . , m}, i < j cannot contain a node in common by contradiction. Hence, let Qi<sup>d</sup> , d > 1, be the closest node to Qi<sup>1</sup> on q<sup>i</sup> that is also on q<sup>j</sup> . Then the path p(X, Ci) ⊕ qi(C<sup>i</sup> , Qi<sup>d</sup> ) ⊕ (−q<sup>j</sup> (Qi<sup>d</sup> , C<sup>j</sup> )) ⊕ p(C<sup>j</sup> , Y ) contradicts the choice of p as it contains one fewer collider than p.

Lemma 58 Let X, Y, Z be pairwise disjoint node sets in a causal MPDAG G = (V, E). Suppose there is no possibly causal path in G from X to Y that starts undirected and does not contain X\ {X} ∪ Z. Further, suppose there is a possibly causal path in G from X to Z that starts undirected and does not contain X \ {X} ∪ Y, where (X ̸⊥<sup>d</sup> Y|X \ {X}, Z)GX\{X}<sup>X</sup> . Let r <sup>∗</sup> = ⟨X = R1, . . . , Rk<sup>0</sup> ⟩, k<sup>0</sup> > 1, be a shortest such path, and let r be the corresponding sequence of nodes in GX\{X}<sup>X</sup> . Then consider the following sets.

> S<sup>1</sup> = definite status paths in GX\{X}<sup>X</sup> from X to Y that are d-connecting given X \ {X} ∪ Z . S<sup>2</sup> = {paths in S<sup>1</sup> with the fewest colliders}. S<sup>3</sup> = {paths in S<sup>2</sup> that start undirected}.

S<sup>6</sup> = {paths in S<sup>2</sup> with the fewest edges}. S<sup>7</sup> = {paths in S<sup>6</sup> with a shortest distance to Z in GX\{X}<sup>X</sup>

Suppose S<sup>3</sup> = ∅, and pick an arbitrary path p := ⟨X = P1, . . . , P<sup>k</sup> = Y ⟩, k > 1, Y ∈ Y in S7. Let C = {C1, . . . , Cm}, 1 ≤ m ≤ k − 3, be the set of all colliders on p in order of their appearance on p, and let q<sup>i</sup> := ⟨C<sup>i</sup> = Qi<sup>1</sup> , . . . , Qiki ⟩ be a shortest causal path from C<sup>i</sup> to Z in GX\{X}<sup>X</sup> . Then the following hold.

}.

- (i) r is a path in GX\{X}<sup>X</sup> .
- (ii) r ∗ is unshielded in G and does not contain nodes in Z \ {Rk<sup>0</sup> }.
- (iii) GX\{X}<sup>X</sup> does not contain X − R<sup>i</sup> for any i ̸= 2.
- (iv) Either GX\{X}<sup>X</sup> contains P<sup>2</sup> → R2, or it contains P<sup>2</sup> − R<sup>2</sup> where P<sup>2</sup> ∈ { / R2, . . . , Rk<sup>0</sup> }. Further, if P<sup>2</sup> ∈ Adj(R<sup>i</sup> , GX\{X}<sup>X</sup> ), i > 2, then G contains P<sup>2</sup> → R<sup>i</sup> or P<sup>2</sup> − Ri.
- (v) If P<sup>i</sup> is a definite non-collider on p, then R<sup>2</sup> ∈/ Adj(P<sup>i</sup> , G) for any i ̸= 2.
- (vi) X is the only node on both r and p.
- (vii) r and q<sup>i</sup> do not share any nodes.

### Proof of Lemma 58.

- (i) Since r does not contain a node from X \ {X} and since X − R<sup>2</sup> is in G, r is a path in GX\{X}<sup>X</sup> .
- (ii) By choice of r, Rk<sup>0</sup> is the only node on r that is in Z and r must be unshielded GX\{X}<sup>X</sup> otherwise, we can choose a shorter path as r ∗ .

- (iii) X − R<sup>i</sup> is not in GX\{X}<sup>X</sup> for any i ̸= 2, otherwise we can choose a shorter path r ∗ .
- (iv) Since r ∗ is a possibly causal path, P<sup>2</sup> ∈ { / R2, . . . , Rk<sup>0</sup> }. Also, since P<sup>2</sup> → X − R<sup>2</sup> is in GX\{X}<sup>X</sup> and since P<sup>2</sup> ∈/ X, we have that P<sup>2</sup> ∈ Adj(R2, GX\{X}<sup>X</sup> ) (since otherwise, G is not an MPDAG). We also cannot have R<sup>2</sup> → P<sup>2</sup> → X and X − R<sup>2</sup> in G, due to Lemma 25. Then P<sup>2</sup> → R<sup>2</sup> or P<sup>2</sup> − R<sup>2</sup> is in G. Similarly if P<sup>2</sup> ∈ Adj(R<sup>i</sup> ) for any i ∈ {3, . . . , k0}, we know that R<sup>i</sup> → P<sup>2</sup>

, GX\{X}<sup>X</sup> cannot be in G otherwise, R<sup>i</sup> → P<sup>2</sup> → X and Lemma 25 would contradict that r ∗ is a possibly causal path.

- (v) Suppose for a contradiction that R<sup>2</sup> ∈ Adj(P<sup>i</sup> , G) for some definite non-collider P<sup>i</sup> on p, and i > 2. Choose the definite non-collider P<sup>j</sup> on p with the largest index j ∈ {3, . . . , k} such that R<sup>2</sup> ∈ Adj(P<sup>j</sup> , G). Then consider path t = ⟨X, R2, P<sup>j</sup> ⟩ ⊕ p(P<sup>j</sup> , Y ). Note that R<sup>2</sup> is of definite status on t in GX\{X}<sup>X</sup> , since otherwise X ← P<sup>j</sup> is in G (due to Lemma 56) and ⟨X, P<sup>j</sup> ⟩⊕p(P<sup>j</sup> , Y ) contradicts the choice of p. Furthermore, P<sup>j</sup> must be of definite status on t, otherwise, R<sup>2</sup> ∈ Adj(Pj+1, GX\{X}<sup>X</sup> ) and R<sup>2</sup> − P<sup>j</sup> − Pj+1 or R2−P<sup>j</sup> ← Pj+1 is in GX\{X}<sup>X</sup> , but that contradicts the choice of P<sup>j</sup> on p. Hence, t is of definite status in GX\{X}<sup>X</sup> . Now, it is enough to show that t is d-connecting given Z to derive the contradiction. Hence, if P<sup>j</sup> is a non-collider on t, we have our contradiction. Otherwise, P<sup>j</sup> is a collider on t, which further means that Pj−<sup>1</sup> ← P<sup>j</sup> ← Pj+1 is on p and R<sup>2</sup> → P<sup>j</sup> is on t. Note that X ← · · · ← P<sup>j</sup> cannot be the form of −p(P<sup>j</sup> , X), otherwise ⟨R2, P<sup>j</sup> ⟩ ⊕ (−p(P<sup>j</sup> , R2) and X − R<sup>2</sup> contradict Lemma 25. Hence, there must be collider that is a descendant of P<sup>j</sup> on p(X, P<sup>j</sup> ), which further implies that P<sup>j</sup> ∈ An(Z, GX\{X}<sup>X</sup> ). Therefore, t is d-connecting given Z.
- (vi) Next, we show that the only node on both p and r is X. We will assume for a contradiction that there is a node on p and r that is not X. Hence let P<sup>u</sup> be chosen as the node on p with the largest index u ∈ {3, . . . , k} that is also on r, let P<sup>u</sup> ≡ Rl , l ∈ {3, . . . , k0}. Then consider path t = r(X, Pu) ⊕ p(Pu, Y ). If t is a path is of definite status and P<sup>u</sup> is a definite non-collider on t, then as t ∈ S3, we have a contradiction with the assumption that S<sup>3</sup> = ∅. If t is a path of definite status and P<sup>u</sup> is a collider on t, we still obtain a contradiction as long as there is a collider on p(X, Pu). Note that there must be such a collider on p(X, Pu) otherwise, p(X, Pu) is of the form X ← · · · ← P<sup>u</sup> and since P<sup>u</sup> ≡ R<sup>l</sup> and r ∗ (X, Rl) is a possibly causal path from X to R<sup>l</sup> we would have a contradiction with Lemma 25.

Otherwise, t is not of definite status due to Pu, and Rl−<sup>1</sup> − P<sup>u</sup> − Pu+1 or Rl−<sup>1</sup> − P<sup>u</sup> ← Pu+1 and ⟨Rl−1, Pu⟩ is in GX\{X}<sup>X</sup> . Let Pd, d ∈ {u + 1, . . . , k} be chosen so that Pd+1 is the closest collider to P<sup>u</sup> on p(Pu, Y ) or if there is no collider on p(Pu, Y ), then let, P<sup>d</sup> = Y . Consider that none of the nodes among Pu+1, . . . , P<sup>d</sup> are adjacent to X as that would imply that X − P<sup>h</sup> or X ← Ph, for h ∈ {u + 1, . . . , d} is in GX\{X}<sup>X</sup> and neither of that is possible (the former due to Lemma 56, and the latter due to the choice of p, as ⟨X, Ph⟩ ⊕ p(Ph, Y ) has all the same properties as p but is shorter).

Hence, choose as P<sup>h</sup> h ∈ {u+1, . . . , d} a node with the largest index that is adjacent to a node on r(X, Rl−1). Next, choose as Ro, o ∈ {1, . . . , l − 1} a node with the smallest index such that R<sup>o</sup> ∈ Adj(Ph, GX\{X}<sup>X</sup> ). Then consider path t = r(X, Ro)⟨Ro, Ph⟩ ⊕ p(Ph, Y ). Path t has the same properties as p but starts with an undirected edge, which contradicts that S<sup>3</sup> = ∅.

(vii) Lastly we show that there is no node that is common to r and q<sup>i</sup> for any i ∈ {1, . . . , m}. Suppose for a contradiction that there exists i ∈ {1, . . . , m} such that q<sup>i</sup> and r have a node in common and choose the smallest such i. By above, we have that Qi<sup>1</sup> is not on r, so let Qi<sup>l</sup> be the closest node to Qi<sup>1</sup> on q<sup>i</sup> that is on both r and q<sup>i</sup> , Qi<sup>l</sup> ≡ Rd, d ∈ {2, . . . , k0}. Consider path t = r(X, Qi<sup>l</sup> ) ⊕ (−q(Qi<sup>l</sup> , Qi<sup>1</sup> )) ⊕ p(Qi<sup>1</sup> , Y ). If t is of definite status, then t ∈ S<sup>3</sup> which contradicts our assumptions about S<sup>3</sup> = ∅. Otherwise, Rd−<sup>1</sup> − Qi<sup>l</sup> ← Qil−<sup>1</sup> is in GX\{X}<sup>X</sup> and by Lemma 57 also in the CPDAG C. Hence, by Lemma 17, Rd−<sup>1</sup> ← Qil−<sup>1</sup> . Furthermore, since r ∗ is a possibly causal path and r is an unshielded path X − · · · − Rd−<sup>1</sup> is in GX\{X}<sup>X</sup> . But this would then imply that X ← Qil−<sup>1</sup> by successive applications of Lemma 17. However, now we have that, ⟨X, Qil−<sup>1</sup> ⟩ ⊕ (−q(Qil−<sup>1</sup> , Qi<sup>1</sup> )) ⊕ p(Qi<sup>1</sup> , Y ) contradicts the choice of p.

# H A Note on Jaber's (2022) CIDP Algorithm

Despite the generality of PAGs, the CIDP algorithm of Jaber et al. (2022) does not hold in the general MPDAG setting. We demonstrate this in the example below, where the CIDP algorithm cannot identify an identifiable conditional effect given an MPDAG.

Example 15 Reconsider Example 3, where a causal MPDAG G is known. We will attempt to use a naive translation of Jaber et al.'s CIDP algorithm to identify the conditional effect of X on Y given Z in this setting. Start by defining D = PossAn(Y ∪ Z, GV\X) so that D = {V1, V2, V3, Y, Z}. Then define the ordered bucket decomposition (Definition 2) of V in G as (B1, B2, B3, B4) = ({V1}, {Y }, {X, V2, V3}, {Z}). Since B<sup>3</sup> ∩ D ̸= ∅ and B<sup>3</sup> ̸⊆ D, we enter the while loop of the CIDP algorithm. But B<sup>3</sup> ∩ {X} = {X}, where X ̸⊥<sup>d</sup> Y |Z in GX. Thus, the algorithm outputs a FAIL, implying the conditional effect is not identifiable in G. However, we showed in Example 3 that f(y | do(x), z) = f(y | z).

# References

- Bareinboim, E., Brito, C., and Pearl, J. (2012). Local characterizations of causal Bayesian networks. In Graph Structures for Knowledge Representation and Reasoning: Second International Workshop, pages 1–17.
- Chickering, D. M. (2002). Optimal structure identification with greedy search. Journal of Machine Learning Research, 3:507–554.
- Correa, J. and Bareinboim, E. (2020). A calculus for stochastic interventions: Causal effect identification and surrogate experiments. In The AAAI Conference on Artificial Intelligence, volume 34, pages 10093–10100.
- Fang, Z. and He, Y. (2020). IDA with background knowledge. In Uncertianty of Artifical Intelligence, pages 270–279.

- Guo, F. R. and Perkovi´c, E. (2021). Minimal enumeration of all possible total effects in a Markov equivalence class. In International Conference on Artificial Intelligence and Statistics.
- Henckel, L., Perkovi´c, E., and Maathuis, M. H. (2022). Graphical criteria for efficient total effect estimation via adjustment in causal linear models. Journal of the Royal Statistical Society: Series B, pages 579–599.
- Jaber, A., Ribeiro, A., Zhang, J., and Bareinboim, E. (2022). Causal identification under Markov equivalence: Calculus, algorithm, and completeness. In Advances in Neural Information Processing Systems, volume 35, pages 3679–3690.
- Jaber, A., Zhang, J., and Bareinboim, E. (2018). A graphical criterion for effect identification in equivalence classes of causal diagrams. In International Joint Conference on Artificial Intelligence.
- Kivva, Y., Etesami, J., and Kiyavash, N. (2023). On identifiability of conditional causal effects. In Uncertainty in Artificial Intelligence.
- LaPlante, S. and Perkovi´c, E. (2024). Conditional adjustment in a Markov equivalence class. In Artifical Intelligence and Statistics.
- Lauritzen, S. L., Dawid, A. P., Larsen, B. N., and Leimer, H.-G. (1990). Independence properties of directed Markov fields. Networks, 20(5):491–505.
- Maathuis, M. H. and Colombo, D. (2015). A generalized back-door criterion. Annals of Statistics.
- Maathuis, M. H., Colombo, D., Kalisch, M., and B¨uhlmann, P. (2010). Predicting causal effects in large-scale systems from observational data. Nature methods, 7(4):247–248.
- Maathuis, M. H., Kalisch, M., and B¨uhlmann, P. (2009). Estimating high-dimensional intervention effects from observational data. Annals of Statistics, 37:3133–3164.
- Mardia, K. V., Kent, J. T., and Bibby, J. M. (1980). Multivariate Analysis (Probability and Mathematical Statistics). Academic Press London.
- Meek, C. (1995). Causal inference and causal explanation with background knowledge. In Uncertianty of Artifical Intelligence, pages 403–410.
- Moffett, L., Weissman, A., McCormick, M., Weiland, C., Hsueh, J., Snow, C., and Sachs, J. (2023). Enrollment in pre-k and children's social-emotional and executive functioning skills: To what extent are associations sustained across time? Journal of Educational Psychology, 115(3):460.
- Nandy, P., Maathuis, M. H., and Richardson, T. S. (2017). Estimating the effect of joint interventions from observational data in sparse high-dimensional settings. Annals of Statistics, 45(2):647–674.
- Pearl, J. (1995). Causal diagrams for empirical research. Biometrika, 82:669–688.

Pearl, J. (2009). Causality: Models, Reasoning, and Inference. Cambridge University Press.

- Perkovi´c, E. (2020). Identifying causal effects in maximally oriented partially directed acyclic graphs. In Uncertianty of Artifical Intelligence, pages 530–539.
- Perkovi´c, E., Kalisch, M., and Maathuis, M. H. (2017). Interpreting and using CPDAGs with background knowledge. In Uncertianty of Artifical Intelligence.
- Perkovi´c, E., Textor, J., Kalisch, M., Maathuis, M. H., et al. (2018). Complete graphical characterization and construction of adjustment sets in markov equivalence classes of ancestral graphs. Journal of Machine Learning Research, 18(220):1–62.
- Rothenh¨ausler, D., Ernest, J., and B¨uhlmann, P. (2018). Causal inference in partially linear structural equation models: identifiability and estimation. Annals of Statistics, 46:2904–2938.
- Shpitser, I. and Pearl, J. (2006). Identification of conditional interventional distributions. In Uncertainty in Artificial Intelligence, pages 437–444.
- Shpitser, I., VanderWeele, T., and Robins, J. M. (2010). On the validity of covariate adjustment for estimating causal effects. In Uncertainty in Artificial Intelligence.
- Spirtes, P., Glymour, C., and Scheines, R. (2000). Causation, Prediction, and Search. MIT Press, second edition.
- Van der Zander, B., Liskiewicz, M., and Textor, J. (2014). Constructing separators and adjustment sets in ancestral graphs. In Uncertianty of Artifical Intelligence, pages 11–24.
- Venkateswaran, A. and Perkovi´c, E. (2024). Towards complete causal explanation with expert knowledge. arXiv preprint arXiv:2407.07338.
- Wright, S. (1921). Correlation and causation. Journal of Agricultural Research, 20(7):557– 585.
- Wright, S. (1934). The method of path coefficients. The Annals of Mathematical Statistics, 5(3):161–215.
- Zhang, J. (2006). Causal Inference and Reasoning in Causally Insufficient Systems. PhD thesis, Carnegie Mellon University.
- Zhang, J. (2008). Causal reasoning with ancestral graphs. Journal of Machine Learning Research, 9(7).